<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–•—É–∑–∞ –ò–ò</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<style>
:root {
  --bg: #0a0a0f;
  --s1: #111118;
  --s2: #1a1a26;
  --s3: #24243a;
  --b1: rgba(255,255,255,0.06);
  --b2: rgba(255,255,255,0.12);
  --t1: #f0f0ff;
  --t2: rgba(240,240,255,0.5);
  --t3: rgba(240,240,255,0.25);
  --ac: #5b6ef5;
  --ac2: #9b59b6;
  --gr: #34d399;
  --yw: #fbbf24;
  --rd: #f87171;
}
body.light {
  --bg: #f5f5fa;
  --s1: #ffffff;
  --s2: #eeeef8;
  --s3: #e0e0f0;
  --b1: rgba(0,0,0,0.06);
  --b2: rgba(0,0,0,0.12);
  --t1: #111130;
  --t2: rgba(17,17,48,0.55);
  --t3: rgba(17,17,48,0.3);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--t1);display:flex;flex-direction:column}

/* ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ */
.tabs{display:flex;background:var(--s1);border-bottom:1px solid var(--b1);flex-shrink:0}
.tab{flex:1;padding:12px 4px 10px;text-align:center;font-size:11px;font-weight:600;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;user-select:none}
.tab.active{color:var(--ac);border-bottom-color:var(--ac)}
.tab-icon{font-size:18px;display:block;margin-bottom:2px}

/* ‚îÄ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ‚îÄ */
.screen{flex:1;display:none;flex-direction:column;overflow:hidden}
.screen.active{display:flex}

/* ‚îÄ‚îÄ‚îÄ CHAT SCREEN ‚îÄ‚îÄ‚îÄ */
.chat-header{display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--s1);border-bottom:1px solid var(--b1);flex-shrink:0}
.model-btn{display:flex;align-items:center;gap:8px;background:var(--s2);border:1px solid var(--b2);border-radius:20px;padding:7px 12px 7px 8px;cursor:pointer;flex:1;min-width:0;transition:opacity .15s;user-select:none}
.model-btn:active{opacity:.7}
.model-ico{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.model-name{font-size:14px;font-weight:700;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.model-sub{font-size:10px;color:var(--t3);margin-top:1px}
.hdr-btn{width:36px;height:36px;background:var(--s2);border:1px solid var(--b1);border-radius:11px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;flex-shrink:0;transition:opacity .15s;user-select:none}
.hdr-btn:active{opacity:.6}

.mode-bar{display:flex;gap:6px;padding:8px 14px;overflow-x:auto;scrollbar-width:none;flex-shrink:0;background:var(--s1);border-bottom:1px solid var(--b1)}
.mode-bar::-webkit-scrollbar{display:none}
.mode-chip{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600;background:var(--s2);border:1px solid var(--b1);color:var(--t2);cursor:pointer;white-space:nowrap;transition:all .15s;user-select:none}
.mode-chip:active{opacity:.7}
.mode-chip.on{background:var(--ac);border-color:var(--ac);color:#fff}
.auto-chip{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:600;background:var(--s2);border:1px solid var(--b1);color:var(--t2);cursor:pointer;white-space:nowrap;transition:all .15s;user-select:none}
.auto-chip:active{opacity:.7}
.auto-chip.on{background:linear-gradient(135deg,#5b6ef5,#9b59b6);border-color:transparent;color:#fff}

.chat-msgs{flex:1;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:10px;scrollbar-width:thin;scrollbar-color:var(--s3) transparent}
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:24px;gap:12px}
.empty-ico{font-size:48px}
.empty-title{font-size:18px;font-weight:800}
.empty-sub{font-size:13px;color:var(--t2);line-height:1.5}
.chips{display:flex;flex-direction:column;gap:6px;width:100%;margin-top:6px}
.chip{background:var(--s2);border:1px solid var(--b2);border-radius:12px;padding:10px 14px;font-size:13px;cursor:pointer;text-align:left;transition:opacity .15s;user-select:none}
.chip:active{opacity:.7}

.msg{display:flex;flex-direction:column;gap:3px}
.msg.user{align-items:flex-end}
.msg.ai{align-items:flex-start}
.bubble{max-width:85%;padding:10px 14px;border-radius:16px;font-size:14px;line-height:1.55;word-break:break-word}
.msg.user .bubble{background:var(--ac);color:#fff;border-bottom-right-radius:4px}
.msg.ai .bubble{background:var(--s1);border:1px solid var(--b2);color:var(--t1);border-bottom-left-radius:4px}
.msg-meta{font-size:10px;color:var(--t3);padding:0 4px}
.copy-btn2{margin-top:4px;font-size:11px;color:var(--t3);cursor:pointer;padding:2px 8px;background:var(--s2);border:1px solid var(--b1);border-radius:8px;display:inline-block;user-select:none}
.copy-btn2:active{opacity:.7}
pre{background:var(--s3)!important;border-radius:10px;padding:12px;overflow-x:auto;margin:6px 0;font-size:12px}
code{font-family:monospace;font-size:13px}
p code{background:var(--s3);padding:1px 5px;border-radius:4px}

.think-bubble{background:var(--s2);border:1px solid var(--b1);border-radius:14px;padding:10px 14px;font-size:13px;color:var(--t2);display:flex;align-items:center;gap:8px;max-width:85%}
.dots span{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--t3);animation:blink 1.2s infinite}
.dots span:nth-child(2){animation-delay:.2s}
.dots span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}

.limit-bar{display:flex;gap:12px;align-items:center;padding:5px 14px;background:var(--s1);font-size:11px;color:var(--t2);border-top:1px solid var(--b1);flex-shrink:0}
.lim-dot{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:3px}

.input-area{background:var(--s1);border-top:1px solid var(--b1);padding:8px 12px;flex-shrink:0}
.img-previews{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap}
.img-prev-wrap{position:relative}
.img-prev{width:56px;height:56px;border-radius:10px;object-fit:cover}
.img-prev-rm{position:absolute;top:-4px;right:-4px;width:18px;height:18px;background:#f87171;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;cursor:pointer;font-weight:700}
.input-row{display:flex;gap:8px;align-items:flex-end}
.attach-btn{width:38px;height:38px;background:var(--s2);border:1px solid var(--b1);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;flex-shrink:0;transition:opacity .15s;user-select:none}
.attach-btn:active{opacity:.7}
textarea.inp{flex:1;background:var(--s2);border:1px solid var(--b2);border-radius:14px;padding:9px 12px;color:var(--t1);font-family:inherit;font-size:14px;resize:none;outline:none;max-height:120px;min-height:38px;line-height:1.4;transition:border-color .2s}
textarea.inp:focus{border-color:var(--ac)}
textarea.inp::placeholder{color:var(--t3)}
.send-btn{width:38px;height:38px;background:var(--ac);border:none;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;transition:opacity .2s;font-size:18px;color:#fff;user-select:none}
.send-btn:disabled{opacity:.35;cursor:default}
.send-btn:not(:disabled):active{opacity:.75}

/* ‚îÄ‚îÄ‚îÄ IMAGE GEN SCREEN ‚îÄ‚îÄ‚îÄ */
.imggen-wrap{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px;scrollbar-width:thin;scrollbar-color:var(--s3) transparent}
.section-title{font-size:12px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px}
.img-model-grid{display:flex;flex-direction:column;gap:6px}
.img-model-item{display:flex;align-items:center;gap:10px;padding:11px 13px;background:var(--s2);border:1px solid var(--b1);border-radius:13px;cursor:pointer;transition:all .15s;user-select:none}
.img-model-item:active{opacity:.7}
.img-model-item.on{background:rgba(91,110,245,.15);border-color:rgba(91,110,245,.5)}
.img-model-ico{font-size:20px;flex-shrink:0}
.img-model-info{flex:1}
.img-model-name{font-size:13px;font-weight:700}
.img-model-desc{font-size:11px;color:var(--t2);margin-top:1px}
.img-model-check{color:var(--ac);font-size:18px;font-weight:700;flex-shrink:0;opacity:0;transition:opacity .2s}
.img-model-item.on .img-model-check{opacity:1}

.prompt-suggs{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.sugg-tag{padding:5px 11px;border-radius:20px;font-size:12px;background:var(--s2);border:1px solid var(--b1);color:var(--t2);cursor:pointer;user-select:none}
.sugg-tag:active{opacity:.7}
textarea.prompt-inp{width:100%;background:var(--s2);border:1px solid var(--b2);border-radius:13px;padding:11px 13px;color:var(--t1);font-family:inherit;font-size:14px;resize:none;outline:none;min-height:80px;line-height:1.5;transition:border-color .2s}
textarea.prompt-inp:focus{border-color:var(--ac)}
textarea.prompt-inp::placeholder{color:var(--t3)}

.gen-btn{width:100%;padding:14px;background:linear-gradient(135deg,#5b6ef5,#9b59b6);color:#fff;border:none;border-radius:14px;font-size:16px;font-weight:700;font-family:inherit;cursor:pointer;transition:opacity .2s;user-select:none}
.gen-btn:active{opacity:.8}
.gen-btn:disabled{opacity:.4;cursor:default}

.gen-result{display:none;flex-direction:column;gap:10px}
.gen-result.show{display:flex}
.gen-img{width:100%;border-radius:16px;display:block}
.gen-actions{display:flex;gap:8px}
.gen-act-btn{flex:1;padding:11px;border-radius:12px;font-size:13px;font-weight:600;font-family:inherit;cursor:pointer;border:none;transition:opacity .2s;user-select:none}
.gen-act-btn:active{opacity:.7}
.gen-loading{display:none;text-align:center;padding:32px 16px;flex-direction:column;gap:10px;align-items:center}
.gen-loading.show{display:flex}
.gen-loading-ico{font-size:36px;animation:spin 2s linear infinite}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.gen-limit-info{text-align:center;font-size:12px;color:var(--t3)}

/* ‚îÄ‚îÄ‚îÄ PROFILE SCREEN ‚îÄ‚îÄ‚îÄ */
.profile-wrap{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;scrollbar-width:thin;scrollbar-color:var(--s3) transparent}
.p-card{background:var(--s1);border:1px solid var(--b1);border-radius:16px;padding:14px}
.p-card-title{font-size:11px;font-weight:700;color:var(--t3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:12px}
.level-badge{font-size:22px;font-weight:800;color:var(--t1)}
.level-bar{height:5px;background:var(--s3);border-radius:3px;margin-top:8px;overflow:hidden}
.level-fill{height:100%;background:linear-gradient(90deg,var(--ac),var(--ac2));border-radius:3px;transition:width .6s}
.level-hint{font-size:11px;color:var(--t3);margin-top:5px}
.stat-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.stat-cell{background:var(--s2);border-radius:12px;padding:10px 6px;text-align:center}
.stat-val{font-size:22px;font-weight:800}
.stat-lbl{font-size:10px;color:var(--t3);margin-top:2px}
.lim-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--b1);font-size:13px}
.lim-row:last-child{border:none}
.lim-val{font-weight:700;font-size:15px}
.mode-grid{display:flex;flex-wrap:wrap;gap:6px}
.mode-item{padding:8px 14px;border-radius:12px;font-size:13px;font-weight:600;background:var(--s2);border:1px solid var(--b1);color:var(--t2);cursor:pointer;transition:all .15s;user-select:none}
.mode-item:active{opacity:.7}
.mode-item.on{background:var(--ac);border-color:var(--ac);color:#fff}
.theme-row{display:flex;gap:6px}
.theme-item{flex:1;padding:10px;border-radius:12px;text-align:center;font-size:13px;font-weight:600;background:var(--s2);border:1px solid var(--b1);color:var(--t2);cursor:pointer;transition:all .15s;user-select:none}
.theme-item:active{opacity:.7}
.theme-item.on{background:var(--s1);border-color:var(--b2);color:var(--t1);box-shadow:0 1px 6px rgba(0,0,0,.15)}

/* ‚îÄ‚îÄ‚îÄ MODEL SHEET ‚îÄ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;opacity:0;pointer-events:none;transition:opacity .25s}
.overlay.show{opacity:1;pointer-events:all}
.bottom-sheet{position:fixed;bottom:0;left:0;right:0;background:var(--s1);border-radius:20px 20px 0 0;z-index:101;max-height:85dvh;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .3s cubic-bezier(.32,.72,0,1)}
.bottom-sheet.show{transform:translateY(0)}
.sheet-handle{width:36px;height:4px;background:var(--b2);border-radius:2px;margin:10px auto 0;flex-shrink:0}
.sheet-hdr{padding:12px 16px 8px;flex-shrink:0}
.sheet-hdr-title{font-size:17px;font-weight:800}
.sheet-hdr-sub{font-size:12px;color:var(--t2);margin-top:2px}
.sheet-search{padding:0 16px 8px;flex-shrink:0;position:relative}
.sheet-search input{width:100%;background:var(--s2);border:1px solid var(--b1);border-radius:12px;padding:9px 14px 9px 36px;color:var(--t1);font-family:inherit;font-size:14px;outline:none}
.sheet-search input::placeholder{color:var(--t3)}
.sheet-search-ico{position:absolute;left:28px;top:50%;transform:translateY(-50%);color:var(--t3);pointer-events:none}
.sheet-cats{display:flex;gap:6px;padding:0 16px 8px;overflow-x:auto;scrollbar-width:none;flex-shrink:0}
.sheet-cats::-webkit-scrollbar{display:none}
.cat-pill{padding:5px 13px;border-radius:20px;font-size:12px;font-weight:600;background:var(--s2);border:1px solid var(--b1);color:var(--t2);cursor:pointer;white-space:nowrap;transition:all .15s;user-select:none;flex-shrink:0}
.cat-pill:active{opacity:.7}
.cat-pill.on{background:var(--ac);border-color:var(--ac);color:#fff}
.sheet-list{overflow-y:auto;flex:1;padding-bottom:16px}
.model-row{display:flex;align-items:center;gap:12px;padding:11px 16px;cursor:pointer;border-bottom:1px solid var(--b1);transition:background .12s;position:relative;user-select:none}
.model-row:active{background:rgba(255,255,255,.03)}
.model-row.on{background:rgba(91,110,245,.1)}
.model-row.on::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--ac);border-radius:0 2px 2px 0}
.row-ico{width:44px;height:44px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.row-info{flex:1;min-width:0}
.row-name{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.row-desc{font-size:12px;color:var(--t2);margin-top:2px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.row-check{color:var(--ac);font-size:18px;font-weight:700;flex-shrink:0;opacity:0;transition:opacity .2s}
.model-row.on .row-check{opacity:1}
.vision-tag{font-size:9px;font-weight:700;background:rgba(251,191,36,.15);color:var(--yw);border:1px solid rgba(251,191,36,.3);padding:2px 6px;border-radius:5px;margin-left:4px}
.sec-label{padding:10px 16px 4px;font-size:10px;font-weight:700;color:var(--t3);letter-spacing:1px;text-transform:uppercase}

/* ‚îÄ‚îÄ‚îÄ HISTORY PANEL ‚îÄ‚îÄ‚îÄ */
.history-panel{position:fixed;bottom:0;left:0;right:0;background:var(--s1);border-radius:20px 20px 0 0;z-index:101;max-height:80dvh;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .3s cubic-bezier(.32,.72,0,1)}
.history-panel.show{transform:translateY(0)}
.hist-hdr{display:flex;align-items:center;justify-content:space-between;padding:16px 16px 10px;flex-shrink:0}
.hist-title{font-size:17px;font-weight:800}
.hist-actions{display:flex;gap:6px}
.hist-btn{padding:6px 12px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;border:none;font-family:inherit;user-select:none}
.hist-close-btn{width:32px;height:32px;background:var(--s2);border:1px solid var(--b1);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;user-select:none}
.hist-close-btn:active{opacity:.7}
.hist-list{overflow-y:auto;flex:1;padding:0 12px 16px}
.hist-item{background:var(--s2);border:1px solid var(--b1);border-radius:13px;padding:12px 14px;margin-bottom:8px;cursor:pointer;transition:opacity .15s;user-select:none}
.hist-item:active{opacity:.7}
.hist-item.cur{border-color:var(--ac);background:rgba(91,110,245,.1)}
.hist-item-title{font-size:14px;font-weight:700;margin-bottom:3px}
.hist-item-prev{font-size:12px;color:var(--t2);margin-bottom:5px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.hist-item-meta{display:flex;gap:8px;font-size:11px;color:var(--t3);flex-wrap:wrap}
.hist-empty{text-align:center;padding:40px 16px;color:var(--t2);font-size:14px}
.hist-clear{width:calc(100% - 24px);margin:0 12px 8px;padding:11px;background:var(--s2);border:1px solid var(--b1);border-radius:12px;color:var(--rd);font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;user-select:none}
.hist-clear:active{opacity:.7}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--t1);color:var(--bg);padding:9px 18px;border-radius:20px;font-size:13px;font-weight:600;z-index:999;opacity:0;transition:all .25s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* AVATAR COLORS */
.av-claude{background:linear-gradient(135deg,#d4845a,#c9512f)}
.av-gpt{background:linear-gradient(135deg,#10a37f,#0a7a5f)}
.av-deepseek{background:linear-gradient(135deg,#4e6ef2,#2a42c4)}
.av-qwen{background:linear-gradient(135deg,#ff6a00,#ee0979)}
.av-command{background:linear-gradient(135deg,#6b7280,#374151)}
.av-kimi{background:linear-gradient(135deg,#ec4899,#be185d)}
.av-glm{background:linear-gradient(135deg,#a78bfa,#7c3aed)}
.av-c4ai{background:linear-gradient(135deg,#06b6d4,#0891b2)}
.av-sonar{background:linear-gradient(135deg,#f97316,#ea580c)}
.av-llama{background:linear-gradient(135deg,#f59e0b,#d97706)}
</style>
</head>
<body>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" id="tab-chat" onclick="switchTab('chat')">
    <span class="tab-icon">üí¨</span>–ß–∞—Ç
  </div>
  <div class="tab" id="tab-img" onclick="switchTab('img')">
    <span class="tab-icon">üé®</span>–ö–∞—Ä—Ç–∏–Ω–∫–∏
  </div>
  <div class="tab" id="tab-profile" onclick="switchTab('profile')">
    <span class="tab-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CHAT SCREEN ‚ïê‚ïê‚ïê -->
<div class="screen active" id="screen-chat">
  <!-- Header -->
  <div class="chat-header">
    <div class="model-btn" id="btnModelSel">
      <div class="model-ico av-claude" id="hdrIco">üî∑</div>
      <div style="flex:1;min-width:0">
        <div class="model-name" id="hdrName">Claude Sonnet 4.5</div>
        <div class="model-sub" id="hdrSub">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å</div>
      </div>
      <span style="color:var(--t3);font-size:11px">‚ñº</span>
    </div>
    <div class="hdr-btn" id="btnHistory" title="–ò—Å—Ç–æ—Ä–∏—è">üïê</div>
    <div class="hdr-btn" id="btnNewChat" title="–ù–æ–≤—ã–π —á–∞—Ç">‚úèÔ∏è</div>
    <div class="hdr-btn" id="btnClear" title="–û—á–∏—Å—Ç–∏—Ç—å">üóë</div>
  </div>

  <!-- Mode bar -->
  <div class="mode-bar">
    <div class="mode-chip on" id="mode-fast" onclick="setMode('fast')">‚ö°Ô∏è –ë—ã—Å—Ç—Ä–æ</div>
    <div class="mode-chip" id="mode-simple" onclick="setMode('simple')">üéì –ü—Ä–æ—Å—Ç–æ</div>
    <div class="mode-chip" id="mode-dev" onclick="setMode('dev')">üíª –ö–æ–¥</div>
    <div class="mode-chip" id="mode-deep" onclick="setMode('deep')">üß† –ì–ª—É–±–æ–∫–æ</div>
    <div class="auto-chip" id="chipAuto" onclick="toggleAuto()">ü§ñ –ê–≤—Ç–æ</div>
  </div>

  <!-- Messages -->
  <div class="chat-msgs" id="chatMsgs">
    <div class="empty" id="emptyState">
      <div class="empty-ico">ü§ñ</div>
      <div class="empty-title">–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
      <div class="empty-sub">–í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å –∏ –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å</div>
      <div class="chips">
        <div class="chip" onclick="fillInput(this)">–û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ —á—Ç–æ —Ç–∞–∫–æ–µ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</div>
        <div class="chip" onclick="fillInput(this)">–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python: —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—É–∑—ã—Ä—å–∫–æ–º</div>
        <div class="chip" onclick="fillInput(this)">–ü–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π: –ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?</div>
        <div class="chip" onclick="fillInput(this)">–ü—Ä–∏–¥—É–º–∞–π 5 –∏–¥–µ–π –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –≤ 2025 –≥–æ–¥—É</div>
      </div>
    </div>
  </div>

  <!-- Limits -->
  <div class="limit-bar" id="limitBar" style="display:none">
    <span>üìä</span>
    <span><span class="lim-dot" style="background:var(--gr)"></span><span id="fastLeft">‚Äî</span> –±—ã—Å—Ç—Ä—ã—Ö</span>
    <span><span class="lim-dot" style="background:var(--ac)"></span><span id="proLeft">‚Äî</span> –ø—Ä–æ—Ñ.</span>
  </div>

  <!-- Input -->
  <div class="input-area">
    <div class="img-previews" id="imgPreviews" style="display:none"></div>
    <div class="input-row">
      <div class="attach-btn" id="btnAttach">üìé</div>
      <textarea class="inp" id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
      <button class="send-btn" id="btnSend" disabled>‚Üë</button>
    </div>
  </div>
  <input type="file" id="fileInput" accept="image/*" multiple style="display:none">
</div>

<!-- ‚ïê‚ïê‚ïê IMAGE GEN SCREEN ‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-img">
  <div class="imggen-wrap">
    <div>
      <div class="section-title">–ú–æ–¥–µ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
      <div class="img-model-grid" id="imgModelGrid"></div>
    </div>
    <div>
      <div class="section-title">–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏</div>
      <textarea class="prompt-inp" id="imgPrompt" placeholder="–û–ø–∏—à–∏ —á—Ç–æ —Ö–æ—á–µ—à—å —É–≤–∏–¥–µ—Ç—å... (–ª—É—á—à–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º)"></textarea>
      <div class="prompt-suggs">
        <div class="sugg-tag" onclick="setSugg('beautiful mountain sunset, ultra realistic, 8k photography')">üåÑ –ó–∞–∫–∞—Ç</div>
        <div class="sugg-tag" onclick="setSugg('futuristic cyberpunk city at night, neon lights, rain')">üåÜ –ö–∏–±–µ—Ä–ø–∞–Ω–∫</div>
        <div class="sugg-tag" onclick="setSugg('cute anime girl, studio ghibli style, detailed illustration')">üéå –ê–Ω–∏–º–µ</div>
        <div class="sugg-tag" onclick="setSugg('professional portrait, studio lighting, sharp focus, 4k')">üì∏ –ü–æ—Ä—Ç—Ä–µ—Ç</div>
        <div class="sugg-tag" onclick="setSugg('abstract digital art, colorful geometric shapes, modern')">üé® –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è</div>
        <div class="sugg-tag" onclick="setSugg('cozy coffee shop interior, warm lighting, bokeh background')">‚òï –£—é—Ç</div>
      </div>
    </div>
    <button class="gen-btn" id="btnGenerate">üé® –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É</button>
    <div class="gen-loading" id="genLoading">
      <div class="gen-loading-ico">‚ú®</div>
      <div style="font-size:15px;font-weight:700">–°–æ–∑–¥–∞—é –∫–∞—Ä—Ç–∏–Ω–∫—É...</div>
      <div style="font-size:12px;color:var(--t2)">–û–±—ã—á–Ω–æ 10‚Äì30 —Å–µ–∫—É–Ω–¥</div>
    </div>
    <div class="gen-result" id="genResult">
      <img class="gen-img" id="genImg" src="" alt="">
      <div class="gen-actions">
        <button class="gen-act-btn" id="btnDownload" style="background:var(--s2);color:var(--t1)">üíæ –°–∫–∞—á–∞—Ç—å</button>
        <button class="gen-act-btn" id="btnSendToChat" style="background:var(--ac);color:#fff">üí¨ –í —á–∞—Ç</button>
      </div>
    </div>
    <div class="gen-limit-info" id="genLimitInfo"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PROFILE SCREEN ‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-profile">
  <div class="profile-wrap" id="profileWrap">
    <div style="text-align:center;padding:40px;color:var(--t2)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>
</div>

<!-- OVERLAYS -->
<div class="overlay" id="overlaySheet"></div>
<div class="bottom-sheet" id="modelSheet">
  <div class="sheet-handle"></div>
  <div class="sheet-hdr">
    <div class="sheet-hdr-title">–í—ã–±–æ—Ä –Ω–µ–π—Ä–æ—Å–µ—Ç–∏</div>
    <div class="sheet-hdr-sub">–ù–∞–∂–º–∏ –Ω–∞ –º–æ–¥–µ–ª—å —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å</div>
  </div>
  <div class="sheet-search">
    <svg class="sheet-search-ico" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" id="sheetSearch" placeholder="–ü–æ–∏—Å–∫ –º–æ–¥–µ–ª–∏...">
  </div>
  <div class="sheet-cats" id="sheetCats"></div>
  <div class="sheet-list" id="sheetList"></div>
</div>

<div class="overlay" id="overlayHist"></div>
<div class="history-panel" id="histPanel">
  <div class="sheet-handle"></div>
  <div class="hist-hdr">
    <div class="hist-title">üìã –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</div>
    <div class="hist-actions">
      <button class="hist-btn" id="btnHistNewChat" style="background:var(--ac);color:#fff">+ –ù–æ–≤—ã–π</button>
      <div class="hist-close-btn" id="btnHistClose">‚úï</div>
    </div>
  </div>
  <div class="hist-list" id="histList"></div>
  <button class="hist-clear" id="btnHistClear">üóë –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const P = new URLSearchParams(location.search);
const API_BASE = P.get('api') || window.location.origin || '';
// DEBUG: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
console.log('API_BASE:', API_BASE, '| USER_ID:', USER_ID, '| URL:', location.href);
let USER_ID = 0;
try {
  if (tg.initDataUnsafe?.user?.id) USER_ID = tg.initDataUnsafe.user.id;
  if (!USER_ID && tg.initData) {
    const u = new URLSearchParams(tg.initData).get('user');
    if (u) USER_ID = JSON.parse(decodeURIComponent(u)).id || 0;
  }
  if (!USER_ID) USER_ID = parseInt(P.get('uid') || '0');
} catch(e) {}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MODELS = [
  {key:'claude_sonnet', name:'Claude Sonnet 4.5', av:'av-claude', emoji:'üî∑', cat:'Claude', desc:'–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏ —É–º–Ω–∞—è –º–æ–¥–µ–ª—å –æ—Ç Anthropic', vision:true},
  {key:'claude_haiku',  name:'Claude Haiku 4.5',  av:'av-claude', emoji:'üíé', cat:'Claude', desc:'–°–∞–º–∞—è –±—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è Claude', vision:true},
  {key:'claude_opus',   name:'Claude Opus 4.5',   av:'av-claude', emoji:'üîµ', cat:'Claude', desc:'–¢–æ–ø–æ–≤–∞—è –º–æ–¥–µ–ª—å ‚Äî –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á', vision:true},
  {key:'gpt52',         name:'GPT-5.2',            av:'av-gpt',    emoji:'‚ö°', cat:'GPT',    desc:'–ù–æ–≤–µ–π—à–∞—è —Ñ–ª–∞–≥–º–∞–Ω—Å–∫–∞—è –º–æ–¥–µ–ª—å –æ—Ç OpenAI', vision:true},
  {key:'gpt52_chat',    name:'GPT-5.2 Chat',       av:'av-gpt',    emoji:'üí¨', cat:'GPT',    desc:'GPT-5.2 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤'},
  {key:'deepseek_v3',   name:'DeepSeek V3.2',      av:'av-deepseek',emoji:'üß¨',cat:'DeepSeek',desc:'–¢–æ–ø–æ–≤–∞—è –∫–∏—Ç–∞–π—Å–∫–∞—è –º–æ–¥–µ–ª—å ‚Äî –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç GPT-4'},
  {key:'deepseek_r1',   name:'DeepSeek R1',        av:'av-deepseek',emoji:'üß†',cat:'DeepSeek',desc:'Reasoning-–º–æ–¥–µ–ª—å —Å —Ü–µ–ø–æ—á–∫–æ–π —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π'},
  {key:'deepseek_v3_sq',name:'DeepSeek V3',        av:'av-deepseek',emoji:'üß¨',cat:'DeepSeek',desc:'–°—Ç–∞–±–∏–ª—å–Ω–∞—è –±—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è DeepSeek V3'},
  {key:'qwen3_max',     name:'Qwen3-Max',           av:'av-qwen',   emoji:'üåê', cat:'Qwen',   desc:'–§–ª–∞–≥–º–∞–Ω Alibaba ‚Äî –º–æ—â–Ω–∞—è –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –º–æ–¥–µ–ª—å'},
  {key:'qwen3_vl',      name:'Qwen3-VL',            av:'av-qwen',   emoji:'üëÅÔ∏è', cat:'Qwen',   desc:'Vision ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —Ñ–æ—Ç–æ', vision:true},
  {key:'qwen_vision',   name:'Qwen2.5-VL 32B',     av:'av-qwen',   emoji:'üñºÔ∏è', cat:'Qwen',   desc:'–ú–æ—â–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ 32B –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤', vision:true},
  {key:'llama32_90b',   name:'Llama 3.2 90B',      av:'av-llama',  emoji:'ü¶ô', cat:'Llama',  desc:'Open-source –≥–∏–≥–∞–Ω—Ç Meta ‚Äî 90B –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤', vision:true},
  {key:'command_a',     name:'Command-A',           av:'av-command',emoji:'‚öôÔ∏è', cat:'Command',desc:'–ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å –æ—Ç Cohere ‚Äî —Ç–æ—á–Ω–∞—è –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è'},
  {key:'command_vision',name:'Command Vision',     av:'av-command',emoji:'üëÅÔ∏è', cat:'Command',desc:'Command —Å –∞–Ω–∞–ª–∏–∑–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π', vision:true},
  {key:'command_reason',name:'Command Reasoning', av:'av-command',emoji:'üß©', cat:'Command',desc:'–£–≥–ª—É–±–ª—ë–Ω–Ω–æ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ'},
  {key:'moonshot',      name:'Kimi K2',             av:'av-kimi',   emoji:'üåô', cat:'Kimi',   desc:'–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ –æ—Ç Moonshot AI'},
  {key:'glm47',         name:'GLM-4.7',             av:'av-glm',    emoji:'üîÆ', cat:'GLM',    desc:'–ù–æ–≤–µ–π—à–∏–π GLM –æ—Ç Zhipu AI'},
  {key:'c4ai_32b',      name:'C4AI Aya 32B',        av:'av-c4ai',   emoji:'üåÄ', cat:'C4AI',   desc:'–ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –º–æ–¥–µ–ª—å 32B ‚Äî 23 —è–∑—ã–∫–∞'},
  {key:'c4ai_8b',       name:'C4AI Aya 8B',         av:'av-c4ai',   emoji:'üåÄ', cat:'C4AI',   desc:'–õ—ë–≥–∫–∞—è –±—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è Aya'},
  {key:'sonar',         name:'Sonar',               av:'av-sonar',  emoji:'üîç', cat:'Sonar',  desc:'Perplexity Sonar ‚Äî –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ + –ò–ò'},
  {key:'sonar_pro',     name:'Sonar Pro',           av:'av-sonar',  emoji:'üîç', cat:'Sonar',  desc:'–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å –≥–ª—É–±–æ–∫–∏–º –∞–Ω–∞–ª–∏–∑–æ–º'},
];
const CATS = ['–í—Å–µ','Claude','GPT','DeepSeek','Qwen','Llama','Command','Kimi','GLM','C4AI','Sonar'];

const IMG_MODELS = [
  {key:'flux2',      name:'Flux 2 Dev',      emoji:'‚ö°', desc:'–§–æ—Ç–æ—Ä–µ–∞–ª–∏–∑–º ‚Äî –ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ'},
  {key:'phoenix',    name:'Phoenix 1.0',      emoji:'ü¶Ö', desc:'–ö–∏–Ω–æ-—Å—Ç–∏–ª—å –∏ –ø–æ—Ä—Ç—Ä–µ—Ç—ã'},
  {key:'lucid',      name:'Lucid Origin',     emoji:'üé≠', desc:'–î–µ—Ç–∞–ª—å–Ω—ã–π —Ö—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å'},
  {key:'gptimg15',   name:'GPT-Image 1.5',    emoji:'üñåÔ∏è', desc:'–õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç OpenAI'},
  {key:'gptimg1',    name:'GPT-Image 1',      emoji:'üñºÔ∏è', desc:'–°—Ç–∞–Ω–¥–∞—Ä—Ç OpenAI'},
  {key:'gptimg_mini',name:'GPT-Image Mini',   emoji:'üîπ', desc:'–ë—ã—Å—Ç—Ä–∞—è –ª—ë–≥–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è'},
  {key:'flux_std',   name:'Flux Standard',    emoji:'üåä', desc:'–ë—ã—Å—Ç—Ä–∞—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è'},
];

const MODES = {fast:'‚ö°Ô∏è –ë—ã—Å—Ç—Ä–æ', simple:'üéì –ü—Ä–æ—Å—Ç–æ', dev:'üíª –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', deep:'üß† –ì–ª—É–±–æ–∫–æ'};
const LEVELS = [[0,'üå± –ù–æ–≤–∏—á–æ–∫'],[10,'‚≠ê –ù–∞—á–∏–Ω–∞—é—â–∏–π'],[50,'üî• –ê–∫—Ç–∏–≤–Ω—ã–π'],[150,'üíé –û–ø—ã—Ç–Ω—ã–π'],[500,'üèÜ –≠–∫—Å–ø–µ—Ä—Ç'],[1000,'üëë –ú–∞—Å—Ç–µ—Ä']];
const HIST_KEY = 'huzaai_hist';
const HIST_TTL = 24*60*60*1000;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let curModel   = P.get('model') || localStorage.getItem('huzaai_model') || 'claude_sonnet';
let curMode    = localStorage.getItem('huzaai_mode') || 'fast';
let autoModel  = localStorage.getItem('huzaai_auto') === 'true';
let curTheme   = localStorage.getItem('huzaai_theme') || 'dark';
let curTab     = 'chat';
let messages   = [];
let pendingImgs = [];
let isLoading  = false;
let sheetOpen  = false;
let histOpen   = false;
let catFilter  = '–í—Å–µ';
let searchQ    = '';
let sessId     = newId();
let curImgModel = 'flux2';
let lastImgB64  = null;
let userStats   = {requests:0,generations:0,joined:'',fast_left:0,pro_left:0,img_left:0};

function newId() { return Date.now().toString(36)+Math.random().toString(36).slice(2,6); }
function getModel(key) { return MODELS.find(m=>m.key===key)||MODELS[0]; }
function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function now() { const d=new Date(); return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// THEME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyTheme(t) {
  curTheme = t;
  document.body.classList.toggle('light', t==='light');
  localStorage.setItem('huzaai_theme', t);
}
applyTheme(curTheme);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(tab) {
  curTab = tab;
  document.querySelectorAll('.tab').forEach(el => el.classList.toggle('active', el.id==='tab-'+tab));
  document.querySelectorAll('.screen').forEach(el => el.classList.toggle('active', el.id==='screen-'+tab));
  if (tab === 'profile') renderProfile();
  if (tab === 'img') renderImgModels();
  if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAT HEADER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHeader() {
  const m = getModel(curModel);
  const ico = document.getElementById('hdrIco');
  ico.className = 'model-ico ' + m.av;
  ico.textContent = m.emoji;
  document.getElementById('hdrName').textContent = m.name;
  document.getElementById('hdrSub').textContent = m.vision ? 'üì∏ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ç–æ' : '–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å';
}
updateHeader();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMode(mode) {
  curMode = mode;
  localStorage.setItem('huzaai_mode', mode);
  Object.keys(MODES).forEach(k => {
    const el = document.getElementById('mode-'+k);
    if (el) el.classList.toggle('on', k===mode);
  });
  toast('üéõ '+MODES[mode]);
  if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
}
setMode(curMode);

function toggleAuto() {
  autoModel = !autoModel;
  localStorage.setItem('huzaai_auto', autoModel);
  document.getElementById('chipAuto').classList.toggle('on', autoModel);
  toast(autoModel ? 'ü§ñ –ê–≤—Ç–æ-—Ä–µ–∂–∏–º –≤–∫–ª—é—á—ë–Ω' : 'ü§ñ –ê–≤—Ç–æ-—Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω');
  if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
}
if (autoModel) document.getElementById('chipAuto').classList.add('on');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODEL SHEET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSheet() {
  sheetOpen = true;
  document.getElementById('overlaySheet').classList.add('show');
  document.getElementById('modelSheet').classList.add('show');
  document.getElementById('sheetSearch').value = '';
  searchQ = ''; catFilter = '–í—Å–µ';
  renderCats(); renderSheetModels();
  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
}
function closeSheet() {
  sheetOpen = false;
  document.getElementById('overlaySheet').classList.remove('show');
  document.getElementById('modelSheet').classList.remove('show');
}
function setCat(c) {
  catFilter = c;
  renderCats(); renderSheetModels();
}
function renderCats() {
  document.getElementById('sheetCats').innerHTML = CATS.map(c =>
    `<div class="cat-pill${c===catFilter?' on':''}" onclick="setCat('${c}')">${c}</div>`
  ).join('');
}
function renderSheetModels() {
  const list = document.getElementById('sheetList');
  const q = searchQ.toLowerCase();
  const filtered = MODELS.filter(m => {
    const mc = catFilter==='–í—Å–µ' || m.cat===catFilter;
    const ms = !q || m.name.toLowerCase().includes(q) || m.cat.toLowerCase().includes(q);
    return mc && ms;
  });
  if (!filtered.length) { list.innerHTML='<div class="hist-empty">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
  
  let html = '';
  let lastCat = null;
  filtered.forEach(m => {
    if (catFilter==='–í—Å–µ' && !q && m.cat!==lastCat) {
      html += `<div class="sec-label">${m.cat}</div>`;
      lastCat = m.cat;
    }
    const sel = m.key===curModel;
    html += `<div class="model-row${sel?' on':''}" onclick="selectModel('${m.key}')">
      <div class="row-ico ${m.av}">${m.emoji}</div>
      <div class="row-info">
        <div class="row-name">${m.name}${m.vision?'<span class="vision-tag">VISION</span>':''}</div>
        <div class="row-desc">${m.desc}</div>
      </div>
      <div class="row-check">‚úì</div>
    </div>`;
  });
  list.innerHTML = html;
}
function selectModel(key) {
  curModel = key;
  localStorage.setItem('huzaai_model', key);
  updateHeader();
  closeSheet();
  toast('‚úÖ '+getModel(key).name);
  if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
}

document.getElementById('btnModelSel').addEventListener('click', openSheet);
document.getElementById('overlaySheet').addEventListener('click', closeSheet);
document.getElementById('sheetSearch').addEventListener('input', e => {
  searchQ = e.target.value;
  renderSheetModels();
});
renderCats();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAT MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function removeEmpty() {
  const e = document.getElementById('emptyState');
  if (e) e.remove();
}
function addUserMsg(text, imgUrls) {
  removeEmpty();
  const area = document.getElementById('chatMsgs');
  const d = document.createElement('div');
  d.className = 'msg user';
  let imgs = '';
  (imgUrls||[]).forEach(u => { imgs += `<img src="${u}" style="max-width:200px;border-radius:12px;display:block;margin-bottom:4px">`; });
  d.innerHTML = `${imgs}${text?`<div class="bubble">${esc(text).replace(/\n/g,'<br>')}</div>`:''}<div class="msg-meta">${now()}</div>`;
  area.appendChild(d);
  area.scrollTop = area.scrollHeight;
}
function addThinking() {
  const area = document.getElementById('chatMsgs');
  const d = document.createElement('div');
  d.className = 'msg ai';
  d.id = 'thinking';
  d.innerHTML = `<div class="think-bubble"><span>–ò–ò –¥—É–º–∞–µ—Ç</span><div class="dots"><span></span><span></span><span></span></div></div>`;
  area.appendChild(d);
  area.scrollTop = area.scrollHeight;
  return d;
}
function removeThinking() {
  const el = document.getElementById('thinking');
  if (el) el.remove();
}
function formatMd(text) {
  // code blocks
  text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_,lang,code) => {
    const l = lang||'code';
    return `<pre><code class="language-${l}">${esc(code.trim())}</code></pre>`;
  });
  // bold, italic
  text = text.replace(/\*\*\*(.+?)\*\*\*/g,'<strong><em>$1</em></strong>');
  text = text.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  text = text.replace(/\*(.+?)\*/g,'<em>$1</em>');
  // headers
  text = text.replace(/^###\s+(.+)$/gm,'<strong>$1</strong>');
  text = text.replace(/^##\s+(.+)$/gm,'<strong style="font-size:15px">$1</strong>');
  text = text.replace(/^#\s+(.+)$/gm,'<strong style="font-size:16px">$1</strong>');
  // lists
  text = text.replace(/^[-*]\s+(.+)$/gm,'‚Ä¢ $1');
  // inline code
  text = text.replace(/`([^`\n]+)`/g,'<code>$1</code>');
  // newlines
  text = text.replace(/\n/g,'<br>');
  return text;
}
function addAiMsg(text, modelLabel) {
  removeThinking();
  const area = document.getElementById('chatMsgs');
  const d = document.createElement('div');
  d.className = 'msg ai';
  const rawText = text;
  d.innerHTML = `
    ${modelLabel?`<div style="font-size:10px;color:var(--t3);margin-bottom:3px">ü§ñ ${esc(modelLabel)}</div>`:''}
    <div class="bubble">${formatMd(text)}</div>
    <div style="display:flex;gap:6px;align-items:center">
      <div class="msg-meta">${now()}</div>
      <div class="copy-btn2" onclick="copyText(this,'${encodeURIComponent(rawText)}')">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</div>
    </div>`;
  area.appendChild(d);
  // highlight code
  d.querySelectorAll('pre code').forEach(el => { try { hljs.highlightElement(el); } catch(e){} });
  area.scrollTop = area.scrollHeight;
  scheduleHistSave();
}
function copyText(btn, encoded) {
  const text = decodeURIComponent(encoded);
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
    setTimeout(() => { btn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; }, 2000);
  }).catch(() => {});
}
function fillInput(el) {
  const inp = document.getElementById('msgInput');
  inp.value = el.textContent.trim();
  inp.dispatchEvent(new Event('input'));
  inp.focus();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const msgInput = document.getElementById('msgInput');
const btnSend  = document.getElementById('btnSend');

msgInput.addEventListener('input', () => {
  msgInput.style.height = 'auto';
  msgInput.style.height = Math.min(msgInput.scrollHeight, 120)+'px';
  btnSend.disabled = (!msgInput.value.trim() && !pendingImgs.length) || isLoading;
});
msgInput.addEventListener('keydown', e => {
  if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); if (!btnSend.disabled) sendMsg(); }
});
btnSend.addEventListener('click', sendMsg);

document.getElementById('btnAttach').addEventListener('click', () => {
  const m = getModel(curModel);
  if (!m.vision) { toast('‚ö†Ô∏è –≠—Ç–∞ –º–æ–¥–µ–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ'); return; }
  document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', e => {
  const files = Array.from(e.target.files||[]);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      const b64 = ev.target.result.split(',')[1];
      const url = ev.target.result;
      pendingImgs.push({file, b64, url});
      renderPreviews();
      btnSend.disabled = false;
    };
    reader.readAsDataURL(file);
  });
  e.target.value = '';
});

function renderPreviews() {
  const wrap = document.getElementById('imgPreviews');
  if (!pendingImgs.length) { wrap.style.display='none'; wrap.innerHTML=''; return; }
  wrap.style.display = 'flex';
  wrap.innerHTML = pendingImgs.map((img,i) =>
    `<div class="img-prev-wrap"><img class="img-prev" src="${img.url}"><div class="img-prev-rm" onclick="removeImg(${i})">√ó</div></div>`
  ).join('');
}
function removeImg(i) {
  pendingImgs.splice(i,1);
  renderPreviews();
  btnSend.disabled = (!msgInput.value.trim() && !pendingImgs.length) || isLoading;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEND MESSAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sendMsg() {
  if (isLoading || btnSend.disabled) return;
  if (!API_BASE) { toast('‚ùå –û—Ç–∫—Ä–æ–π Mini App —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ!'); return; }
  const text = msgInput.value.trim();
  const imgs = [...pendingImgs];
  if (!text && !imgs.length) return;

  isLoading = true;
  btnSend.disabled = true;
  addUserMsg(text, imgs.map(i=>i.url));
  msgInput.value = ''; msgInput.style.height='auto';
  pendingImgs = []; renderPreviews();
  messages.push({role:'user', content: text||(imgs.length?'[–§–æ—Ç–æ]':''), imgUrls:imgs.map(i=>i.url)});

  addThinking();

  const effectiveModel = autoModel ? '__auto__' : curModel;
  const histForBot = messages.slice(-10).map(m=>({role:m.role,content:m.content}));

  try {
    const resp = await fetch(`${API_BASE}/api/chat`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        action:'chat', uid:USER_ID,
        model:effectiveModel, text:text||'',
        images:imgs.map(i=>i.b64),
        history:histForBot, answer_mode:curMode
      })
    });
    const data = await resp.json();
    if (data.ok) {
      addAiMsg(data.answer, data.model_label);
      messages.push({role:'assistant',content:data.answer});
      if (data.fast_left !== undefined) {
        document.getElementById('limitBar').style.display='flex';
        document.getElementById('fastLeft').textContent = data.fast_left;
        document.getElementById('proLeft').textContent  = data.pro_left;
        userStats.fast_left = data.fast_left;
        userStats.pro_left  = data.pro_left;
        userStats.requests  = (userStats.requests||0)+1;
      }
      if (autoModel && data.used_model) toast('ü§ñ AI –≤—ã–±—Ä–∞–ª: '+data.used_model);
    } else if (data.error==='limit_exceeded') {
      removeThinking();
      addAiMsg(`üö´ –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω!\n‚è∞ –°–±—Ä–æ—Å —á–µ—Ä–µ–∑: ${data.reset_in||'?'}`);
    } else if (data.error==='subscription_required') {
      removeThinking();
      addAiMsg('üîê –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –ø–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª –≤ –±–æ—Ç–µ!');
    } else {
      removeThinking();
      addAiMsg('‚ùå –û—à–∏–±–∫–∞: '+(data.error||'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  } catch(e) {
    removeThinking();
    addAiMsg('‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.\n\nüí° –ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –Ω–∞–ø—Ä—è–º—É—é –≤ —á–∞—Ç –±–æ—Ç–∞.');
  }

  isLoading = false;
  btnSend.disabled = !msgInput.value.trim() && !pendingImgs.length;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLEAR & NEW CHAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('btnClear').addEventListener('click', () => {
  if (!messages.length) { toast('–ß–∞—Ç –∏ —Ç–∞–∫ –ø—É—Å—Ç'); return; }
  messages = []; pendingImgs = []; renderPreviews();
  const area = document.getElementById('chatMsgs');
  area.innerHTML = `<div class="empty" id="emptyState">
    <div class="empty-ico">ü§ñ</div>
    <div class="empty-title">–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
    <div class="empty-sub">–í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å –∏ –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å</div>
    <div class="chips">
      <div class="chip" onclick="fillInput(this)">–û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ —á—Ç–æ —Ç–∞–∫–æ–µ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</div>
      <div class="chip" onclick="fillInput(this)">–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python: —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—É–∑—ã—Ä—å–∫–æ–º</div>
      <div class="chip" onclick="fillInput(this)">–ü–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π: –ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?</div>
      <div class="chip" onclick="fillInput(this)">–ü—Ä–∏–¥—É–º–∞–π 5 –∏–¥–µ–π –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –≤ 2025 –≥–æ–¥—É</div>
    </div>
  </div>`;
  toast('üóë –ß–∞—Ç –æ—á–∏—â–µ–Ω');
  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
});

document.getElementById('btnNewChat').addEventListener('click', () => {
  saveHist();
  messages = []; pendingImgs = []; renderPreviews(); sessId = newId();
  const area = document.getElementById('chatMsgs');
  area.innerHTML = `<div class="empty" id="emptyState">
    <div class="empty-ico">‚úèÔ∏è</div>
    <div class="empty-title">–ù–æ–≤—ã–π —á–∞—Ç</div>
    <div class="empty-sub">–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ</div>
    <div class="chips">
      <div class="chip" onclick="fillInput(this)">–û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ —á—Ç–æ —Ç–∞–∫–æ–µ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</div>
      <div class="chip" onclick="fillInput(this)">–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python: —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –ø—É–∑—ã—Ä—å–∫–æ–º</div>
      <div class="chip" onclick="fillInput(this)">–ü–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π: –ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?</div>
      <div class="chip" onclick="fillInput(this)">–ü—Ä–∏–¥—É–º–∞–π 5 –∏–¥–µ–π –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –≤ 2025 –≥–æ–¥—É</div>
    </div>
  </div>`;
  toast('‚úèÔ∏è –ù–æ–≤—ã–π —á–∞—Ç');
  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveHist() {
  if (!messages.length) return;
  try {
    const stored = JSON.parse(localStorage.getItem(HIST_KEY)||'[]');
    const now2 = Date.now();
    const fresh = stored.filter(s=>(now2-s.ts)<HIST_TTL);
    const idx = fresh.findIndex(s=>s.id===sessId);
    const sess = {id:sessId,ts:now2,model:curModel,modelName:getModel(curModel).name,
      messages:messages.slice(-30), title:messages[0]?.content?.slice(0,60)||'–ß–∞—Ç'};
    if (idx>=0) fresh[idx]=sess; else fresh.unshift(sess);
    localStorage.setItem(HIST_KEY, JSON.stringify(fresh.slice(0,20)));
  } catch(e){}
}
function loadHist() {
  try {
    return JSON.parse(localStorage.getItem(HIST_KEY)||'[]').filter(s=>(Date.now()-s.ts)<HIST_TTL);
  } catch(e){ return []; }
}
function scheduleHistSave() {
  clearTimeout(window._histTimer);
  window._histTimer = setTimeout(saveHist, 2000);
}

function openHist() {
  saveHist(); renderHist();
  document.getElementById('overlayHist').classList.add('show');
  document.getElementById('histPanel').classList.add('show');
  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
}
function closeHist() {
  document.getElementById('overlayHist').classList.remove('show');
  document.getElementById('histPanel').classList.remove('show');
}
function renderHist() {
  const sessions = loadHist();
  const el = document.getElementById('histList');
  if (!sessions.length) { el.innerHTML='<div class="hist-empty">üò¥ –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞<br><br>–¢–≤–æ–∏ —á–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div>'; return; }
  el.innerHTML = sessions.map(s=>{
    const age = Date.now()-s.ts;
    const h=Math.floor(age/3600000), m=Math.floor((age%3600000)/60000);
    const timeAgo = h>0?`${h}—á –Ω–∞–∑–∞–¥`:m>0?`${m}–º–∏–Ω –Ω–∞–∑–∞–¥`:'—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    const prev = s.messages?.find(m=>m.role==='assistant')?.content?.slice(0,80)||'';
    const isCur = s.id===sessId;
    return `<div class="hist-item${isCur?' cur':''}" onclick="restoreHist('${s.id}')">
      <div class="hist-item-title">${esc(s.title)}</div>
      ${prev?`<div class="hist-item-prev">${esc(prev)}</div>`:''}
      <div class="hist-item-meta">
        <span>${timeAgo}</span>
        <span>${s.messages?.length||0} —Å–æ–æ–±—â.</span>
        <span>${esc(s.modelName||s.model)}</span>
        ${isCur?'<span style="color:var(--gr);font-weight:700">‚óè —Ç–µ–∫—É—â–∏–π</span>':''}
      </div>
    </div>`;
  }).join('');
}
function restoreHist(id) {
  const s = loadHist().find(x=>x.id===id);
  if (!s) return;
  closeHist();
  messages = []; sessId = s.id; curModel = s.model||curModel; updateHeader();
  const area = document.getElementById('chatMsgs');
  area.innerHTML = '';
  if (!s.messages?.length) { area.innerHTML='<div class="empty" id="emptyState"><div class="empty-ico">üí¨</div><div class="empty-title">–ß–∞—Ç –ø—É—Å—Ç</div></div>'; toast('‚ö†Ô∏è –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'); return; }
  s.messages.forEach(msg=>{
    if (msg.role==='user') addUserMsg(msg.content||'', msg.imgUrls||[]);
    else if (msg.role==='assistant') addAiMsg(msg.content||'');
  });
  messages = [...s.messages];
  toast('‚úÖ –ß–∞—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
}

document.getElementById('btnHistory').addEventListener('click', openHist);
document.getElementById('overlayHist').addEventListener('click', closeHist);
document.getElementById('btnHistClose').addEventListener('click', closeHist);
document.getElementById('btnHistNewChat').addEventListener('click', () => {
  closeHist();
  document.getElementById('btnNewChat').click();
});
document.getElementById('btnHistClear').addEventListener('click', () => {
  if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?')) {
    localStorage.removeItem(HIST_KEY);
    renderHist();
    toast('üóë –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMAGE GENERATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderImgModels() {
  document.getElementById('imgModelGrid').innerHTML = IMG_MODELS.map(m =>
    `<div class="img-model-item${m.key===curImgModel?' on':''}" onclick="selectImgModel('${m.key}')">
      <div class="img-model-ico">${m.emoji}</div>
      <div class="img-model-info">
        <div class="img-model-name">${m.name}</div>
        <div class="img-model-desc">${m.desc}</div>
      </div>
      <div class="img-model-check">‚úì</div>
    </div>`
  ).join('');
}
function selectImgModel(key) {
  curImgModel = key;
  renderImgModels();
  if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
}
function setSugg(text) {
  document.getElementById('imgPrompt').value = text;
  if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
}

document.getElementById('btnGenerate').addEventListener('click', async () => {
  const prompt = document.getElementById('imgPrompt').value.trim();
  if (!prompt) { toast('‚úèÔ∏è –í–≤–µ–¥–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏'); return; }
  if (!USER_ID) { toast('‚ùå –ù–µ—Ç UID ‚Äî –æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –±–æ—Ç'); return; }
  if (!API_BASE) { toast('‚ùå –ù–µ—Ç –∞–¥—Ä–µ—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞ ‚Äî –æ—Ç–∫—Ä–æ–π —á–µ—Ä–µ–∑ –±–æ—Ç'); return; }

  const btn = document.getElementById('btnGenerate');
  btn.disabled = true; btn.textContent = '‚è≥ –°–æ–∑–¥–∞—é...';
  document.getElementById('genResult').classList.remove('show');
  document.getElementById('genLoading').classList.add('show');
  document.getElementById('genLimitInfo').textContent = '';
  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

  try {
    const resp = await fetch(`${API_BASE}/api/imggen`, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({uid:USER_ID, prompt, model:curImgModel})
    });
    const data = await resp.json();
    document.getElementById('genLoading').classList.remove('show');
    if (data.ok) {
      lastImgB64 = data.image_b64;
      document.getElementById('genImg').src = 'data:image/png;base64,'+data.image_b64;
      document.getElementById('genResult').classList.add('show');
      document.getElementById('genLimitInfo').textContent = `üé® –û—Å—Ç–∞–ª–æ—Å—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–π: ${data.img_left}`;
      userStats.generations = (userStats.generations||0)+1;
      toast('‚úÖ –ö–∞—Ä—Ç–∏–Ω–∫–∞ –≥–æ—Ç–æ–≤–∞!');
      if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
    } else if (data.error==='img_limit_exceeded') {
      document.getElementById('genLimitInfo').textContent = `üö´ –õ–∏–º–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –∏—Å—á–µ—Ä–ø–∞–Ω`;
      toast('üö´ –õ–∏–º–∏—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –∏—Å—á–µ—Ä–ø–∞–Ω');
    } else if (data.error==='subscription_required') {
      toast('üîê –ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª –≤ –±–æ—Ç–µ');
    } else {
      toast('‚ùå '+(data.error||'–û—à–∏–±–∫–∞'));
    }
  } catch(e) {
    document.getElementById('genLoading').classList.remove('show');
    toast('‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
  }
  btn.disabled = false; btn.textContent = 'üé® –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É';
});

document.getElementById('btnDownload').addEventListener('click', () => {
  if (!lastImgB64) return;
  const a = document.createElement('a');
  a.href = 'data:image/png;base64,'+lastImgB64;
  a.download = 'huza_'+Date.now()+'.png';
  a.click();
  toast('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
});

document.getElementById('btnSendToChat').addEventListener('click', () => {
  if (!lastImgB64) return;
  switchTab('chat');
  const area = document.getElementById('chatMsgs');
  removeEmpty();
  const d = document.createElement('div');
  d.className = 'msg ai';
  d.innerHTML = `<img src="data:image/png;base64,${lastImgB64}" style="max-width:280px;border-radius:14px;display:block">
    <div class="msg-meta" style="margin-top:4px">üé® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ¬∑ ${now()}</div>`;
  area.appendChild(d);
  area.scrollTop = area.scrollHeight;
  toast('‚úÖ –ö–∞—Ä—Ç–∏–Ω–∫–∞ –≤ —á–∞—Ç–µ');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getUserLevel(req) {
  let name=LEVELS[0][1], next=LEVELS[1][0];
  for(let i=0;i<LEVELS.length;i++) {
    if(req>=LEVELS[i][0]){name=LEVELS[i][1];next=LEVELS[i+1]?LEVELS[i+1][0]:null;}
  }
  return {name,next};
}
function renderProfile() {
  const req = userStats.requests||0;
  const {name:lvl, next} = getUserLevel(req);
  const pct = next ? Math.round((req/next)*100) : 100;
  document.getElementById('profileWrap').innerHTML = `
    <div class="p-card">
      <div class="p-card-title">üèÖ –£—Ä–æ–≤–µ–Ω—å</div>
      <div class="level-badge">${lvl}</div>
      <div class="level-bar"><div class="level-fill" style="width:${pct}%"></div></div>
      <div class="level-hint">${next?`–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ: ${next-req} –∑–∞–ø—Ä–æ—Å–æ–≤`:'üëë –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å!'}</div>
    </div>
    <div class="p-card">
      <div class="p-card-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div class="stat-grid">
        <div class="stat-cell"><div class="stat-val">${req}</div><div class="stat-lbl">–ó–∞–ø—Ä–æ—Å–æ–≤</div></div>
        <div class="stat-cell"><div class="stat-val">${userStats.generations||0}</div><div class="stat-lbl">–ì–µ–Ω–µ—Ä–∞—Ü–∏–π</div></div>
        <div class="stat-cell"><div class="stat-val">${messages.filter(m=>m.role==='assistant').length}</div><div class="stat-lbl">–í —á–∞—Ç–µ</div></div>
      </div>
      ${userStats.joined?`<div style="font-size:11px;color:var(--t3);margin-top:10px;text-align:center">üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: ${esc(userStats.joined)}</div>`:''}
    </div>
    <div class="p-card">
      <div class="p-card-title">üí≥ –ë–∞–ª–∞–Ω—Å –ª–∏–º–∏—Ç–æ–≤</div>
      <div class="lim-row"><span>‚ö° –ë—ã—Å—Ç—Ä—ã–µ</span><span class="lim-val" style="color:var(--gr)">${userStats.fast_left}</span></div>
      <div class="lim-row"><span>üß† –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ</span><span class="lim-val" style="color:var(--ac)">${userStats.pro_left}</span></div>
      <div class="lim-row"><span>üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</span><span class="lim-val" style="color:var(--yw)">${userStats.img_left}</span></div>
    </div>
    <div class="p-card">
      <div class="p-card-title">üéõ –†–µ–∂–∏–º –æ—Ç–≤–µ—Ç–∞</div>
      <div class="mode-grid">
        ${Object.entries(MODES).map(([k,v])=>`<div class="mode-item${curMode===k?' on':''}" onclick="setMode('${k}');renderProfile()">${v}</div>`).join('')}
      </div>
      <div style="margin-top:10px">
        <div class="mode-item${autoModel?' on':''}" onclick="toggleAuto();renderProfile()" style="display:inline-block">ü§ñ –ê–≤—Ç–æ-–≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ ${autoModel?'‚úÖ':'‚ùå'}</div>
      </div>
    </div>
    <div class="p-card">
      <div class="p-card-title">üé® –¢–µ–º–∞</div>
      <div class="theme-row">
        <div class="theme-item${curTheme==='dark'?' on':''}" onclick="applyTheme('dark');renderProfile()">üåô –¢—ë–º–Ω–∞—è</div>
        <div class="theme-item${curTheme==='light'?' on':''}" onclick="applyTheme('light');renderProfile()">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</div>
      </div>
    </div>`;
  // Load fresh limits
  if (USER_ID && API_BASE) {
    fetch(`${API_BASE}/api/limits?uid=${USER_ID}`).then(r=>r.json()).then(d=>{
      if (d.ok) {
        userStats.fast_left=d.fast_left??0; userStats.pro_left=d.pro_left??0;
        userStats.img_left=d.img_left??0; userStats.requests=d.requests??userStats.requests;
        userStats.joined=d.joined||userStats.joined;
        renderProfile();
      }
    }).catch(()=>{});
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(()=>el.classList.remove('show'), 2200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD LIMITS ON START
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if (USER_ID && API_BASE) {
  fetch(`${API_BASE}/api/limits?uid=${USER_ID}`).then(r=>r.json()).then(d=>{
    if (d.ok) {
      document.getElementById('limitBar').style.display='flex';
      document.getElementById('fastLeft').textContent=d.fast_left;
      document.getElementById('proLeft').textContent=d.pro_left;
      userStats.fast_left=d.fast_left??0; userStats.pro_left=d.pro_left??0;
      userStats.img_left=d.img_left??0; userStats.requests=d.requests??0;
      userStats.joined=d.joined||'';
    }
  }).catch(()=>{});
}

// Load limits from URL params (fast init)
const fl=P.get('fast_left'), pl=P.get('pro_left');
if (fl||pl) {
  document.getElementById('limitBar').style.display='flex';
  document.getElementById('fastLeft').textContent=fl||'‚Äî';
  document.getElementById('proLeft').textContent=pl||'‚Äî';
}

// Init
renderImgModels();
</script>
</body>
</html>
