<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–•—É–∑–∞ –ò–ò</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<!-- highlight.js –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–æ–¥–∞ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<!-- KaTeX –¥–ª—è LaTeX —Ñ–æ—Ä–º—É–ª -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<style>
:root {
  --bg: #0a0a0f;
  --surface: #13131a;
  --surface2: #1c1c27;
  --surface3: #252535;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --text: #f0f0ff;
  --text2: rgba(240,240,255,0.55);
  --text3: rgba(240,240,255,0.3);
  --accent: #5b6ef5;
  --accent2: #7c8ff7;
  --accent-glow: rgba(91,110,245,0.25);
  --user-bubble: #1e2460;
  --user-border: rgba(91,110,245,0.4);
  --ai-bubble: #13131a;
  --green: #34d399;
  --red: #f87171;
  --yellow: #fbbf24;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Manrope', sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100dvh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  gap: 10px;
  flex-shrink: 0;
  z-index: 10;
}

.model-selector {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 22px;
  padding: 7px 14px 7px 10px;
  cursor: pointer;
  flex: 1;
  transition: all 0.15s;
  min-width: 0;
}
.model-selector:active { opacity: 0.8; transform: scale(0.98); }

.model-avatar {
  width: 28px; height: 28px;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
  overflow: hidden;
}
.model-avatar svg { width: 20px; height: 20px; }

.model-selector-info { flex: 1; min-width: 0; }
.model-selector-name {
  font-size: 14px; font-weight: 700;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  color: var(--text);
}
.model-selector-sub {
  font-size: 10px; color: var(--text2); margin-top: 1px;
}

.chevron { color: var(--text3); font-size: 10px; flex-shrink: 0; }

.header-actions { display: flex; gap: 6px; flex-shrink: 0; }
.header-btn {
  width: 36px; height: 36px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text2);
  transition: all 0.15s;
  font-size: 16px;
}
.header-btn:active { opacity: 0.7; transform: scale(0.95); }

/* ‚îÄ‚îÄ MODEL PICKER SHEET ‚îÄ‚îÄ */
.sheet-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 100;
  opacity: 0; pointer-events: none;
  transition: opacity 0.25s;
}
.sheet-overlay.open { opacity: 1; pointer-events: all; }

.sheet {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  z-index: 101;
  max-height: 80dvh;
  display: flex; flex-direction: column;
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.32,0.72,0,1);
}
.sheet.open { transform: translateY(0); }

.sheet-handle {
  width: 36px; height: 4px;
  background: var(--border2);
  border-radius: 2px;
  margin: 10px auto 0;
  flex-shrink: 0;
}

.sheet-header {
  padding: 14px 16px 10px;
  flex-shrink: 0;
}
.sheet-title { font-size: 17px; font-weight: 800; }
.sheet-sub { font-size: 12px; color: var(--text2); margin-top: 2px; }

.sheet-search {
  padding: 0 16px 10px;
  flex-shrink: 0;
}
.sheet-search input {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 9px 14px 9px 36px;
  color: var(--text);
  font-family: 'Manrope', sans-serif;
  font-size: 14px;
  outline: none;
}
.sheet-search input::placeholder { color: var(--text3); }
.search-icon-wrap {
  position: relative;
}
.search-icon-wrap svg {
  position: absolute; left: 26px; top: 50%;
  transform: translateY(-50%);
  color: var(--text3);
  pointer-events: none;
}

.sheet-cats {
  display: flex; gap: 6px;
  padding: 0 16px 10px;
  overflow-x: auto; scrollbar-width: none;
  flex-shrink: 0;
}
.sheet-cats::-webkit-scrollbar { display: none; }

.cat-pill {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 5px 12px;
  font-size: 12px; font-weight: 600;
  color: var(--text2);
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.15s;
  flex-shrink: 0;
}
.cat-pill.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

.sheet-list {
  overflow-y: auto;
  flex: 1;
  padding-bottom: calc(env(safe-area-inset-bottom) + 10px);
}

.model-row {
  display: flex; align-items: center;
  padding: 11px 16px;
  cursor: pointer;
  transition: background 0.12s;
  border-bottom: 1px solid var(--border);
  gap: 12px;
}
.model-row:active { background: rgba(255,255,255,0.04); }
.model-row.selected { background: rgba(91,110,245,0.1); }
.model-row.selected::before {
  content: ''; position: absolute; left: 0;
  width: 3px; height: 100%;
  background: var(--accent);
  border-radius: 0 2px 2px 0;
}
.model-row { position: relative; }

.row-avatar {
  width: 44px; height: 44px;
  border-radius: 13px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
  overflow: hidden;
}
.row-avatar svg { width: 28px; height: 28px; }

.row-info { flex: 1; min-width: 0; }
.row-name {
  font-size: 15px; font-weight: 700;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.row-desc {
  font-size: 12px; color: var(--text2);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden;
  margin-top: 2px;
}
.row-right {
  display: flex; flex-direction: column;
  align-items: flex-end; gap: 5px;
  flex-shrink: 0;
}
.check { width: 20px; height: 20px; border-radius: 50%; background: var(--accent);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; transform: scale(0.6); transition: all 0.2s;
}
.model-row.selected .check { opacity: 1; transform: scale(1); }
.vision-tag {
  font-size: 9px; font-weight: 700;
  background: rgba(251,191,36,0.15);
  color: var(--yellow);
  border: 1px solid rgba(251,191,36,0.3);
  padding: 2px 6px; border-radius: 5px;
  letter-spacing: 0.3px;
}
.section-label {
  padding: 12px 16px 5px;
  font-size: 10px; font-weight: 700;
  color: var(--text3);
  letter-spacing: 1px;
  text-transform: uppercase;
}

/* ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ */
.chat-area {
  flex: 1;
  overflow-y: auto;
  padding: 12px 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  scrollbar-width: thin;
  scrollbar-color: var(--surface3) transparent;
}

.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  padding: 20px;
  text-align: center;
}
.empty-icon {
  width: 64px; height: 64px;
  border-radius: 20px;
  background: var(--surface2);
  border: 1px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  font-size: 30px;
}
.empty-title { font-size: 20px; font-weight: 800; }
.empty-sub { font-size: 13px; color: var(--text2); line-height: 1.5; }

.suggestions {
  display: flex; gap: 8px;
  overflow-x: auto; scrollbar-width: none;
  padding-bottom: 2px;
  width: 100%;
}
.suggestions::-webkit-scrollbar { display: none; }
.sugg-chip {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 14px;
  padding: 10px 14px;
  font-size: 12px; font-weight: 600;
  color: var(--text2);
  white-space: nowrap;
  cursor: pointer;
  flex-shrink: 0;
  max-width: 160px;
  white-space: normal;
  line-height: 1.3;
  transition: all 0.15s;
}
.sugg-chip:active { background: var(--surface3); }

/* Messages */
.msg { display: flex; flex-direction: column; max-width: 88%; animation: fadeUp 0.25s ease both; }
@keyframes fadeUp { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform:none; } }

.msg.user { align-self: flex-end; }
.msg.ai   { align-self: flex-start; }

.bubble {
  padding: 10px 14px;
  border-radius: 18px;
  font-size: 14px; line-height: 1.55;
  word-break: break-word;
}
.msg.user .bubble {
  background: var(--user-bubble);
  border: 1px solid var(--user-border);
  border-bottom-right-radius: 5px;
  color: #e8ecff;
}
.msg.ai .bubble {
  background: var(--ai-bubble);
  border: 1px solid var(--border);
  border-bottom-left-radius: 5px;
}

.msg-img {
  max-width: 100%; border-radius: 12px;
  margin-bottom: 6px;
  border: 1px solid var(--border);
}

.msg-meta {
  font-size: 10px; color: var(--text3);
  margin-top: 3px;
  padding: 0 4px;
}
.msg.user .msg-meta { text-align: right; }
.msg.ai   .msg-meta { text-align: left; }

/* AI label */
.ai-label {
  display: flex; align-items: center; gap: 5px;
  font-size: 10px; font-weight: 700;
  color: var(--text3);
  margin-bottom: 4px;
  padding: 0 2px;
}
.ai-dot {
  width: 20px; height: 20px;
  border-radius: 5px;
  display: flex; align-items: center; justify-content: center;
  font-size: 9px;
  overflow: hidden;
}
.ai-dot svg { width: 14px; height: 14px; }

/* Typing indicator */
.typing-bubble {
  display: flex; gap: 4px;
  align-items: center;
  padding: 12px 16px;
}
.typing-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--text3);
  animation: blink 1.2s ease infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink {
  0%,80%,100% { transform: scale(1); opacity: 0.5; }
  40% { transform: scale(1.3); opacity: 1; }
}

/* code blocks */
.bubble pre {
  background: #0d0d14;
  border: 1px solid var(--border2);
  border-radius: 10px;
  padding: 10px 12px;
  overflow-x: auto;
  margin: 8px 0;
  font-size: 12px;
  font-family: 'SF Mono', monospace;
  line-height: 1.6;
}
.bubble code {
  background: rgba(255,255,255,0.08);
  padding: 1px 5px;
  border-radius: 4px;
  font-size: 12px;
  font-family: 'SF Mono', monospace;
}
.bubble pre code { background: none; padding: 0; }
.bubble p { margin-bottom: 6px; }
.bubble p:last-child { margin-bottom: 0; }
.bubble strong { color: #fff; font-weight: 700; }

/* ‚îÄ‚îÄ INPUT BAR ‚îÄ‚îÄ */
.input-bar {
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 8px 10px;
  padding-bottom: calc(8px + env(safe-area-inset-bottom));
  flex-shrink: 0;
}

.input-row {
  display: flex; align-items: flex-end; gap: 7px;
}

.attach-btn, .send-btn {
  width: 40px; height: 40px;
  border-radius: 13px;
  border: none;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.15s;
}
.attach-btn {
  background: var(--surface2);
  color: var(--text2);
  font-size: 18px;
}
.attach-btn:active { opacity: 0.7; }
.attach-btn.vision-active {
  background: rgba(251,191,36,0.15);
  color: #fbbf24;
  border: 1.5px solid rgba(251,191,36,0.35);
  box-shadow: 0 0 8px rgba(251,191,36,0.15);
}

.send-btn {
  background: var(--accent);
  color: #fff;
  font-size: 17px;
}
.send-btn:active { transform: scale(0.92); }
.send-btn:disabled { background: var(--surface3); color: var(--text3); }

.input-wrap {
  flex: 1;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 16px;
  display: flex; align-items: flex-end;
  padding: 8px 12px;
  gap: 6px;
  min-height: 40px;
  transition: border-color 0.2s;
}
.input-wrap:focus-within { border-color: rgba(91,110,245,0.5); }

#msgInput {
  flex: 1;
  background: none;
  border: none;
  outline: none;
  color: var(--text);
  font-family: 'Manrope', sans-serif;
  font-size: 14px;
  line-height: 1.5;
  resize: none;
  max-height: 120px;
  min-height: 20px;
}
#msgInput::placeholder { color: var(--text3); }

/* image preview strip */
.img-preview {
  display: flex; gap: 6px;
  margin-bottom: 6px;
}
.preview-thumb {
  position: relative;
  width: 56px; height: 56px;
}
.preview-thumb img {
  width: 56px; height: 56px;
  border-radius: 10px;
  object-fit: cover;
  border: 1px solid var(--border2);
}
.preview-rm {
  position: absolute; top: -5px; right: -5px;
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--red);
  color: #fff;
  font-size: 11px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  border: 1.5px solid var(--bg);
}

/* vision hint bar */
.vision-hint {
  background: rgba(251,191,36,0.08);
  border: 1px solid rgba(251,191,36,0.2);
  border-radius: 10px;
  padding: 7px 12px;
  font-size: 11px;
  color: #fbbf24;
  font-weight: 600;
  margin-bottom: 6px;
  display: flex; align-items: center; gap: 6px;
  cursor: pointer;
  transition: background 0.15s;
}
.vision-hint:active { background: rgba(251,191,36,0.15); }

/* limit bar */
.limit-bar {
  display: flex; gap: 8px; align-items: center;
  padding: 6px 10px;
  background: var(--surface2);
  border-radius: 10px;
  margin-bottom: 6px;
  font-size: 11px; color: var(--text2);
}
.limit-item { display: flex; gap: 4px; align-items: center; }
.limit-dot { width: 6px; height: 6px; border-radius: 50%; }

/* file input hidden */
#fileInput { display: none; }

/* Avatar colors */
.av-claude  { background: linear-gradient(135deg,#d4845a,#c9512f); }
.av-gpt     { background: linear-gradient(135deg,#10a37f,#0a7a5f); }
.av-deepseek{ background: linear-gradient(135deg,#4e6ef2,#2a42c4); }
.av-qwen    { background: linear-gradient(135deg,#8b5cf6,#6d28d9); }
.av-llama   { background: linear-gradient(135deg,#f59e0b,#d97706); }
.av-command { background: linear-gradient(135deg,#6b7280,#374151); }
.av-kimi    { background: linear-gradient(135deg,#ec4899,#be185d); }
.av-glm     { background: linear-gradient(135deg,#a78bfa,#7c3aed); }
.av-c4ai    { background: linear-gradient(135deg,#06b6d4,#0891b2); }
.av-sonar   { background: linear-gradient(135deg,#f97316,#ea580c); }

/* toast */
.toast {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: var(--surface3);
  border: 1px solid var(--border2);
  border-radius: 12px;
  padding: 8px 16px;
  font-size: 13px; font-weight: 600;
  opacity: 0;
  transition: all 0.25s;
  white-space: nowrap;
  z-index: 200;
  pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ MODEL ICONS ‚îÄ‚îÄ */
.av-claude  { background: linear-gradient(135deg,#667eea,#764ba2); }
.av-gpt     { background: linear-gradient(135deg,#11998e,#38ef7d); }
.av-deepseek{ background: linear-gradient(135deg,#2193b0,#6dd5ed); }
.av-qwen    { background: linear-gradient(135deg,#f7971e,#ffd200); }
.av-llama   { background: linear-gradient(135deg,#834d9b,#d04ed6); }
.av-command { background: linear-gradient(135deg,#1a1a2e,#16213e); border:1px solid rgba(255,255,255,0.15); }
.av-kimi    { background: linear-gradient(135deg,#0f3460,#533483); }
.av-glm     { background: linear-gradient(135deg,#6a3093,#a044ff); }
.av-c4ai    { background: linear-gradient(135deg,#f953c6,#b91d73); }
.av-sonar   { background: linear-gradient(135deg,#4facfe,#00f2fe); }

/* ‚îÄ‚îÄ THINK TIMER ‚îÄ‚îÄ */
.think-timer {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px;
  background: rgba(91,110,245,0.08);
  border: 1px solid rgba(91,110,245,0.2);
  border-radius: 14px;
  font-size: 13px; color: var(--text2);
}
.think-timer .timer-icon { font-size: 16px; animation: spin 2s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.think-timer .timer-secs { font-weight: 700; color: var(--accent2); font-size: 15px; min-width: 28px; }

/* ‚îÄ‚îÄ CODE BLOCKS ‚îÄ‚îÄ */
.code-wrapper {
  position: relative;
  margin: 12px 0;
  border-radius: 14px;
  overflow: hidden;
  width: 100%;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  border: 1px solid rgba(91,110,245,0.2);
}
.code-header {
  display: flex; justify-content: space-between; align-items: center;
  background: linear-gradient(135deg, #0d0e1a, #161726);
  padding: 9px 14px;
  font-size: 11px; color: rgba(255,255,255,0.5);
  font-family: "SF Mono", "Fira Code", monospace;
  border-bottom: 1px solid rgba(91,110,245,0.15);
}
.code-header > span:first-child {
  display: inline-flex; align-items: center; gap: 6px;
  font-weight: 700; letter-spacing: 0.5px;
  color: var(--accent2);
}
.code-header > span:first-child::before {
  content: ''; display: inline-block;
  width: 8px; height: 8px; border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 6px rgba(91,110,245,0.6);
}
.copy-btn {
  background: rgba(91,110,245,0.12);
  border: 1px solid rgba(91,110,245,0.25);
  color: rgba(255,255,255,0.6);
  padding: 4px 12px;
  border-radius: 6px;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.15s;
  font-family: 'Manrope', sans-serif;
  white-space: nowrap;
}
.copy-btn:active, .copy-btn.copied { background: rgba(52,211,153,0.2); color: #34d399; border-color: rgba(52,211,153,0.3); }
.code-wrapper pre {
  margin: 0 !important;
  border-radius: 0 0 14px 14px !important;
  background: #0f1117 !important;
  padding: 16px 16px !important;
  overflow-x: auto !important;
  overflow-y: visible !important;
  white-space: pre !important;
  word-break: normal !important;
  word-wrap: normal !important;
  font-size: 12.5px !important;
  line-height: 1.7 !important;
  max-height: none !important;
}
.code-wrapper pre code {
  font-family: "SF Mono", "Fira Code", "Consolas", monospace !important;
  white-space: pre !important;
  word-break: normal !important;
  word-wrap: normal !important;
  display: block;
}

/* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
.table-wrap {
  width: 100%;
  overflow-x: auto;
  margin: 12px 0;
  border-radius: 12px;
  border: 1px solid rgba(91,110,245,0.25);
  box-shadow: 0 2px 12px rgba(0,0,0,0.2);
}
.bubble table {
  border-collapse: collapse;
  width: 100%;
  min-width: 340px;
  font-size: 13.5px;
}
.bubble th {
  background: linear-gradient(135deg, #3d4fd4, #5b6ef5);
  color: #fff;
  padding: 11px 16px;
  text-align: left;
  font-weight: 700;
  font-size: 13px;
  letter-spacing: 0.3px;
  white-space: nowrap;
}
.bubble td {
  padding: 10px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  color: var(--text);
  line-height: 1.6;
  vertical-align: top;
  font-size: 13px;
}
.bubble tr:nth-child(even) td { background: rgba(91,110,245,0.07); }
.bubble tr:last-child td { border-bottom: none; }
.bubble tr:hover td { background: rgba(255,255,255,0.05); transition: background 0.15s; }

/* ‚îÄ‚îÄ KATEX ‚îÄ‚îÄ */
.katex { font-size: 1em !important; }
.katex-display { overflow-x: auto; padding: 4px 0; }

/* ‚îÄ‚îÄ HISTORY PANEL ‚îÄ‚îÄ */
.history-btn {
  width: 36px; height: 36px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text2);
  transition: all 0.15s;
  font-size: 16px;
  flex-shrink: 0;
}
.history-btn:active { opacity: 0.7; transform: scale(0.95); }
.history-btn svg { width: 18px; height: 18px; }

.history-panel {
  position: fixed; top: 0; right: 0; bottom: 0;
  width: 85vw; max-width: 340px;
  background: var(--surface);
  z-index: 200;
  display: flex; flex-direction: column;
  transform: translateX(100%);
  transition: transform 0.3s cubic-bezier(0.32,0.72,0,1);
  border-left: 1px solid var(--border);
}
.history-panel.open { transform: translateX(0); }

.history-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 199;
  opacity: 0; pointer-events: none;
  transition: opacity 0.25s;
}
.history-overlay.open { opacity: 1; pointer-events: all; }

.history-header {
  padding: 14px 16px 10px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.history-title { font-size: 17px; font-weight: 800; }
.history-close {
  width: 30px; height: 30px;
  background: var(--surface3);
  border-radius: 50%; border: none;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text2); font-size: 14px;
}
.history-sub {
  font-size: 11px; color: var(--text3);
  padding: 6px 16px 10px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.history-list {
  flex: 1; overflow-y: auto;
  padding: 8px 0;
}
.history-empty {
  padding: 40px 20px;
  text-align: center;
  color: var(--text3);
  font-size: 13px;
}
.history-item {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background 0.12s;
}
.history-item:active { background: rgba(255,255,255,0.04); }
.history-item.selected { background: rgba(91,110,245,0.1); border-left: 3px solid var(--accent); }
.history-item-title {
  font-size: 13px; font-weight: 600;
  color: var(--text);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  margin-bottom: 4px;
}
.history-item-meta {
  font-size: 11px; color: var(--text3);
  display: flex; gap: 8px;
}
.history-item-preview {
  font-size: 12px; color: var(--text2);
  margin-top: 3px;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden; line-height: 1.4;
}
.history-item-model {
  background: rgba(91,110,245,0.15);
  color: var(--accent2);
  padding: 1px 6px; border-radius: 4px;
  font-size: 10px; font-weight: 600;
}
.history-clear-btn {
  margin: 10px 16px;
  padding: 10px;
  background: rgba(248,113,113,0.1);
  border: 1px solid rgba(248,113,113,0.2);
  border-radius: 10px;
  color: #f87171;
  font-size: 13px; font-weight: 600;
  cursor: pointer; text-align: center;
  transition: all 0.15s;
  flex-shrink: 0;
}
.history-clear-btn:active { background: rgba(248,113,113,0.2); }

/* ‚îÄ‚îÄ LIGHT THEME ‚îÄ‚îÄ */
body.light {
  --bg: #f0f0f7;
  --surface: #ffffff;
  --surface2: #f0f0f5;
  --surface3: #e5e5ea;
  --border: rgba(0,0,0,0.08);
  --border2: rgba(0,0,0,0.14);
  --text: #1a1a2e;
  --text2: rgba(26,26,46,0.6);
  --text3: rgba(26,26,46,0.35);
  --user-bubble: #4f5fe8;
  --user-border: rgba(79,95,232,0.4);
  --ai-bubble: #ffffff;
}
body.light .msg.user .bubble { color: #ffffff; }
body.light .code-wrapper pre { background: #1e1e2e !important; }

/* ‚îÄ‚îÄ MODE BAR ‚îÄ‚îÄ */
.mode-bar {
  display: flex; align-items: center; gap: 5px;
  padding: 5px 12px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  overflow-x: auto; scrollbar-width: none;
  flex-shrink: 0;
}
.mode-bar::-webkit-scrollbar { display: none; }
.mode-pill {
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 11.5px; font-weight: 600;
  color: var(--text2);
  background: var(--surface2);
  border: 1px solid var(--border);
  cursor: pointer;
  white-space: nowrap;
  flex-shrink: 0;
  transition: all 0.15s;
}
.mode-pill.active { background: var(--accent); border-color: var(--accent); color: #fff; }
.auto-pill {
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 11.5px; font-weight: 600;
  color: var(--text2);
  background: var(--surface2);
  border: 1px solid var(--border);
  cursor: pointer;
  white-space: nowrap;
  flex-shrink: 0;
  margin-left: auto;
  transition: all 0.15s;
}
.auto-pill.active { background: rgba(52,211,153,0.15); border-color: rgba(52,211,153,0.4); color: #34d399; }
.auto-model-badge {
  align-self: flex-start;
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 10px;
  background: rgba(52,211,153,0.12);
  border: 1px solid rgba(52,211,153,0.3);
  border-radius: 8px;
  font-size: 11px; color: #34d399; font-weight: 600;
  margin-bottom: 3px;
}
/* ‚îÄ‚îÄ COPY ANSWER ‚îÄ‚îÄ */
.copy-answer-btn {
  display: inline-flex; align-items: center; gap: 4px;
  margin-top: 5px;
  padding: 4px 10px;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 8px;
  font-size: 11px; font-weight: 600;
  color: var(--text3);
  cursor: pointer;
  transition: all 0.15s;
}
.copy-answer-btn.copied { background: rgba(52,211,153,0.15); color: #34d399; border-color: rgba(52,211,153,0.3); }
/* ‚îÄ‚îÄ PROFILE SHEET ‚îÄ‚îÄ */
.profile-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 200;
  opacity: 0; pointer-events: none;
  transition: opacity 0.25s;
}
.profile-overlay.open { opacity: 1; pointer-events: all; }
.profile-sheet {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  z-index: 201;
  max-height: 88dvh;
  display: flex; flex-direction: column;
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.32,0.72,0,1);
}
.profile-sheet.open { transform: translateY(0); }
.profile-sheet-handle { width: 36px; height: 4px; background: var(--border2); border-radius: 2px; margin: 10px auto 0; flex-shrink: 0; }
.profile-header {
  padding: 14px 16px 10px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.profile-title { font-size: 18px; font-weight: 800; }
.profile-close {
  width: 30px; height: 30px;
  background: var(--surface3);
  border-radius: 50%; border: none;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text2); font-size: 15px;
}
.profile-body { overflow-y: auto; flex: 1; padding: 14px; display: flex; flex-direction: column; gap: 12px; }
.p-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 14px;
}
.p-card-title {
  font-size: 10px; font-weight: 700; color: var(--text3);
  text-transform: uppercase; letter-spacing: 1px;
  margin-bottom: 10px;
}
.level-badge {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 6px 14px;
  background: linear-gradient(135deg, var(--accent), #9b59b6);
  border-radius: 20px;
  font-size: 15px; font-weight: 800; color: #fff;
  margin-bottom: 8px;
}
.level-progress { background: var(--surface3); border-radius: 4px; height: 5px; overflow: hidden; margin-top: 6px; }
.level-progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #9b59b6); border-radius: 4px; transition: width 0.6s ease; }
.stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
.stat-cell { text-align: center; background: var(--surface); border-radius: 12px; padding: 10px 4px; }
.stat-cell-val { font-size: 20px; font-weight: 800; }
.stat-cell-lbl { font-size: 10px; color: var(--text3); margin-top: 2px; }
.limit-row { display: flex; align-items: center; justify-content: space-between; padding: 9px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
.limit-row:last-child { border-bottom: none; }
.limit-val { font-weight: 700; font-size: 15px; }
.theme-toggle { display: flex; background: var(--surface3); border-radius: 12px; padding: 3px; gap: 2px; }
.theme-btn { flex: 1; padding: 8px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s; color: var(--text2); }
.theme-btn.active { background: var(--surface); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,0.15); }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="model-selector" id="modelSelector">
    <div class="model-avatar av-claude" id="hdrAvatar">üî∑</div>
    <div class="model-selector-info">
      <div class="model-selector-name" id="hdrName">Claude Sonnet 4.5</div>
      <div class="model-selector-sub" id="hdrSub">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å</div>
    </div>
    <div class="chevron">‚ñº</div>
  </div>
  <div class="header-actions">
    <div class="header-btn" id="profileBtn" title="–ü—Ä–æ—Ñ–∏–ª—å" style="font-size:16px;">üë§</div>
    <div class="header-btn" id="historyBtn" title="–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>
    </div>
    <div class="header-btn" id="newChatBtn" title="–ù–æ–≤—ã–π —á–∞—Ç" style="font-size:18px;">‚úèÔ∏è</div>
    <div class="header-btn" id="clearBtn" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç" style="font-size:16px;">üóë</div>
  </div>
</div>

<!-- MODE BAR: —Ä–µ–∂–∏–º—ã –æ—Ç–≤–µ—Ç–∞ + –∞–≤—Ç–æ-—Ä–µ–∂–∏–º -->
<div class="mode-bar" id="modeBar">
  <div class="mode-pill active" id="mode-fast"   onclick="setMode('fast')">‚ö°Ô∏è –ë—ã—Å—Ç—Ä–æ</div>
  <div class="mode-pill"        id="mode-simple" onclick="setMode('simple')">üéì –ü—Ä–æ—Å—Ç–æ</div>
  <div class="mode-pill"        id="mode-dev"    onclick="setMode('dev')">üíª –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</div>
  <div class="mode-pill"        id="mode-deep"   onclick="setMode('deep')">üß† –ì–ª—É–±–æ–∫–æ</div>
  <div class="auto-pill"        id="autoPill"    onclick="toggleAutoModel()">ü§ñ –ê–≤—Ç–æ</div>
</div>

<!-- CHAT -->
<div class="chat-area" id="chatArea">
  <div class="empty-state" id="emptyState">
    <div class="empty-icon">ü§ñ</div>
    <div class="empty-title">–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
    <div class="empty-sub">–í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å –≤–≤–µ—Ä—Ö—É –∏ –Ω–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å ‚Äî –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Vision</div>
    <div class="suggestions" id="suggestions">
      <div class="sugg-chip">–û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</div>
      <div class="sugg-chip">–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–ø–∏—Å–∫–∞</div>
      <div class="sugg-chip">–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π</div>
      <div class="sugg-chip">–ü—Ä–∏–¥—É–º–∞–π –∏–¥–µ–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –≤ 2025</div>
    </div>
  </div>
</div>

<!-- INPUT -->
<div class="input-bar" id="inputBar">
  <div class="vision-hint" id="visionHint" style="display:none" onclick="document.getElementById('fileInput').click()">
    üì∏ –≠—Ç–∞ –º–æ–¥–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ ‚Äî –Ω–∞–∂–º–∏ —á—Ç–æ–±—ã –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å
  </div>
  <div class="img-preview" id="imgPreview" style="display:none"></div>
  <div class="limit-bar" id="limitBar" style="display:none">
    <span>üìä –ó–∞–ø—Ä–æ—Å—ã:</span>
    <span class="limit-item"><span class="limit-dot" style="background:#34d399"></span><span id="fastLeft">‚Äî</span> –±—ã—Å—Ç—Ä—ã—Ö</span>
    <span class="limit-item"><span class="limit-dot" style="background:#5b6ef5"></span><span id="proLeft">‚Äî</span> –ø—Ä–æ—Ñ.</span>
  </div>
  <div class="input-row">
    <button class="attach-btn" id="attachBtn">üìé</button>
    <div class="input-wrap">
      <textarea id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
    </div>
    <button class="send-btn" id="sendBtn" disabled>‚Üë</button>
  </div>
</div>

<!-- MODEL SHEET -->
<div class="sheet-overlay" id="sheetOverlay"></div>
<div class="sheet" id="sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">–í—ã–±–æ—Ä –Ω–µ–π—Ä–æ—Å–µ—Ç–∏</div>
    <div class="sheet-sub">–í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å –¥–ª—è –æ–±—â–µ–Ω–∏—è</div>
  </div>
  <div class="sheet-search">
    <div class="search-icon-wrap">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
      </svg>
      <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –º–æ–¥–µ–ª–∏...">
    </div>
  </div>
  <div class="sheet-cats" id="sheetCats"></div>
  <div class="sheet-list" id="sheetList"></div>
</div>

<input type="file" id="fileInput" accept="image/*">
<div class="toast" id="toast"></div>

<!-- PROFILE OVERLAY + SHEET -->
<div class="profile-overlay" id="profileOverlay" onclick="closeProfile()"></div>
<div class="profile-sheet" id="profileSheet">
  <div class="profile-sheet-handle"></div>
  <div class="profile-header">
    <div class="profile-title">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
    <button class="profile-close" onclick="closeProfile()">‚úï</button>
  </div>
  <div class="profile-body" id="profileBody">
    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
    <div style="text-align:center;padding:40px;color:var(--text3)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>
</div>

<!-- HISTORY OVERLAY + PANEL -->
<div class="history-overlay" id="historyOverlay"></div>
<div class="history-panel" id="historyPanel">
  <div class="history-header">
    <div class="history-title">üìã –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</div>
    <div style="display:flex;gap:6px;align-items:center;">
      <button class="history-close" id="historyNewChat" title="–ù–æ–≤—ã–π —á–∞—Ç" style="background:var(--accent);color:#fff;font-size:13px;width:auto;padding:0 10px;border-radius:8px;">+ –ù–æ–≤—ã–π</button>
      <button class="history-close" id="historyClose">‚úï</button>
    </div>
  </div>
  <div class="history-sub">‚è≥ –•—Ä–∞–Ω–∏—Ç—Å—è 24 —á–∞—Å–∞ ¬∑ –Ω–∞–∂–º–∏ —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</div>
  <div class="history-list" id="historyList"></div>
  <button class="history-clear-btn" id="historyClearBtn">üóë –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é</button>
</div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// ‚îÄ‚îÄ –ò–∫–æ–Ω–∫–∏ –º–æ–¥–µ–ª–µ–π (SVG/PNG —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–µ URL) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MODEL_ICONS = {
  claude_sonnet: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#CC785C"/><path d="M8 12.5c1-2 3-3.5 4-3.5s3 1.5 4 3.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><circle cx="9" cy="9.5" r="1" fill="white"/><circle cx="15" cy="9.5" r="1" fill="white"/></svg>`,
  claude_haiku:  `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#CC785C"/><path d="M9 12.5c.8-1.5 1.8-2.5 3-2.5s2.2 1 3 2.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><circle cx="9.5" cy="10" r="0.8" fill="white"/><circle cx="14.5" cy="10" r="0.8" fill="white"/></svg>`,
  claude_opus:   `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#8B4513"/><path d="M7.5 13c1.5-3 3-4.5 4.5-4.5s3 1.5 4.5 4.5" stroke="white" stroke-width="2" stroke-linecap="round"/><circle cx="8.5" cy="9" r="1.2" fill="white"/><circle cx="15.5" cy="9" r="1.2" fill="white"/></svg>`,
  gpt52:         `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#10a37f"/><path d="M12 6.5A5.5 5.5 0 0112 17.5M8.5 8.5a5.5 5.5 0 017 7M7 12h10" stroke="white" stroke-width="1.4" stroke-linecap="round"/></svg>`,
  gpt52_chat:    `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#10a37f"/><path d="M7 9h10M7 13h7" stroke="white" stroke-width="1.8" stroke-linecap="round"/><circle cx="17" cy="15" r="2" fill="white"/></svg>`,
  deepseek_v3:   `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#1e4d8c"/><path d="M7 12c0-2.8 2.2-5 5-5s5 2.2 5 5-2.2 5-5 5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><circle cx="12" cy="12" r="2" fill="white"/></svg>`,
  deepseek_r1:   `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#0f2d5e"/><path d="M9 8l2 4-2 4M15 8l-2 4 2 4" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
  deepseek_v3_sq:`<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#1a3a6b"/><path d="M7 12c0-2.8 2.2-5 5-5s5 2.2 5 5-2.2 5-5 5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><circle cx="12" cy="12" r="2" fill="white"/></svg>`,
  qwen3_max:     `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#FF6A00"/><text x="12" y="16" text-anchor="middle" font-size="9" fill="white" font-weight="bold">Q</text></svg>`,
  qwen3_vl:      `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#FF8C00"/><ellipse cx="12" cy="12" rx="5" ry="3.5" stroke="white" stroke-width="1.5"/><circle cx="12" cy="12" r="1.5" fill="white"/></svg>`,
  qwen_vision:   `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#e65c00"/><ellipse cx="12" cy="12" rx="5" ry="3.5" stroke="white" stroke-width="1.5"/><circle cx="12" cy="12" r="2" fill="white"/></svg>`,
  llama32_90b:   `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#7B2D8B"/><path d="M9 8v8M12 8v8M15 8v8" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M9 12h6" stroke="white" stroke-width="1.5"/></svg>`,
  command_a:     `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#2c3e50"/><path d="M9 8l5 4-5 4" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
  command_vision:`<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#34495e"/><ellipse cx="12" cy="12" rx="4" ry="3" stroke="white" stroke-width="1.5"/><circle cx="12" cy="12" r="1.2" fill="white"/></svg>`,
  command_reason:`<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#1a252f"/><path d="M8 10h8M8 14h5" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>`,
  moonshot:      `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#1a237e"/><path d="M15 8A6 6 0 009 8a6 6 0 000 8 6 6 0 006 0" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>`,
  glm47:         `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#6a1b9a"/><text x="12" y="16" text-anchor="middle" font-size="8" fill="white" font-weight="bold">GLM</text></svg>`,
  glm46:         `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#7b1fa2"/><text x="12" y="16" text-anchor="middle" font-size="8" fill="white" font-weight="bold">GLM</text></svg>`,
  c4ai_32b:      `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#e91e8c"/><path d="M8 12a4 4 0 108 0" stroke="white" stroke-width="1.8" stroke-linecap="round"/><circle cx="12" cy="8" r="1" fill="white"/></svg>`,
  c4ai_8b:       `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#c2185b"/><path d="M8 12a4 4 0 108 0" stroke="white" stroke-width="1.8" stroke-linecap="round"/><circle cx="12" cy="8" r="1" fill="white"/></svg>`,
  c4ai_vis32b:   `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#ad1457"/><path d="M8 12a4 4 0 108 0" stroke="white" stroke-width="1.5" stroke-linecap="round"/><ellipse cx="12" cy="12" rx="2" ry="1.5" fill="white"/></svg>`,
  c4ai_vis8b:    `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#880e4f"/><path d="M8 12a4 4 0 108 0" stroke="white" stroke-width="1.5" stroke-linecap="round"/><ellipse cx="12" cy="12" rx="2" ry="1.5" fill="white"/></svg>`,
  sonar:         `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#0369a1"/><circle cx="12" cy="12" r="2" fill="white"/><path d="M12 12 L18 6M12 12 L6 18" stroke="white" stroke-width="1.2" stroke-linecap="round"/></svg>`,
  sonar_pro:     `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#0284c7"/><circle cx="12" cy="12" r="2.5" fill="white"/><path d="M12 12 L18 6M12 12 L6 18M12 12 L18 18" stroke="white" stroke-width="1.2" stroke-linecap="round"/></svg>`,
  searchgpt:     `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#10a37f"/><circle cx="10" cy="10" r="3.5" stroke="white" stroke-width="1.5"/><path d="M13 13 L17 17" stroke="white" stroke-width="1.8" stroke-linecap="round"/></svg>`,
};

function getModelIcon(key) {
  return MODEL_ICONS[key] || `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#5b6ef5"/><text x="12" y="16" text-anchor="middle" font-size="10" fill="white">AI</text></svg>`;
}

// ‚îÄ‚îÄ –ú–æ–¥–µ–ª–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MODELS = [
  { key:"claude_sonnet", name:"Claude Sonnet 4.5", av:"av-claude", cat:"Claude", desc:"–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å ‚Äî —É–º–Ω–∞—è, –±—ã—Å—Ç—Ä–∞—è, –¥–µ—Ç–∞–ª—å–Ω–∞—è üì∏", vision:true },
  { key:"claude_haiku",  name:"Claude Haiku 4.5",  av:"av-claude", cat:"Claude", desc:"–°–∞–º–∞—è –±—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è Claude üì∏", vision:true },
  { key:"claude_opus",   name:"Claude Opus 4.5",   av:"av-claude", cat:"Claude", desc:"–¢–æ–ø–æ–≤–∞—è –º–æ–¥–µ–ª—å Anthropic ‚Äî –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ üì∏", vision:true },
  { key:"gpt52",         name:"GPT-5.2",           av:"av-gpt",    cat:"GPT",    desc:"–ù–æ–≤–µ–π—à–∞—è –º–æ–¥–µ–ª—å –æ—Ç OpenAI üì∏", vision:true },
  { key:"gpt52_chat",    name:"GPT-5.2 Chat",      av:"av-gpt",    cat:"GPT",    desc:"GPT-5.2 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤" },
  { key:"deepseek_v3",   name:"DeepSeek V3.2",     av:"av-deepseek",cat:"DeepSeek",desc:"–£–º–Ω–µ–π—à–∞—è –∫–∏—Ç–∞–π—Å–∫–∞—è –º–æ–¥–µ–ª—å ‚Äî –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç OpenAI o1" },
  { key:"deepseek_r1",   name:"DeepSeek R1",       av:"av-deepseek",cat:"DeepSeek",desc:"Reasoning-–º–æ–¥–µ–ª—å —Å —Ü–µ–ø–æ—á–∫–æ–π —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π" },
  { key:"deepseek_v3_sq",name:"DeepSeek V3",       av:"av-deepseek",cat:"DeepSeek",desc:"–°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è DeepSeek V3" },
  { key:"qwen3_max",     name:"Qwen3-Max",         av:"av-qwen",   cat:"Qwen",   desc:"–§–ª–∞–≥–º–∞–Ω—Å–∫–∞—è –º–æ–¥–µ–ª—å Alibaba ‚Äî –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è" },
  { key:"qwen3_vl",      name:"Qwen3-VL",          av:"av-qwen",   cat:"Qwen",   desc:"Vision –º–æ–¥–µ–ª—å ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è üì∏", vision:true },
  { key:"command_a",     name:"Command-A",         av:"av-command",cat:"Command", desc:"–ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å –æ—Ç Cohere" },
  { key:"command_vision",name:"Command Vision",    av:"av-command",cat:"Command", desc:"Command —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π üì∏", vision:true },
  { key:"command_reason",name:"Command Reasoning", av:"av-command",cat:"Command", desc:"–£–≥–ª—É–±–ª—ë–Ω–Ω–æ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á" },
  { key:"moonshot",      name:"Kimi K2",           av:"av-kimi",   cat:"Kimi",   desc:"–ú–æ–¥–µ–ª—å –æ—Ç Moonshot AI ‚Äî –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ" },
  { key:"glm47",         name:"GLM-4.7",           av:"av-glm",    cat:"GLM",    desc:"–ù–æ–≤–µ–π—à–∞—è –≤–µ—Ä—Å–∏—è GLM —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ–º" },
  { key:"c4ai_32b",      name:"C4AI Aya 32B",      av:"av-c4ai",   cat:"C4AI",   desc:"–ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –º–æ–¥–µ–ª—å ‚Äî 32B –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, 23 —è–∑—ã–∫–∞" },
  { key:"c4ai_8b",       name:"C4AI Aya 8B",       av:"av-c4ai",   cat:"C4AI",   desc:"–õ—ë–≥–∫–∞—è –∏ –±—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è Aya ‚Äî 8B –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤" },
  { key:"c4ai_vis32b",   name:"C4AI Vision 32B",   av:"av-c4ai",   cat:"C4AI",   desc:"Vision –≤–µ—Ä—Å–∏—è Aya 32B ‚Äî –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π üì∏", vision:true },
];

const CATS = ["–í—Å–µ", "Claude", "GPT", "DeepSeek", "Qwen", "Command", "Kimi", "GLM", "C4AI"];

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const params = new URLSearchParams(location.search);
let curModel   = params.get("model") || "claude_sonnet";
let sheetOpen  = false;
let catFilter  = "–í—Å–µ";
let searchQ    = "";
let pendingImgs = []; // [{file, b64, url}]
let messages   = [];   // [{role, content, imgUrl?}]
let isLoading  = false;

// –†–µ–∂–∏–º—ã –æ—Ç–≤–µ—Ç–∞
const MODES = {
  fast:   "‚ö°Ô∏è –ë—ã—Å—Ç—Ä–æ",
  simple: "üéì –ü—Ä–æ—Å—Ç–æ",
  dev:    "üíª –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫",
  deep:   "üß† –ì–ª—É–±–æ–∫–æ",
};
let curMode    = localStorage.getItem("huzaai_mode") || "fast";
let autoModel  = localStorage.getItem("huzaai_auto") === "true";
let curTheme   = localStorage.getItem("huzaai_theme") || "dark";

// –£—Ä–æ–≤–Ω–∏
const LEVELS = [
  [0,    "üå± –ù–æ–≤–∏—á–æ–∫"],
  [10,   "‚≠ê –ù–∞—á–∏–Ω–∞—é—â–∏–π"],
  [50,   "üî• –ê–∫—Ç–∏–≤–Ω—ã–π"],
  [150,  "üíé –û–ø—ã—Ç–Ω—ã–π"],
  [500,  "üèÜ –≠–∫—Å–ø–µ—Ä—Ç"],
  [1000, "üëë –ú–∞—Å—Ç–µ—Ä"],
];
function getUserLevel(req) {
  let name = LEVELS[0][1], next = LEVELS[1][0];
  for (let i = 0; i < LEVELS.length; i++) {
    if (req >= LEVELS[i][0]) { name = LEVELS[i][1]; next = LEVELS[i+1] ? LEVELS[i+1][0] : null; }
  }
  return { name, next };
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è)
let userStats = { requests: 0, generations: 0, joined: "", fast_left: 0, pro_left: 0, img_left: 0 };

// ‚îÄ‚îÄ API Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –ó–∞–º–µ–Ω–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π URL —Ç–≤–æ–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (–≥–¥–µ –∑–∞–ø—É—â–µ–Ω –±–æ—Ç)
// –ù–∞–ø—Ä–∏–º–µ—Ä: "https://yourserver.com" –∏–ª–∏ "http://1.2.3.4:8080"
const API_BASE = params.get("api") || window.TG_API_BASE || "http://localhost:8080";
// –ü–æ–ª—É—á–∞–µ–º uid –∏–∑ Telegram ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
let USER_ID = 0;
try {
  // –°–ø–æ—Å–æ–± 1: –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø
  if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
    USER_ID = tg.initDataUnsafe.user.id;
  }
  // –°–ø–æ—Å–æ–± 2: –ø–∞—Ä—Å–∏–º initData —Å—Ç—Ä–æ–∫—É
  if (!USER_ID && tg.initData) {
    const parsed = new URLSearchParams(tg.initData);
    const userStr = parsed.get("user");
    if (userStr) {
      const userObj = JSON.parse(decodeURIComponent(userStr));
      USER_ID = userObj.id || 0;
    }
  }
  // –°–ø–æ—Å–æ–± 3: –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–∫–æ–≥–¥–∞ –±–æ—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å ?uid=)
  if (!USER_ID) {
    USER_ID = parseInt(params.get("uid") || "0");
  }
} catch(e) {
  console.warn("USER_ID parse error:", e);
}
console.log("USER_ID:", USER_ID);

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
updateHeader();
renderCats();
renderModels();
initTheme();
initModes();

// Load limits from URL
const fl = params.get("fast_left"), pl = params.get("pro_left");
if (fl !== null || pl !== null) {
  document.getElementById("limitBar").style.display = "flex";
  document.getElementById("fastLeft").textContent = fl ?? "‚Äî";
  document.getElementById("proLeft").textContent  = pl ?? "‚Äî";
}

// ‚îÄ‚îÄ Suggestion chips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll(".sugg-chip").forEach(chip => {
  chip.addEventListener("click", () => {
    const input = document.getElementById("msgInput");
    input.value = chip.textContent.trim();
    input.dispatchEvent(new Event("input"));
    input.focus();
  });
});

// ‚îÄ‚îÄ Header model ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getModel(key) {
  return MODELS.find(m => m.key === key) || MODELS[0];
}
function updateHeader() {
  const m = getModel(curModel);
  const av = document.getElementById("hdrAvatar");
  av.className = `model-avatar ${m.av}`;
  av.innerHTML = getModelIcon(m.key);
  document.getElementById("hdrName").textContent = m.name;
  document.getElementById("hdrSub").textContent  = m.vision ? "üì∏ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ç–æ" : "–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å";

  const vh = document.getElementById("visionHint");
  const ab = document.getElementById("attachBtn");

  if (m.vision) {
    vh.style.display = "flex";
    ab.classList.add("vision-active");
    ab.title = "üì∏ –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ";
  } else {
    vh.style.display = "none";
    ab.classList.remove("vision-active");
    ab.title = "–≠—Ç–∞ –º–æ–¥–µ–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ";
  }
}

// ‚îÄ‚îÄ Sheet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("modelSelector").addEventListener("click", openSheet);
document.getElementById("sheetOverlay").addEventListener("click", closeSheet);

function openSheet() {
  sheetOpen = true;
  document.getElementById("sheetOverlay").classList.add("open");
  document.getElementById("sheet").classList.add("open");
  document.getElementById("searchInput").value = "";
  searchQ = ""; catFilter = "–í—Å–µ";
  renderCats(); renderModels();
}
function closeSheet() {
  sheetOpen = false;
  document.getElementById("sheetOverlay").classList.remove("open");
  document.getElementById("sheet").classList.remove("open");
}

function renderCats() {
  const wrap = document.getElementById("sheetCats");
  wrap.innerHTML = CATS.map(c =>
    `<div class="cat-pill${c===catFilter?" active":""}" onclick="setCat('${c}')">${c}</div>`
  ).join("");
}
function setCat(c) { catFilter = c; renderCats(); renderModels(); }

document.getElementById("searchInput").addEventListener("input", e => {
  searchQ = e.target.value.toLowerCase();
  if (searchQ) catFilter = "–í—Å–µ";
  renderCats(); renderModels();
});

function renderModels() {
  const list = document.getElementById("sheetList");
  let filtered = MODELS.filter(m => {
    const matchCat = catFilter === "–í—Å–µ" || m.cat === catFilter;
    const matchQ   = !searchQ || m.name.toLowerCase().includes(searchQ) || m.desc.toLowerCase().includes(searchQ);
    return matchCat && matchQ;
  });

  if (!filtered.length) {
    list.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text3)">üòî –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
    return;
  }

  let html = "";
  let lastCat = null;
  filtered.forEach(m => {
    if (catFilter === "–í—Å–µ" && !searchQ && m.cat !== lastCat) {
      html += `<div class="section-label">${m.cat}</div>`;
      lastCat = m.cat;
    }
    const sel = m.key === curModel;
    html += `
      <div class="model-row${sel?" selected":""}" onclick="selectModel('${m.key}')">
        <div class="row-avatar ${m.av}">${getModelIcon(m.key)}</div>
        <div class="row-info">
          <div class="row-name">${m.name}</div>
          <div class="row-desc">${m.desc}</div>
        </div>
        <div class="row-right">
          <div class="check"><svg width="10" height="10" viewBox="0 0 12 12"><path d="M2 6l3 3 5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></div>
          ${m.vision ? '<span class="vision-tag">üì∏ VISION</span>' : ''}
        </div>
      </div>`;
  });
  list.innerHTML = html;
}

function selectModel(key) {
  if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
  curModel = key;
  updateHeader();
  renderModels();
  closeSheet();
  // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –º–æ–¥–µ–ª—å –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ
  {
    // Mini app not opened via KeyboardButton ‚Äî just update UI
  }
  showToast(`‚úÖ ${getModel(key).name}`);
}

// ‚îÄ‚îÄ Clear chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("clearBtn").addEventListener("click", () => {
  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
  messages = [];
  pendingImgs = [];
  renderImgPreview();
  const area = document.getElementById("chatArea");
  area.innerHTML = document.querySelector(".empty-state") ? "" : "";
  // Re-create empty state
  area.innerHTML = `
    <div class="empty-state" id="emptyState">
      <div class="empty-icon">ü§ñ</div>
      <div class="empty-title">–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
      <div class="empty-sub">–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ</div>
      <div class="suggestions" id="suggestions">
        <div class="sugg-chip">–û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</div>
        <div class="sugg-chip">–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–ø–∏—Å–∫–∞</div>
        <div class="sugg-chip">–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π</div>
        <div class="sugg-chip">–ü—Ä–∏–¥—É–º–∞–π –∏–¥–µ–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –≤ 2025</div>
      </div>
    </div>`;
  document.querySelectorAll(".sugg-chip").forEach(chip => {
    chip.addEventListener("click", () => {
      const input = document.getElementById("msgInput");
      input.value = chip.textContent.trim();
      input.dispatchEvent(new Event("input"));
      input.focus();
    });
  });
  showToast("üóë –ß–∞—Ç –æ—á–∏—â–µ–Ω");
});

// ‚îÄ‚îÄ Input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const msgInput = document.getElementById("msgInput");
msgInput.addEventListener("input", () => {
  msgInput.style.height = "auto";
  msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + "px";
  updateSendBtn();
});
msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function updateSendBtn() {
  const hasText = msgInput.value.trim().length > 0;
  const hasImg  = pendingImgs.length > 0;
  document.getElementById("sendBtn").disabled = (!hasText && !hasImg) || isLoading;
}

// ‚îÄ‚îÄ File attach ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("attachBtn").addEventListener("click", () => {
  const m = getModel(curModel);
  if (!m.vision) {
    // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º
    showToast("üí° –°–º–µ–Ω–∏ –º–æ–¥–µ–ª—å –Ω–∞ Claude/GPT-5.2 –¥–ª—è –ª—É—á—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ");
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ claude_sonnet (vision –º–æ–¥–µ–ª—å)
    curModel = "claude_sonnet";
    updateHeader();
    renderModels();
  }
  document.getElementById("fileInput").click();
});

document.getElementById("fileInput").addEventListener("change", e => {
  const files = Array.from(e.target.files || []);
  files.forEach(file => {
    if (!file.type.startsWith("image/")) return;
    compressImage(file).then(({ b64, url }) => {
      pendingImgs.push({ file, b64, url });
      renderImgPreview();
      updateSendBtn();
    });
  });
  e.target.value = "";
});

// –°–∂–∏–º–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ –º–∞–∫—Å. 1024px –∏ JPEG –∫–∞—á–µ—Å—Ç–≤–æ 75%
function compressImage(file, maxSize = 1024, quality = 0.75) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        let w = img.width, h = img.height;
        // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –µ—Å–ª–∏ –±–æ–ª—å—à–µ maxSize
        if (w > maxSize || h > maxSize) {
          if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
          else       { w = Math.round(w * maxSize / h); h = maxSize; }
        }
        const canvas = document.createElement("canvas");
        canvas.width = w; canvas.height = h;
        canvas.getContext("2d").drawImage(img, 0, 0, w, h);
        const url = canvas.toDataURL("image/jpeg", quality);
        const b64 = url.split(",")[1];
        resolve({ b64, url });
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function renderImgPreview() {
  const wrap = document.getElementById("imgPreview");
  if (!pendingImgs.length) { wrap.style.display = "none"; wrap.innerHTML = ""; return; }
  wrap.style.display = "flex";
  wrap.innerHTML = pendingImgs.map((img, i) => `
    <div class="preview-thumb">
      <img src="${img.url}" alt="—Ñ–æ—Ç–æ">
      <div class="preview-rm" onclick="removeImg(${i})">√ó</div>
    </div>`).join("");
}
function removeImg(i) {
  pendingImgs.splice(i, 1);
  renderImgPreview();
  updateSendBtn();
}

// ‚îÄ‚îÄ Send ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("sendBtn").addEventListener("click", sendMessage);

async function sendMessage() {
  if (isLoading) return;
  const text = msgInput.value.trim();
  const imgs  = [...pendingImgs];
  if (!text && !imgs.length) return;

  hideEmpty();
  isLoading = true;
  updateSendBtn();

  // Add user message to UI
  const imgUrls = imgs.map(i => i.url);
  addUserMsg(text, imgUrls);

  // Clear input
  msgInput.value = "";
  msgInput.style.height = "auto";
  pendingImgs = [];
  renderImgPreview();

  // Add think timer
  const timerId = addThinkTimer();

  // Store user message in history
  messages.push({ role: "user", content: text || (imgs.length ? "[–§–æ—Ç–æ]" : ""), imgUrls });

  // Build history for bot (last 10 messages)
  const historyForBot = messages.slice(-10).map(m => ({
    role: m.role,
    content: m.content
  }));

  // –ï—Å–ª–∏ –∞–≤—Ç–æ-—Ä–µ–∂–∏–º ‚Äî —Å–æ–æ–±—â–∞–µ–º —Å–µ—Ä–≤–µ—Ä—É (–±–æ—Ç —Å–∞–º –≤—ã–±–µ—Ä–µ—Ç –º–æ–¥–µ–ª—å)
  const effectiveModel = autoModel ? "__auto__" : curModel;

  const payload = {
    action: "chat",
    uid:    USER_ID,
    model:  effectiveModel,
    text:   text || "",
    images: imgs.map(i => i.b64),
    history: historyForBot,
    answer_mode: curMode,
  };

  try {
    const resp = await fetch(`${API_BASE}/api/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await resp.json();
    removeThinkTimer(timerId);

    if (data.ok) {
      // –ê–≤—Ç–æ-–º–æ–¥–µ–ª—å: –æ–±–Ω–æ–≤–ª—è–µ–º –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –¥—Ä—É–≥—É—é
      if (autoModel && data.used_model) {
        addAutoModelBadge(data.used_model);
      }
      addAiMsg(data.answer, data.model_label);
      // Update limits display + userStats
      if (data.fast_left !== undefined) {
        document.getElementById("limitBar").style.display = "flex";
        document.getElementById("fastLeft").textContent = data.fast_left;
        document.getElementById("proLeft").textContent  = data.pro_left;
        userStats.fast_left = data.fast_left;
        userStats.pro_left  = data.pro_left;
        userStats.requests  = (userStats.requests || 0) + 1;
      }
    } else if (data.error === "subscription_required") {
      // Show subscription required
      let chText = "\n\n–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª—ã:\n";
      (data.channels || []).forEach(ch => { chText += `‚Ä¢ ${ch.title}\n`; });
      addAiMsg("üîê –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –Ω—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª!" + chText);
    } else if (data.error === "limit_exceeded") {
      addAiMsg(`üö´ –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω!\n‚è∞ –°–±—Ä–æ—Å —á–µ—Ä–µ–∑: ${data.reset_in || "?"}\n\n–û—Å—Ç–∞–ª–æ—Å—å: ‚ö°${data.fast_left} –±—ã—Å—Ç—Ä—ã—Ö | üß†${data.pro_left} –ø—Ä–æ—Ñ.`);
    } else {
      addAiMsg(`‚ùå –û—à–∏–±–∫–∞: ${data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`);
    }
  } catch(e) {
    removeThinkTimer(timerId);
    addAiMsg("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.\n\nüí° –ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –Ω–∞–ø—Ä—è–º—É—é –≤ —á–∞—Ç –±–æ—Ç–∞ ‚Äî –æ–Ω –æ—Ç–≤–µ—Ç–∏—Ç —Ç–∞–º.");
  }

  isLoading = false;
  updateSendBtn();
}

// ‚îÄ‚îÄ –û—Ç–≤–µ—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ fetch() ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ DOM helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function hideEmpty() {
  const e = document.getElementById("emptyState");
  if (e) e.remove();
}

function addUserMsg(text, imgUrls) {
  const area = document.getElementById("chatArea");
  const div = document.createElement("div");
  div.className = "msg user";

  let imgsHtml = "";
  if (imgUrls && imgUrls.length) {
    // –ù–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ ‚Äî —Å–µ—Ç–∫–∞, –æ–¥–Ω–æ —Ñ–æ—Ç–æ ‚Äî –∫—Ä—É–ø–Ω–µ–µ
    if (imgUrls.length === 1) {
      imgsHtml = `<img class="msg-img" src="${imgUrls[0]}" alt="—Ñ–æ—Ç–æ" style="max-width:220px;border-radius:12px;display:block;margin-bottom:${text?'6px':'0'}">`;
    } else {
      imgsHtml = `<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:${text?'6px':'0'}">` +
        imgUrls.map(u => `<img src="${u}" alt="—Ñ–æ—Ç–æ" style="width:100px;height:100px;object-fit:cover;border-radius:10px;">`).join("") +
        `</div>`;
    }
  }

  div.innerHTML = `
    ${imgsHtml}
    ${text ? `<div class="bubble">${escHtmlBr(text)}</div>` : ""}
    <div class="msg-meta">–í—ã ¬∑ ${timeNow()}</div>`;
  area.appendChild(div);
  scrollBottom();
}

function addAutoModelBadge(modelLabel) {
  const area = document.getElementById("chatArea");
  const div = document.createElement("div");
  div.className = "msg ai";
  div.innerHTML = `<div class="auto-model-badge">ü§ñ AI –≤—ã–±—Ä–∞–ª: ${escHtml(modelLabel)}</div>`;
  area.appendChild(div);
}

function addAiMsg(text, modelLabel) {
  const area = document.getElementById("chatArea");
  const m = getModel(curModel);
  const displayName = modelLabel || m.name;
  const div = document.createElement("div");
  div.className = "msg ai";
  div.innerHTML = `
    <div class="ai-label">
      <div class="ai-dot ${m.av}">${getModelIcon(m.key)}</div>
      ${escHtml(displayName)}
    </div>
    <div class="bubble">${formatText(text)}</div>
    <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin-top:2px">
      <div class="msg-meta" style="margin:0">${escHtml(displayName)} ¬∑ ${timeNow()}</div>
      <button class="copy-answer-btn" onclick="copyAnswer(this)">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>`;
  area.appendChild(div);
  messages.push({ role: "assistant", content: text });
  scheduleHistorySave();
  scrollBottom();
  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–¥–∞ highlight.js
  div.querySelectorAll("pre code").forEach(block => {
    hljs.highlightElement(block);
  });
  // –†–µ–Ω–¥–µ—Ä LaTeX —Ñ–æ—Ä–º—É–ª KaTeX
  try {
    renderMathInElement(div, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\(", right: "\\)", display: false},
        {left: "\\[", right: "\\]", display: true}
      ],
      throwOnError: false
    });
  } catch(e) {}
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
  div.querySelectorAll(".copy-btn").forEach(btn => {
    btn.textContent = "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å";
  });
}

let timerCounter = 0;
let timerIntervals = {};

function addThinkTimer() {
  const id = ++timerCounter;
  const area = document.getElementById("chatArea");
  const div = document.createElement("div");
  div.className = "msg ai";
  div.id = `timer-${id}`;
  div.innerHTML = `
    <div class="bubble">
      <div class="think-timer">
        <span class="timer-icon">üîç</span>
        <span class="timer-label" id="label-${id}">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–∞–ø—Ä–æ—Å</span>
        <span class="timer-secs" id="secs-${id}">0</span>
        <span style="color:var(--text3);font-size:12px">—Å–µ–∫</span>
      </div>
    </div>`;
  area.appendChild(div);
  scrollBottom();
  let secs = 0;
  const phases = [
    {at:0,  icon:"üîç", text:"–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–∞–ø—Ä–æ—Å"},
    {at:3,  icon:"üß†", text:"–†–∞–∑–º—ã—à–ª—è—é"},
    {at:8,  icon:"üí°", text:"–§–æ—Ä–º–∏—Ä—É—é –æ—Ç–≤–µ—Ç"},
    {at:15, icon:"‚ö°", text:"–û—Ç–≤–µ—Ç –ø–æ—á—Ç–∏ –≥–æ—Ç–æ–≤"},
  ];
  timerIntervals[id] = setInterval(() => {
    secs++;
    const secsEl  = document.getElementById(`secs-${id}`);
    const labelEl = document.getElementById(`label-${id}`);
    const iconEl  = div.querySelector(".timer-icon");
    if (secsEl) secsEl.textContent = secs;
    if (labelEl && iconEl) {
      let cur = phases[0];
      for (const p of phases) { if (secs >= p.at) cur = p; }
      labelEl.textContent = cur.text;
      iconEl.textContent  = cur.icon;
    }
  }, 1000);
  return id;
}

function removeThinkTimer(id) {
  clearInterval(timerIntervals[id]);
  delete timerIntervals[id];
  const el = document.getElementById(`timer-${id}`);
  if (el) el.remove();
}

function scrollBottom() {
  const area = document.getElementById("chatArea");
  area.scrollTop = area.scrollHeight;
}

function escHtml(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

// –û—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Å –∑–∞–º–µ–Ω–æ–π –ø–µ—Ä–µ–Ω–æ—Å–æ–≤ –Ω–∞ <br>
function escHtmlBr(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");
}

function formatText(rawText) {
  let text = rawText;

  // 1. Code blocks ‚Äî —Å–Ω–∞—á–∞–ª–∞ –≤—ã—Ä–µ–∑–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞–º–∏
  let codeIdx = 0;
  const codePlaceholders = {};
  text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
    const id = "\x00CODE_" + (codeIdx++) + "\x00";
    const rawCode = code.trim();
    const escapedCode = escHtml(rawCode); // –ë–ï–ó –∑–∞–º–µ–Ω—ã \n ‚Äî –Ω—É–∂–Ω—ã —Ä–µ–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫!
    const langLabel = lang ? lang.toUpperCase() : "CODE";
    // –ö–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    codePlaceholders[id] = `<div class="code-wrapper">
      <div class="code-header">
        <span>${langLabel}</span>
        <button class="copy-btn" onclick="copyCode(this)">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <pre><code class="${lang ? 'language-' + lang : ''}" data-raw="${escHtml(rawCode).replace(/"/g,'&quot;')}">${escapedCode}</code></pre>
    </div>`;
    return id;
  });

  // 2. Tables
  text = text.replace(/\n?((?:\|.+\|\n?)+)/g, (match) => {
    const lines = match.trim().split("\n").filter(l => l.trim());
    if (lines.length < 2) return match;
    const isSep = l => /^[\|\s\-:]+$/.test(l);
    let html = '<div class="table-wrap"><table>';
    let firstRow = true;
    for (const line of lines) {
      if (isSep(line)) continue;
      const cells = line.split("|").filter((_, i, a) => i > 0 && i < a.length - 1);
      if (firstRow) {
        html += '<tr>' + cells.map(c => `<th>${c.trim()}</th>`).join('') + '</tr>';
        firstRow = false;
      } else {
        html += '<tr>' + cells.map(c => `<td>${c.trim()}</td>`).join('') + '</tr>';
      }
    }
    html += '</table></div>';
    return html;
  });

  // 3. Bold, italic
  text = text.replace(/\*\*\*(.+?)\*\*\*/g, "<strong><em>$1</em></strong>");
  text = text.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
  text = text.replace(/\*(.+?)\*/g, "<em>$1</em>");

  // 4. Headers
  text = text.replace(/^###\s+(.+)$/gm, "<h4>$1</h4>");
  text = text.replace(/^##\s+(.+)$/gm, "<h3>$1</h3>");
  text = text.replace(/^#\s+(.+)$/gm, "<h2>$1</h2>");

  // 5. Lists
  text = text.replace(/^[-*]\s+(.+)$/gm, "<li>$1</li>");
  text = text.replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>");

  // 6. Inline code
  text = text.replace(/`([^`\n]+)`/g, (_, c) => `<code>${escHtml(c)}</code>`);

  // 7. Newlines ‚Üí <br> (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –Ω–µ –∫–æ–¥–∞)
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–ª–æ—á–Ω—ã–µ LaTeX —Ñ–æ—Ä–º—É–ª—ã ($$...$$) –æ—Ç –∑–∞–º–µ–Ω—ã \n ‚Üí <br>
  const latexPlaceholders = {};
  let latexIdx = 0;
  text = text.replace(/\$\$([\s\S]+?)\$\$/g, (match) => {
    const pid = "\x00LATEX_" + (latexIdx++) + "\x00";
    latexPlaceholders[pid] = match;
    return pid;
  });
  text = text.replace(/\n/g, "<br>");
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º LaTeX –±–ª–æ–∫–∏
  for (const [pid, orig] of Object.entries(latexPlaceholders)) {
    text = text.split(pid).join(orig);
  }

  // 8. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º code-–±–ª–æ–∫–∏ (–ø–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã \n)
  for (const [id, html] of Object.entries(codePlaceholders)) {
    text = text.split(id).join(html);
  }

  return text;
}

function copyAnswer(btn) {
  // –ù–∞—Ö–æ–¥–∏–º bubble ‚Äî —Å–ª–µ–¥—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ–¥ –∫–Ω–æ–ø–∫–æ–π
  const msgDiv = btn.closest(".msg.ai");
  const bubble = msgDiv ? msgDiv.querySelector(".bubble") : null;
  const rawText = bubble ? bubble.innerText : "";
  navigator.clipboard.writeText(rawText).then(() => {
    btn.textContent = "‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
    btn.classList.add("copied");
    setTimeout(() => { btn.textContent = "üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"; btn.classList.remove("copied"); }, 2000);
  }).catch(() => {});
}

function copyCode(btn) {
  const codeEl = btn.closest(".code-wrapper").querySelector("code");
  // –ë–µ—Ä—ë–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ data-raw, –∏–ª–∏ innerText –∫–∞–∫ fallback
  const raw = codeEl ? (codeEl.getAttribute("data-raw") || codeEl.innerText) : "";
  // Decode HTML entities
  const decoded = raw.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"');
  navigator.clipboard.writeText(decoded).then(() => {
    btn.textContent = "‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
    btn.classList.add("copied");
    setTimeout(() => { btn.textContent = "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"; btn.classList.remove("copied"); }, 2000);
  }).catch(() => {
    btn.textContent = "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å";
  });
}

function timeNow() {
  const d = new Date();
  return d.getHours().toString().padStart(2,"0") + ":" + d.getMinutes().toString().padStart(2,"0");
}

function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

// ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if (USER_ID) {
  fetch(`${API_BASE}/api/limits?uid=${USER_ID}`)
    .then(r => r.json())
    .then(d => {
      if (d.ok) {
        document.getElementById("limitBar").style.display = "flex";
        document.getElementById("fastLeft").textContent = d.fast_left;
        document.getElementById("proLeft").textContent  = d.pro_left;
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –ø—Ä–æ—Ñ–∏–ª—è
        userStats.fast_left   = d.fast_left  ?? 0;
        userStats.pro_left    = d.pro_left   ?? 0;
        userStats.img_left    = d.img_left   ?? 0;
        userStats.requests    = d.requests   ?? 0;
        userStats.generations = d.img_used   ?? 0;
        userStats.joined      = d.joined     || "";
      }
    })
    .catch(() => {});
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìã –ò–°–¢–û–†–ò–Ø –ß–ê–¢–û–í (—Ö—Ä–∞–Ω–∏—Ç—Å—è 24 —á–∞—Å–∞ –≤ localStorage)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const HISTORY_KEY = "huzaai_chat_history";
const HISTORY_TTL = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞ –≤ –º—Å

function saveCurrentSession() {
  if (!messages.length) return;
  try {
    const stored = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ (>24—á)
    const now = Date.now();
    const fresh = stored.filter(s => (now - s.ts) < HISTORY_TTL);
    // –ò—â–µ–º —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é –ø–æ sessionId
    const idx = fresh.findIndex(s => s.id === currentSessionId);
    const session = {
      id: currentSessionId,
      ts: now,
      model: curModel,
      modelName: getModel(curModel).name,
      messages: messages.slice(-30), // —Ö—Ä–∞–Ω–∏–º –¥–æ 30 —Å–æ–æ–±—â–µ–Ω–∏–π
      title: messages[0]?.content?.slice(0, 60) || "–ß–∞—Ç"
    };
    if (idx >= 0) fresh[idx] = session;
    else fresh.unshift(session);
    // –•—Ä–∞–Ω–∏–º –Ω–µ –±–æ–ª—å—à–µ 20 —Å–µ—Å—Å–∏–π
    localStorage.setItem(HISTORY_KEY, JSON.stringify(fresh.slice(0, 20)));
  } catch(e) { console.warn("history save:", e); }
}

function loadHistory() {
  try {
    const stored = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
    const now = Date.now();
    return stored.filter(s => (now - s.ts) < HISTORY_TTL);
  } catch(e) { return []; }
}

function renderHistoryPanel() {
  const list = document.getElementById("historyList");
  const sessions = loadHistory();
  if (!sessions.length) {
    list.innerHTML = `<div class="history-empty">üò¥ –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞<br><br>–¢–≤–æ–∏ —á–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å<br>–∏ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è 24 —á–∞—Å–∞</div>`;
    return;
  }
  list.innerHTML = sessions.map(s => {
    const age = Date.now() - s.ts;
    const h = Math.floor(age / 3600000);
    const m = Math.floor((age % 3600000) / 60000);
    const timeAgo = h > 0 ? `${h}—á –Ω–∞–∑–∞–¥` : m > 0 ? `${m}–º–∏–Ω –Ω–∞–∑–∞–¥` : "—Ç–æ–ª—å–∫–æ —á—Ç–æ";
    const msgCount = s.messages?.length || 0;
    const preview = s.messages?.find(m => m.role === "assistant")?.content?.slice(0, 80) || "";
    const isCurrent = s.id === currentSessionId;
    return `<div class="history-item${isCurrent ? ' selected' : ''}" onclick="restoreSession('${s.id}')">
      <div class="history-item-title">${escHtml(s.title)}</div>
      <div class="history-item-preview">${escHtml(preview)}</div>
      <div class="history-item-meta">
        <span>${timeAgo}</span>
        <span>${msgCount} —Å–æ–æ–±—â.</span>
        <span class="history-item-model">${escHtml(s.modelName || s.model)}</span>
        ${isCurrent ? '<span style="color:var(--green);font-weight:700">‚óè —Ç–µ–∫—É—â–∏–π</span>' : ''}
      </div>
    </div>`;
  }).join('');
}

function restoreSession(id) {
  const sessions = loadHistory();
  const s = sessions.find(x => x.id === id);
  if (!s) return;
  closeHistory();
  // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Ç
  messages = [];
  const area = document.getElementById("chatArea");
  area.innerHTML = '';
  // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
  currentSessionId = s.id;
  curModel = s.model || curModel;
  updateHeader();
  if (!s.messages || !s.messages.length) {
    area.innerHTML = `<div class="empty-state" id="emptyState"><div class="empty-icon">üí¨</div><div class="empty-title">–ß–∞—Ç –ø—É—Å—Ç</div><div class="empty-sub">–≠—Ç–æ—Ç —á–∞—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div></div>`;
    showToast("‚ö†Ô∏è –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —ç—Ç–æ–º —á–∞—Ç–µ");
    return;
  }
  s.messages.forEach(msg => {
    if (msg.role === "user") {
      addUserMsg(msg.content || "", msg.imgUrls || []);
    } else if (msg.role === "assistant") {
      addAiMsg(msg.content || "");
    }
  });
  messages = [...s.messages];
  showToast("‚úÖ –ß–∞—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!");
}

function openHistory() {
  saveCurrentSession();
  renderHistoryPanel();
  document.getElementById("historyOverlay").classList.add("open");
  document.getElementById("historyPanel").classList.add("open");
}
function closeHistory() {
  document.getElementById("historyOverlay").classList.remove("open");
  document.getElementById("historyPanel").classList.remove("open");
}

function startNewChat() {
  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
  saveCurrentSession();
  messages = [];
  pendingImgs = [];
  renderImgPreview();
  const area = document.getElementById("chatArea");
  area.innerHTML = `
    <div class="empty-state" id="emptyState">
      <div class="empty-icon">ü§ñ</div>
      <div class="empty-title">–ù–æ–≤—ã–π —á–∞—Ç</div>
      <div class="empty-sub">–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ</div>
      <div class="suggestions" id="suggestions">
        <div class="sugg-chip">–û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</div>
        <div class="sugg-chip">–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–ø–∏—Å–∫–∞</div>
        <div class="sugg-chip">–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π</div>
        <div class="sugg-chip">–ü—Ä–∏–¥—É–º–∞–π –∏–¥–µ–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –≤ 2025</div>
      </div>
    </div>`;
  document.querySelectorAll(".sugg-chip").forEach(chip => {
    chip.addEventListener("click", () => {
      const input = document.getElementById("msgInput");
      input.value = chip.textContent.trim();
      input.dispatchEvent(new Event("input"));
      input.focus();
    });
  });
  // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π ID —Å–µ—Å—Å–∏–∏
  currentSessionId = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
  showToast("‚úèÔ∏è –ù–æ–≤—ã–π —á–∞—Ç –Ω–∞—á–∞—Ç");
}

document.getElementById("historyBtn").addEventListener("click", openHistory);
document.getElementById("historyClose").addEventListener("click", closeHistory);
document.getElementById("historyOverlay").addEventListener("click", closeHistory);
document.getElementById("historyNewChat").addEventListener("click", () => {
  closeHistory();
  startNewChat();
});
document.getElementById("newChatBtn").addEventListener("click", startNewChat);
document.getElementById("historyClearBtn").addEventListener("click", () => {
  if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–æ–≤?")) {
    localStorage.removeItem(HISTORY_KEY);
    renderHistoryPanel();
    showToast("üóë –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞");
  }
});

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–µ—Å—Å–∏–∏
let currentSessionId = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ò–ò
const _origAddAiMsg = addAiMsg;
// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é —á–µ—Ä–µ–∑ 2 —Å–µ–∫ –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
function scheduleHistorySave() {
  clearTimeout(window._historySaveTimer);
  window._historySaveTimer = setTimeout(saveCurrentSession, 2000);
}

// ‚îÄ‚îÄ –¢–ï–ú–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initTheme() {
  applyTheme(curTheme);
}
function applyTheme(theme) {
  curTheme = theme;
  document.body.classList.toggle("light", theme === "light");
  localStorage.setItem("huzaai_theme", theme);
  // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å –æ—Ç–∫—Ä—ã—Ç ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ç–µ–º—ã
  const btns = document.querySelectorAll(".theme-btn");
  btns.forEach(b => b.classList.toggle("active", b.dataset.theme === theme));
}

// ‚îÄ‚îÄ –†–ï–ñ–ò–ú–´ –û–¢–í–ï–¢–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initModes() {
  renderModeBar();
  renderAutoPill();
}
function renderModeBar() {
  Object.keys(MODES).forEach(m => {
    const el = document.getElementById("mode-" + m);
    if (el) el.classList.toggle("active", m === curMode);
  });
}
function setMode(mode) {
  curMode = mode;
  localStorage.setItem("huzaai_mode", mode);
  renderModeBar();
  showToast("üéõ " + MODES[mode]);
  if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
}
function renderAutoPill() {
  const el = document.getElementById("autoPill");
  if (!el) return;
  el.classList.toggle("active", autoModel);
  el.textContent = autoModel ? "ü§ñ –ê–≤—Ç–æ ‚úÖ" : "ü§ñ –ê–≤—Ç–æ";
}
function toggleAutoModel() {
  autoModel = !autoModel;
  localStorage.setItem("huzaai_auto", autoModel);
  renderAutoPill();
  showToast(autoModel ? "ü§ñ AI –≤—ã–±–∏—Ä–∞–µ—Ç –º–æ–¥–µ–ª—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" : "ü§ñ –ê–≤—Ç–æ-—Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω");
  if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
}

// ‚îÄ‚îÄ –ü–†–û–§–ò–õ–¨ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("profileBtn").addEventListener("click", openProfile);

function openProfile() {
  renderProfileSheet();
  document.getElementById("profileOverlay").classList.add("open");
  document.getElementById("profileSheet").classList.add("open");
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–µ–∂–∏–µ –ª–∏–º–∏—Ç—ã
  if (USER_ID) {
    fetch(`${API_BASE}/api/limits?uid=${USER_ID}`)
      .then(r => r.json())
      .then(d => {
        if (d.ok) {
          userStats.fast_left = d.fast_left ?? 0;
          userStats.pro_left  = d.pro_left  ?? 0;
          userStats.img_left  = d.img_left  ?? 0;
          userStats.requests  = d.requests  ?? userStats.requests;
          userStats.generations = d.img_used ?? userStats.generations;
          userStats.joined    = d.joined    || userStats.joined;
          renderProfileSheet();
        }
      }).catch(() => {});
  }
}
function closeProfile() {
  document.getElementById("profileOverlay").classList.remove("open");
  document.getElementById("profileSheet").classList.remove("open");
}

function renderProfileSheet() {
  const req = userStats.requests || 0;
  const { name: levelName, next } = getUserLevel(req);
  const pct = next ? Math.round((req / next) * 100) : 100;

  const body = document.getElementById("profileBody");
  body.innerHTML = `
    <!-- –£—Ä–æ–≤–µ–Ω—å -->
    <div class="p-card">
      <div class="p-card-title">üèÖ –£—Ä–æ–≤–µ–Ω—å</div>
      <div class="level-badge">${levelName}</div>
      <div style="font-size:12px;color:var(--text3);margin-top:4px">
        ${next ? \`–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ: \${next - req} –∑–∞–ø—Ä–æ—Å–æ–≤\` : "üëë –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å!"}
      </div>
      <div class="level-progress"><div class="level-progress-fill" style="width:\${pct}%"></div></div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="p-card">
      <div class="p-card-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
      <div class="stat-grid">
        <div class="stat-cell">
          <div class="stat-cell-val">\${userStats.requests}</div>
          <div class="stat-cell-lbl">–ó–∞–ø—Ä–æ—Å–æ–≤</div>
        </div>
        <div class="stat-cell">
          <div class="stat-cell-val">\${userStats.generations}</div>
          <div class="stat-cell-lbl">–ì–µ–Ω–µ—Ä–∞—Ü–∏–π</div>
        </div>
        <div class="stat-cell">
          <div class="stat-cell-val">\${messages.filter(m=>m.role==="assistant").length}</div>
          <div class="stat-cell-lbl">–í —á–∞—Ç–µ</div>
        </div>
      </div>
      \${userStats.joined ? \`<div style="font-size:11px;color:var(--text3);margin-top:8px;text-align:center">üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: \${userStats.joined}</div>\` : ""}
    </div>

    <!-- –õ–∏–º–∏—Ç—ã -->
    <div class="p-card">
      <div class="p-card-title">üí≥ –ë–∞–ª–∞–Ω—Å –ª–∏–º–∏—Ç–æ–≤</div>
      <div class="limit-row">
        <span>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã</span>
        <span class="limit-val" style="color:var(--green)">\${userStats.fast_left}</span>
      </div>
      <div class="limit-row">
        <span>üß† –ü—Ä–æ—Ñ. –∑–∞–ø—Ä–æ—Å—ã</span>
        <span class="limit-val" style="color:var(--accent2)">\${userStats.pro_left}</span>
      </div>
      <div class="limit-row">
        <span>üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏</span>
        <span class="limit-val" style="color:var(--yellow)">\${userStats.img_left}</span>
      </div>
    </div>

    <!-- –†–µ–∂–∏–º –æ—Ç–≤–µ—Ç–∞ -->
    <div class="p-card">
      <div class="p-card-title">üéõ –†–µ–∂–∏–º –æ—Ç–≤–µ—Ç–∞</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px">
        \${Object.entries(MODES).map(([k,v]) => \`
          <div class="mode-pill\${curMode===k?" active":""}" onclick="setMode('\${k}');renderProfileSheet()" style="font-size:13px;padding:7px 13px">\${v}</div>
        \`).join("")}
      </div>
      <div class="auto-pill\${autoModel?" active":""}" onclick="toggleAutoModel();renderProfileSheet()" style="display:inline-flex;font-size:13px;padding:7px 13px">
        ü§ñ –ê–≤—Ç–æ-–≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ \${autoModel ? "‚úÖ" : "‚ùå"}
      </div>
    </div>

    <!-- –¢–µ–º–∞ -->
    <div class="p-card">
      <div class="p-card-title">üé® –¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
      <div class="theme-toggle">
        <div class="theme-btn\${curTheme==="dark"?" active":""}" data-theme="dark" onclick="applyTheme('dark');renderProfileSheet()">üåô –¢—ë–º–Ω–∞—è</div>
        <div class="theme-btn\${curTheme==="light"?" active":""}" data-theme="light" onclick="applyTheme('light');renderProfileSheet()">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</div>
      </div>
    </div>
  `;
}

// ‚îÄ‚îÄ tg theme ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
tg.onEvent("themeChanged", () => {});
</script>
</body>
</html>
