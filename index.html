<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–•—É–∑–∞ –ò–ò</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<!-- highlight.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<!-- KaTeX -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<style>
:root {
  --bg: #0c0c14;
  --surface: #13131f;
  --surface2: #1a1a2e;
  --surface3: #222238;
  --border: rgba(255,255,255,0.06);
  --border2: rgba(255,255,255,0.12);
  --text: #eeeeff;
  --text2: rgba(238,238,255,0.55);
  --text3: rgba(238,238,255,0.28);
  --accent: #6366f1;
  --accent2: #818cf8;
  --accent-glow: rgba(99,102,241,0.2);
  --user-bubble: #1e2060;
  --user-border: rgba(99,102,241,0.35);
  --green: #34d399;
  --red: #f87171;
  --yellow: #fbbf24;
  --code-bg: #1a1b26;
}

- { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
font-family: ‚ÄòInter‚Äô, sans-serif;
background: var(‚Äìbg);
color: var(‚Äìtext);
height: 100dvh;
display: flex;
flex-direction: column;
overflow: hidden;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
display: flex;
align-items: center;
padding: 8px 12px;
background: var(‚Äìsurface);
border-bottom: 1px solid var(‚Äìborder);
gap: 8px;
flex-shrink: 0;
z-index: 10;
}

.model-selector {
display: flex;
align-items: center;
gap: 8px;
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder2);
border-radius: 20px;
padding: 6px 12px 6px 8px;
cursor: pointer;
flex: 1;
transition: all 0.15s;
min-width: 0;
}
.model-selector:active { opacity: 0.8; transform: scale(0.98); }

.model-avatar {
width: 26px; height: 26px;
border-radius: 7px;
display: flex; align-items: center; justify-content: center;
font-size: 13px;
flex-shrink: 0;
overflow: hidden;
}
.model-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 7px; }

.model-selector-info { flex: 1; min-width: 0; }
.model-selector-name {
font-size: 13px; font-weight: 600;
white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.model-selector-sub { font-size: 10px; color: var(‚Äìtext3); margin-top: 1px; }
.chevron { color: var(‚Äìtext3); font-size: 9px; flex-shrink: 0; }

.header-actions { display: flex; gap: 5px; flex-shrink: 0; }
.header-btn {
width: 34px; height: 34px;
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder);
border-radius: 10px;
display: flex; align-items: center; justify-content: center;
cursor: pointer; color: var(‚Äìtext2);
transition: all 0.15s;
font-size: 15px;
position: relative;
}
.header-btn:active { opacity: 0.7; transform: scale(0.95); }

/* ‚îÄ‚îÄ HISTORY SIDEBAR ‚îÄ‚îÄ */
.sidebar-overlay {
position: fixed; inset: 0;
background: rgba(0,0,0,0.6);
z-index: 200;
opacity: 0; pointer-events: none;
transition: opacity 0.25s;
}
.sidebar-overlay.open { opacity: 1; pointer-events: all; }

.sidebar {
position: fixed; top: 0; right: 0; bottom: 0;
width: 280px;
background: var(‚Äìsurface);
border-left: 1px solid var(‚Äìborder2);
z-index: 201;
display: flex; flex-direction: column;
transform: translateX(100%);
transition: transform 0.3s cubic-bezier(0.32,0.72,0,1);
}
.sidebar.open { transform: translateX(0); }

.sidebar-header {
padding: 14px 16px;
border-bottom: 1px solid var(‚Äìborder);
display: flex; align-items: center; justify-content: space-between;
flex-shrink: 0;
}
.sidebar-title { font-size: 15px; font-weight: 700; }
.sidebar-close {
width: 28px; height: 28px;
border-radius: 8px;
background: var(‚Äìsurface2);
display: flex; align-items: center; justify-content: center;
cursor: pointer; color: var(‚Äìtext2); font-size: 16px;
}

.sidebar-list {
overflow-y: auto;
flex: 1;
padding: 8px;
}
.sidebar-empty {
text-align: center;
padding: 40px 20px;
color: var(‚Äìtext3);
font-size: 13px;
}

.history-item {
padding: 10px 12px;
border-radius: 10px;
cursor: pointer;
transition: background 0.12s;
margin-bottom: 4px;
border: 1px solid transparent;
}
.history-item:hover { background: var(‚Äìsurface2); border-color: var(‚Äìborder); }
.history-item-title {
font-size: 13px; font-weight: 600;
white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.history-item-meta {
font-size: 10px; color: var(‚Äìtext3);
margin-top: 3px;
}

.sidebar-actions {
padding: 10px 12px;
border-top: 1px solid var(‚Äìborder);
flex-shrink: 0;
}
.sidebar-new-btn {
width: 100%;
padding: 9px;
background: var(‚Äìaccent);
border: none;
border-radius: 10px;
color: #fff;
font-size: 13px; font-weight: 600;
cursor: pointer;
transition: all 0.15s;
}
.sidebar-new-btn:active { opacity: 0.85; }

/* ‚îÄ‚îÄ MODEL SHEET ‚îÄ‚îÄ */
.sheet-overlay {
position: fixed; inset: 0;
background: rgba(0,0,0,0.6);
z-index: 100;
opacity: 0; pointer-events: none;
transition: opacity 0.25s;
}
.sheet-overlay.open { opacity: 1; pointer-events: all; }

.sheet {
position: fixed; bottom: 0; left: 0; right: 0;
background: var(‚Äìsurface);
border-radius: 20px 20px 0 0;
z-index: 101;
max-height: 80dvh;
display: flex; flex-direction: column;
transform: translateY(100%);
transition: transform 0.3s cubic-bezier(0.32,0.72,0,1);
}
.sheet.open { transform: translateY(0); }

.sheet-handle {
width: 36px; height: 4px;
background: var(‚Äìborder2);
border-radius: 2px;
margin: 10px auto 0;
flex-shrink: 0;
}

.sheet-header { padding: 12px 16px 8px; flex-shrink: 0; }
.sheet-title { font-size: 16px; font-weight: 700; }
.sheet-sub { font-size: 11px; color: var(‚Äìtext2); margin-top: 2px; }

.sheet-search { padding: 0 16px 8px; flex-shrink: 0; }
.sheet-search input {
width: 100%;
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder);
border-radius: 10px;
padding: 8px 12px 8px 34px;
color: var(‚Äìtext);
font-family: ‚ÄòInter‚Äô, sans-serif;
font-size: 13px;
outline: none;
}
.sheet-search input::placeholder { color: var(‚Äìtext3); }
.search-icon-wrap { position: relative; }
.search-icon-wrap svg {
position: absolute; left: 24px; top: 50%;
transform: translateY(-50%);
color: var(‚Äìtext3); pointer-events: none;
}

.sheet-cats {
display: flex; gap: 5px;
padding: 0 16px 8px;
overflow-x: auto; scrollbar-width: none;
flex-shrink: 0;
}
.sheet-cats::-webkit-scrollbar { display: none; }

.cat-pill {
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder);
border-radius: 18px;
padding: 4px 11px;
font-size: 11px; font-weight: 600;
color: var(‚Äìtext2);
white-space: nowrap;
cursor: pointer;
transition: all 0.15s;
flex-shrink: 0;
}
.cat-pill.active { background: var(‚Äìaccent); border-color: var(‚Äìaccent); color: #fff; }

.sheet-list { overflow-y: auto; flex: 1; padding-bottom: calc(env(safe-area-inset-bottom) + 8px); }

.model-row {
display: flex; align-items: center;
padding: 10px 16px;
cursor: pointer;
transition: background 0.12s;
border-bottom: 1px solid var(‚Äìborder);
gap: 10px;
position: relative;
}
.model-row:active { background: rgba(255,255,255,0.03); }
.model-row.selected { background: rgba(99,102,241,0.08); }
.model-row.selected::before {
content: ‚Äò‚Äô; position: absolute; left: 0;
width: 3px; height: 100%;
background: var(‚Äìaccent);
border-radius: 0 2px 2px 0;
}

.row-avatar {
width: 42px; height: 42px;
border-radius: 12px;
display: flex; align-items: center; justify-content: center;
font-size: 19px;
flex-shrink: 0;
overflow: hidden;
}
.row-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 12px; }

.row-info { flex: 1; min-width: 0; }
.row-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.row-desc { font-size: 11px; color: var(‚Äìtext2); line-height: 1.4; margin-top: 2px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
.row-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
.check {
width: 18px; height: 18px; border-radius: 50%;
background: var(‚Äìaccent);
display: flex; align-items: center; justify-content: center;
opacity: 0; transform: scale(0.6); transition: all 0.2s;
}
.model-row.selected .check { opacity: 1; transform: scale(1); }
.vision-tag {
font-size: 8px; font-weight: 700;
background: rgba(251,191,36,0.12);
color: var(‚Äìyellow);
border: 1px solid rgba(251,191,36,0.25);
padding: 2px 5px; border-radius: 4px;
letter-spacing: 0.3px;
}
.section-label {
padding: 10px 16px 4px;
font-size: 9px; font-weight: 700;
color: var(‚Äìtext3);
letter-spacing: 1px;
text-transform: uppercase;
}

/* ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ */
.chat-area {
flex: 1;
overflow-y: auto;
padding: 10px 12px;
display: flex;
flex-direction: column;
gap: 8px;
scrollbar-width: thin;
scrollbar-color: var(‚Äìsurface3) transparent;
}

.empty-state {
flex: 1;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
gap: 14px;
padding: 20px;
text-align: center;
}
.empty-icon {
width: 60px; height: 60px;
border-radius: 18px;
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder2);
display: flex; align-items: center; justify-content: center;
font-size: 28px;
}
.empty-title { font-size: 19px; font-weight: 700; }
.empty-sub { font-size: 12px; color: var(‚Äìtext2); line-height: 1.5; }

.suggestions {
display: flex; gap: 7px;
overflow-x: auto; scrollbar-width: none;
padding-bottom: 2px; width: 100%;
}
.suggestions::-webkit-scrollbar { display: none; }
.sugg-chip {
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder2);
border-radius: 12px;
padding: 9px 13px;
font-size: 11px; font-weight: 600;
color: var(‚Äìtext2);
white-space: normal; line-height: 1.3;
cursor: pointer;
flex-shrink: 0;
max-width: 150px;
transition: all 0.15s;
}
.sugg-chip:active { background: var(‚Äìsurface3); }

/* Messages */
.msg {
display: flex;
flex-direction: column;
max-width: 90%;
animation: fadeUp 0.2s ease both;
}
@keyframes fadeUp {
from { opacity:0; transform: translateY(5px); }
to { opacity:1; transform:none; }
}
.msg.user { align-self: flex-end; }
.msg.ai   { align-self: flex-start; }

.bubble {
padding: 10px 13px;
border-radius: 16px;
font-size: 14px;
line-height: 1.6;
word-break: break-word;
}
.msg.user .bubble {
background: var(‚Äìuser-bubble);
border: 1px solid var(‚Äìuser-border);
border-bottom-right-radius: 4px;
color: #dde0ff;
}
.msg.ai .bubble {
background: var(‚Äìsurface);
border: 1px solid var(‚Äìborder);
border-bottom-left-radius: 4px;
}

.msg-img {
max-width: 100%;
border-radius: 10px;
margin-bottom: 5px;
border: 1px solid var(‚Äìborder);
}

.msg-meta {
font-size: 9px; color: var(‚Äìtext3);
margin-top: 2px; padding: 0 4px;
display: flex; align-items: center; gap: 4px;
}
.msg.user .msg-meta { justify-content: flex-end; }
.msg.ai .msg-meta { justify-content: flex-start; }

/* Thinking timer */
.think-timer {
font-size: 9px;
color: var(‚Äìaccent2);
font-weight: 600;
font-family: ‚ÄòJetBrains Mono‚Äô, monospace;
background: rgba(99,102,241,0.1);
padding: 1px 6px;
border-radius: 4px;
border: 1px solid rgba(99,102,241,0.2);
}

/* AI label */
.ai-label {
display: flex; align-items: center; gap: 5px;
font-size: 10px; font-weight: 600;
color: var(‚Äìtext3);
margin-bottom: 3px; padding: 0 2px;
}
.ai-dot {
width: 15px; height: 15px;
border-radius: 4px;
display: flex; align-items: center; justify-content: center;
font-size: 8px; overflow: hidden;
}
.ai-dot img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }

/* Typing indicator */
.typing-bubble {
display: flex; gap: 4px;
align-items: center;
padding: 10px 14px;
}
.typing-dot {
width: 6px; height: 6px;
border-radius: 50%;
background: var(‚Äìtext3);
animation: blink 1.2s ease infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink {
0%,80%,100% { transform: scale(1); opacity: 0.5; }
40% { transform: scale(1.3); opacity: 1; }
}

/* ‚îÄ‚îÄ CODE BLOCKS ‚îÄ‚îÄ */
.code-wrapper {
position: relative;
margin: 8px 0;
border-radius: 10px;
overflow: hidden;
background: var(‚Äìcode-bg);
border: 1px solid rgba(255,255,255,0.08);
}

.code-header {
display: flex;
align-items: center;
justify-content: space-between;
padding: 6px 12px;
background: rgba(255,255,255,0.04);
border-bottom: 1px solid rgba(255,255,255,0.06);
}

.code-lang {
font-size: 10px;
font-weight: 600;
color: var(‚Äìtext3);
font-family: ‚ÄòJetBrains Mono‚Äô, monospace;
letter-spacing: 0.5px;
text-transform: uppercase;
}

.copy-btn {
display: flex; align-items: center; gap: 4px;
font-size: 10px;
font-weight: 600;
color: var(‚Äìtext2);
background: rgba(255,255,255,0.06);
border: 1px solid rgba(255,255,255,0.08);
border-radius: 5px;
padding: 3px 8px;
cursor: pointer;
transition: all 0.15s;
font-family: ‚ÄòInter‚Äô, sans-serif;
}
.copy-btn:active { background: rgba(99,102,241,0.2); color: var(‚Äìaccent2); }
.copy-btn.copied { color: var(‚Äìgreen); border-color: rgba(52,211,153,0.3); }

.code-wrapper pre {
margin: 0;
padding: 12px;
overflow-x: auto;
font-size: 12px;
line-height: 1.6;
font-family: ‚ÄòJetBrains Mono‚Äô, monospace;
background: transparent !important;
}
.code-wrapper code {
background: transparent !important;
font-family: ‚ÄòJetBrains Mono‚Äô, monospace;
font-size: 12px;
}

/* Inline code */
.bubble code:not(pre code) {
background: rgba(255,255,255,0.07);
padding: 1px 5px;
border-radius: 4px;
font-size: 12px;
font-family: ‚ÄòJetBrains Mono‚Äô, monospace;
color: #a9dc76;
}

/* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
.bubble table {
width: 100%;
border-collapse: collapse;
font-size: 12px;
margin: 8px 0;
border-radius: 8px;
overflow: hidden;
border: 1px solid var(‚Äìborder2);
}
.bubble table th {
background: rgba(99,102,241,0.15);
color: var(‚Äìaccent2);
font-weight: 700;
padding: 8px 10px;
text-align: left;
border-bottom: 1px solid var(‚Äìborder2);
font-size: 11px;
letter-spacing: 0.3px;
}
.bubble table td {
padding: 7px 10px;
border-bottom: 1px solid var(‚Äìborder);
color: var(‚Äìtext2);
}
.bubble table tr:last-child td { border-bottom: none; }
.bubble table tr:nth-child(even) td { background: rgba(255,255,255,0.02); }
.bubble table tr:nth-child(odd) td { background: transparent; }

/* Paragraph spacing */
.bubble p { margin-bottom: 5px; }
.bubble p:last-child { margin-bottom: 0; }
.bubble strong { color: #fff; font-weight: 700; }
.bubble em { color: var(‚Äìtext2); font-style: italic; }
.bubble ul, .bubble ol { padding-left: 18px; margin: 5px 0; }
.bubble li { margin-bottom: 2px; color: var(‚Äìtext2); }
.bubble h1,.bubble h2,.bubble h3 { color: #fff; font-weight: 700; margin: 10px 0 5px; }
.bubble h1 { font-size: 16px; }
.bubble h2 { font-size: 15px; }
.bubble h3 { font-size: 14px; }
.bubble blockquote {
border-left: 3px solid var(‚Äìaccent);
margin: 6px 0;
padding: 6px 12px;
background: rgba(99,102,241,0.05);
border-radius: 0 6px 6px 0;
color: var(‚Äìtext2);
font-style: italic;
}
.bubble hr {
border: none;
border-top: 1px solid var(‚Äìborder2);
margin: 8px 0;
}

/* KaTeX */
.katex { font-size: 1em !important; }
.katex-display { overflow-x: auto; margin: 8px 0; }

/* Streaming cursor */
.streaming-cursor::after {
content: ‚Äò‚ñã‚Äô;
animation: cursor-blink 0.6s steps(1) infinite;
color: var(‚Äìaccent2);
}
@keyframes cursor-blink {
0%,100% { opacity: 1; }
50% { opacity: 0; }
}

/* ‚îÄ‚îÄ INPUT BAR ‚îÄ‚îÄ */
.input-bar {
background: var(‚Äìsurface);
border-top: 1px solid var(‚Äìborder);
padding: 7px 10px;
padding-bottom: calc(7px + env(safe-area-inset-bottom));
flex-shrink: 0;
}

.input-row {
display: flex; align-items: flex-end; gap: 6px;
}

.attach-btn, .send-btn {
width: 38px; height: 38px;
border-radius: 12px;
border: none;
display: flex; align-items: center; justify-content: center;
cursor: pointer;
flex-shrink: 0;
transition: all 0.15s;
}
.attach-btn {
background: var(‚Äìsurface2);
color: var(‚Äìtext2);
font-size: 17px;
}
.attach-btn:active { opacity: 0.7; }

.send-btn {
background: var(‚Äìaccent);
color: #fff;
font-size: 16px;
}
.send-btn:active { transform: scale(0.92); }
.send-btn:disabled { background: var(‚Äìsurface3); color: var(‚Äìtext3); }

.input-wrap {
flex: 1;
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder);
border-radius: 14px;
display: flex; align-items: flex-end;
padding: 7px 11px;
gap: 6px;
min-height: 38px;
transition: border-color 0.2s;
}
.input-wrap:focus-within { border-color: rgba(99,102,241,0.45); }

#msgInput {
flex: 1;
background: none;
border: none;
outline: none;
color: var(‚Äìtext);
font-family: ‚ÄòInter‚Äô, sans-serif;
font-size: 14px;
line-height: 1.5;
resize: none;
max-height: 110px;
min-height: 20px;
}
#msgInput::placeholder { color: var(‚Äìtext3); }

/* Vision hint */
.vision-hint {
background: rgba(251,191,36,0.07);
border: 1px solid rgba(251,191,36,0.18);
border-radius: 8px;
padding: 6px 11px;
font-size: 10px;
color: #fbbf24;
font-weight: 600;
margin-bottom: 5px;
display: flex; align-items: center; gap: 5px;
}

/* Limit bar */
.limit-bar {
display: flex; gap: 8px; align-items: center;
padding: 5px 10px;
background: var(‚Äìsurface2);
border-radius: 8px;
margin-bottom: 5px;
font-size: 10px; color: var(‚Äìtext2);
}
.limit-item { display: flex; gap: 3px; align-items: center; }
.limit-dot { width: 5px; height: 5px; border-radius: 50%; }

/* Image preview */
.img-preview { display: flex; gap: 5px; margin-bottom: 5px; }
.preview-thumb { position: relative; width: 52px; height: 52px; }
.preview-thumb img {
width: 52px; height: 52px;
border-radius: 9px; object-fit: cover;
border: 1px solid var(‚Äìborder2);
}
.preview-rm {
position: absolute; top: -4px; right: -4px;
width: 16px; height: 16px; border-radius: 50%;
background: var(‚Äìred); color: #fff;
font-size: 10px;
display: flex; align-items: center; justify-content: center;
cursor: pointer; border: 1.5px solid var(‚Äìbg);
}

#fileInput { display: none; }

/* Avatar palette */
.av-claude  { background: linear-gradient(135deg,#d4845a,#c9512f); }
.av-gpt     { background: linear-gradient(135deg,#10a37f,#0a7a5f); }
.av-deepseek{ background: linear-gradient(135deg,#4e6ef2,#2a42c4); }
.av-qwen    { background: linear-gradient(135deg,#8b5cf6,#6d28d9); }
.av-llama   { background: linear-gradient(135deg,#f59e0b,#d97706); }
.av-command { background: linear-gradient(135deg,#6b7280,#374151); }
.av-kimi    { background: linear-gradient(135deg,#ec4899,#be185d); }
.av-glm     { background: linear-gradient(135deg,#a78bfa,#7c3aed); }
.av-c4ai    { background: linear-gradient(135deg,#06b6d4,#0891b2); }
.av-sonar   { background: linear-gradient(135deg,#f97316,#ea580c); }

/* Toast */
.toast {
position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
background: var(‚Äìsurface3);
border: 1px solid var(‚Äìborder2);
border-radius: 10px;
padding: 7px 14px;
font-size: 12px; font-weight: 600;
opacity: 0;
transition: all 0.25s;
white-space: nowrap;
z-index: 300;
pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* Streaming label */
.streaming-label {
display: flex; align-items: center; gap: 5px;
font-size: 9px; color: var(‚Äìaccent2);
font-weight: 600;
animation: pulse-fade 1.5s ease infinite;
}
@keyframes pulse-fade {
0%,100% { opacity: 1; }
50% { opacity: 0.5; }
}
.streaming-dot {
width: 5px; height: 5px; border-radius: 50%;
background: var(‚Äìaccent2);
animation: pulse-scale 1.5s ease infinite;
}
@keyframes pulse-scale {
0%,100% { transform: scale(1); }
50% { transform: scale(1.5); }
}
</style>

</head>
<body>

<!-- HEADER -->

<div class="header">
  <div class="model-selector" id="modelSelector">
    <div class="model-avatar av-claude" id="hdrAvatar">üî∑</div>
    <div class="model-selector-info">
      <div class="model-selector-name" id="hdrName">Claude Sonnet 4.5</div>
      <div class="model-selector-sub" id="hdrSub">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å</div>
    </div>
    <div class="chevron">‚ñº</div>
  </div>
  <div class="header-actions">
    <div class="header-btn" id="historyBtn" title="–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤">üìÇ</div>
    <div class="header-btn" id="clearBtn" title="–ù–æ–≤—ã–π —á–∞—Ç">‚úèÔ∏è</div>
  </div>
</div>

<!-- CHAT -->

<div class="chat-area" id="chatArea">
  <div class="empty-state" id="emptyState">
    <div class="empty-icon">ü§ñ</div>
    <div class="empty-title">–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
    <div class="empty-sub">–í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å –≤–≤–µ—Ä—Ö—É –∏ –Ω–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å</div>
    <div class="suggestions" id="suggestions">
      <div class="sugg-chip">–û–±—ä—è—Å–Ω–∏ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏</div>
      <div class="sugg-chip">–ù–∞–ø–∏—à–∏ –∫–æ–¥ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –Ω–∞ Python</div>
      <div class="sugg-chip">–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π</div>
      <div class="sugg-chip">–ü—Ä–∏–¥—É–º–∞–π –∏–¥–µ–∏ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞–ø–∞ –≤ 2025</div>
    </div>
  </div>
</div>

<!-- INPUT -->

<div class="input-bar" id="inputBar">
  <div class="vision-hint" id="visionHint" style="display:none">
    üì∏ –ú–æ–¥–µ–ª—å –≤–∏–¥–∏—Ç —Ñ–æ—Ç–æ ‚Äî –Ω–∞–∂–º–∏ üìé —á—Ç–æ–±—ã –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å
  </div>
  <div class="img-preview" id="imgPreview" style="display:none"></div>
  <div class="limit-bar" id="limitBar" style="display:none">
    <span>üìä</span>
    <span class="limit-item"><span class="limit-dot" style="background:#34d399"></span><span id="fastLeft">‚Äî</span> –±—ã—Å—Ç—Ä—ã—Ö</span>
    <span class="limit-item"><span class="limit-dot" style="background:#6366f1"></span><span id="proLeft">‚Äî</span> –ø—Ä–æ—Ñ.</span>
  </div>
  <div class="input-row">
    <button class="attach-btn" id="attachBtn">üìé</button>
    <div class="input-wrap">
      <textarea id="msgInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
    </div>
    <button class="send-btn" id="sendBtn" disabled>‚Üë</button>
  </div>
</div>

<!-- HISTORY SIDEBAR -->

<div class="sidebar-overlay" id="sidebarOverlay"></div>
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-title">üìÇ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</div>
    <div class="sidebar-close" id="sidebarClose">‚úï</div>
  </div>
  <div class="sidebar-list" id="sidebarList">
    <div class="sidebar-empty" id="sidebarEmpty">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤</div>
  </div>
  <div class="sidebar-actions">
    <button class="sidebar-new-btn" id="sidebarNewBtn">‚úèÔ∏è –ù–æ–≤—ã–π —á–∞—Ç</button>
  </div>
</div>

<!-- MODEL SHEET -->

<div class="sheet-overlay" id="sheetOverlay"></div>
<div class="sheet" id="sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">–í—ã–±–æ—Ä –Ω–µ–π—Ä–æ—Å–µ—Ç–∏</div>
    <div class="sheet-sub">–í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å –¥–ª—è –¥–∏–∞–ª–æ–≥–∞</div>
  </div>
  <div class="sheet-search">
    <div class="search-icon-wrap">
      <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
      </svg>
      <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
    </div>
  </div>
  <div class="sheet-cats" id="sheetCats"></div>
  <div class="sheet-list" id="sheetList"></div>
</div>

<input type="file" id="fileInput" accept="image/*">
<div class="toast" id="toast"></div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// ‚îÄ‚îÄ –ú–æ–¥–µ–ª–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MODELS = [
  { key:"claude_sonnet", name:"Claude Sonnet 4.5", emoji:"üî∑", av:"av-claude", cat:"Claude", desc:"–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è ‚Äî —É–º–Ω–∞—è, –±—ã—Å—Ç—Ä–∞—è, –¥–µ—Ç–∞–ª—å–Ω–∞—è" },
  { key:"claude_haiku",  name:"Claude Haiku 4.5",  emoji:"üíé", av:"av-claude", cat:"Claude", desc:"–°–∞–º–∞—è –±—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è Claude" },
  { key:"claude_opus",   name:"Claude Opus 4.5",   emoji:"üîµ", av:"av-claude", cat:"Claude", desc:"–¢–æ–ø–æ–≤–∞—è –º–æ–¥–µ–ª—å Anthropic ‚Äî –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑" },
  { key:"gpt52",         name:"GPT-5.2",           emoji:"‚ö°", av:"av-gpt",    cat:"GPT",    desc:"–ù–æ–≤–µ–π—à–∞—è –º–æ–¥–µ–ª—å –æ—Ç OpenAI" },
  { key:"gpt52_chat",    name:"GPT-5.2 Chat",      emoji:"üí¨", av:"av-gpt",    cat:"GPT",    desc:"GPT-5.2 –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤" },
  { key:"deepseek_v3",   name:"DeepSeek V3.2",     emoji:"üß¨", av:"av-deepseek",cat:"DeepSeek",desc:"–¢–æ–ø –¥–ª—è –∫–æ–¥–∞ –∏ –ª–æ–≥–∏–∫–∏" },
  { key:"deepseek_r1",   name:"DeepSeek R1",       emoji:"üß†", av:"av-deepseek",cat:"DeepSeek",desc:"Reasoning —Å —Ü–µ–ø–æ—á–∫–æ–π —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π" },
  { key:"deepseek_v3_sq",name:"DeepSeek V3",       emoji:"üß¨", av:"av-deepseek",cat:"DeepSeek",desc:"–°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è V3" },
  { key:"qwen3_max",     name:"Qwen3-Max",         emoji:"üåê", av:"av-qwen",   cat:"Qwen",   desc:"–§–ª–∞–≥–º–∞–Ω Alibaba ‚Äî –º–Ω–æ–≥–æ—è–∑—ã—á–Ω—ã–π" },
  { key:"qwen3_vl",      name:"Qwen3-VL",          emoji:"üëÅÔ∏è", av:"av-qwen",   cat:"Qwen",   desc:"Vision ‚Äî –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π üì∏", vision:true },
  { key:"qwen_vision",   name:"Qwen2.5-VL 32B",    emoji:"üñºÔ∏è", av:"av-qwen",   cat:"Qwen",   desc:"–ú–æ—â–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ üì∏", vision:true },
  { key:"llama32_90b",   name:"Llama 3.2 90B",     emoji:"ü¶ô", av:"av-llama",  cat:"Llama",  desc:"Open-source –≥–∏–≥–∞–Ω—Ç –æ—Ç Meta üì∏", vision:true },
  { key:"command_a",     name:"Command-A",         emoji:"‚öôÔ∏è", av:"av-command",cat:"Command", desc:"–ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å –æ—Ç Cohere" },
  { key:"command_vision",name:"Command Vision",    emoji:"üëÅÔ∏è", av:"av-command",cat:"Command", desc:"–° –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π üì∏", vision:true },
  { key:"command_reason",name:"Command Reasoning", emoji:"üß©", av:"av-command",cat:"Command", desc:"–£–≥–ª—É–±–ª—ë–Ω–Ω–æ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ" },
  { key:"moonshot",      name:"Kimi K2",           emoji:"üåô", av:"av-kimi",   cat:"Kimi",   desc:"Moonshot AI ‚Äî –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ" },
  { key:"glm47",         name:"GLM-4.7",           emoji:"üîÆ", av:"av-glm",    cat:"GLM",    desc:"–ù–æ–≤–µ–π—à–∏–π GLM —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º reasoning" },
  { key:"glm46",         name:"GLM-4.6",           emoji:"üîÆ", av:"av-glm",    cat:"GLM",    desc:"–°—Ç–∞–±–∏–ª—å–Ω—ã–π GLM-4.6" },
  { key:"c4ai_32b",      name:"C4AI Aya 32B",      emoji:"üåÄ", av:"av-c4ai",   cat:"C4AI",   desc:"–ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è 32B –º–æ–¥–µ–ª—å" },
  { key:"c4ai_8b",       name:"C4AI Aya 8B",       emoji:"üåÄ", av:"av-c4ai",   cat:"C4AI",   desc:"–ë—ã—Å—Ç—Ä–∞—è Aya 8B" },
  { key:"c4ai_vis32b",   name:"C4AI Vision 32B",   emoji:"üåÄ", av:"av-c4ai",   cat:"C4AI",   desc:"Vision Aya 32B üì∏", vision:true },
  { key:"c4ai_vis8b",    name:"C4AI Vision 8B",    emoji:"üåÄ", av:"av-c4ai",   cat:"C4AI",   desc:"–ë—ã—Å—Ç—Ä–∞—è Vision Aya 8B üì∏", vision:true },
  { key:"sonar",         name:"Sonar",             emoji:"üîç", av:"av-sonar",  cat:"Sonar",  desc:"Perplexity ‚Äî –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ" },
  { key:"sonar_pro",     name:"Sonar Pro",         emoji:"üîç", av:"av-sonar",  cat:"Sonar",  desc:"–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫" },
];

const CATS = ["–í—Å–µ","Claude","GPT","DeepSeek","Qwen","Llama","Command","Kimi","GLM","C4AI","Sonar"];

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const params = new URLSearchParams(location.search);
let curModel  = params.get("model") || "claude_sonnet";
let catFilter = "–í—Å–µ";
let searchQ   = "";
let pendingImgs = [];
let messages  = [];
let isLoading = false;
let streamAbort = null;

const API_BASE = params.get("api") || window.TG_API_BASE || "http://localhost:8080";

let USER_ID = 0;
try {
  if (tg.initDataUnsafe?.user?.id) USER_ID = tg.initDataUnsafe.user.id;
  if (!USER_ID && tg.initData) {
    const parsed = new URLSearchParams(tg.initData);
    const userStr = parsed.get("user");
    if (userStr) USER_ID = JSON.parse(decodeURIComponent(userStr)).id || 0;
  }
  if (!USER_ID) USER_ID = parseInt(params.get("uid") || "0");
} catch(e) {}

// ‚îÄ‚îÄ Chat History (localStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HISTORY_KEY = `huza_chats_${USER_ID}`;
let chatHistory = [];
let currentChatId = null;

function loadChatHistory() {
  try {
    chatHistory = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
  } catch(e) { chatHistory = []; }
}

function saveChatHistory() {
  try {
    localStorage.setItem(HISTORY_KEY, JSON.stringify(chatHistory.slice(0, 50)));
  } catch(e) {}
}

function saveCurrentChat() {
  if (!messages.length) return;
  const firstMsg = messages.find(m => m.role === 'user');
  const title = firstMsg ? firstMsg.content.slice(0, 50) : '–ß–∞—Ç';
  const now = Date.now();

  if (currentChatId) {
    const idx = chatHistory.findIndex(c => c.id === currentChatId);
    if (idx >= 0) {
      chatHistory[idx] = { id: currentChatId, title, messages: [...messages], model: curModel, ts: now };
      saveChatHistory();
      return;
    }
  }

  currentChatId = now.toString();
  chatHistory.unshift({ id: currentChatId, title, messages: [...messages], model: curModel, ts: now });
  saveChatHistory();
}

function renderSidebar() {
  const list = document.getElementById('sidebarList');
  const empty = document.getElementById('sidebarEmpty');
  if (!chatHistory.length) {
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  list.innerHTML = chatHistory.map(chat => `
    <div class="history-item" onclick="loadChat('${chat.id}')">
      <div class="history-item-title">${escHtml(chat.title)}</div>
      <div class="history-item-meta">${formatDate(chat.ts)} ¬∑ ${chat.model || ''}</div>
    </div>
  `).join('') + '<div class="sidebar-empty" id="sidebarEmpty" style="display:none"></div>';
}

function loadChat(id) {
  const chat = chatHistory.find(c => c.id === id);
  if (!chat) return;
  currentChatId = id;
  curModel = chat.model || curModel;
  messages = [...chat.messages];
  updateHeader();
  closeSidebar();
  renderChatFromHistory(chat.messages);
  showToast('üí¨ –ß–∞—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
}

function renderChatFromHistory(msgs) {
  const area = document.getElementById('chatArea');
  area.innerHTML = '';
  msgs.forEach(m => {
    if (m.role === 'user') {
      addUserMsg(m.content, m.imgUrls || [], false);
    } else if (m.role === 'assistant') {
      addAiMsg(m.content, null, null, false);
    }
  });
  scrollBottom();
}

function formatDate(ts) {
  const d = new Date(ts);
  const now = new Date();
  if (d.toDateString() === now.toDateString()) {
    return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
  }
  return d.getDate() + '.' + (d.getMonth()+1).toString().padStart(2,'0');
}

// ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('historyBtn').addEventListener('click', () => {
  renderSidebar();
  document.getElementById('sidebarOverlay').classList.add('open');
  document.getElementById('sidebar').classList.add('open');
});
document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
document.getElementById('sidebarClose').addEventListener('click', closeSidebar);
document.getElementById('sidebarNewBtn').addEventListener('click', () => {
  closeSidebar();
  startNewChat();
});

function closeSidebar() {
  document.getElementById('sidebarOverlay').classList.remove('open');
  document.getElementById('sidebar').classList.remove('open');
}

function startNewChat() {
  messages = [];
  currentChatId = null;
  pendingImgs = [];
  renderImgPreview();
  const area = document.getElementById('chatArea');
  area.innerHTML = buildEmptyState();
  bindSuggChips();
  showToast('‚úèÔ∏è –ù–æ–≤—ã–π —á–∞—Ç');
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadChatHistory();
updateHeader();
renderCats();
renderModels();
bindSuggChips();

const fl = params.get("fast_left"), pl = params.get("pro_left");
if (fl !== null || pl !== null) {
  document.getElementById("limitBar").style.display = "flex";
  document.getElementById("fastLeft").textContent = fl ?? "‚Äî";
  document.getElementById("proLeft").textContent  = pl ?? "‚Äî";
}

function buildEmptyState() {
  return `<div class="empty-state" id="emptyState">
    <div class="empty-icon">ü§ñ</div>
    <div class="empty-title">–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
    <div class="empty-sub">–í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å –∏ –Ω–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å</div>
    <div class="suggestions" id="suggestions">
      <div class="sugg-chip">–û–±—ä—è—Å–Ω–∏ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏</div>
      <div class="sugg-chip">–ù–∞–ø–∏—à–∏ –∫–æ–¥ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –Ω–∞ Python</div>
      <div class="sugg-chip">–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π</div>
      <div class="sugg-chip">–ü—Ä–∏–¥—É–º–∞–π –∏–¥–µ–∏ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞–ø–∞ –≤ 2025</div>
    </div>
  </div>`;
}

function bindSuggChips() {
  document.querySelectorAll('.sugg-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const input = document.getElementById('msgInput');
      input.value = chip.textContent.trim();
      input.dispatchEvent(new Event('input'));
      input.focus();
    });
  });
}

// ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getModel(key) { return MODELS.find(m => m.key === key) || MODELS[0]; }
function updateHeader() {
  const m = getModel(curModel);
  const av = document.getElementById('hdrAvatar');
  av.className = `model-avatar ${m.av}`;
  av.textContent = m.emoji;
  document.getElementById('hdrName').textContent = m.name;
  document.getElementById('hdrSub').textContent = m.vision ? 'üì∏ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ç–æ' : '–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å';
  document.getElementById('visionHint').style.display = m.vision ? 'flex' : 'none';
}

// ‚îÄ‚îÄ Clear / New chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('clearBtn').addEventListener('click', () => {
  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
  startNewChat();
});

// ‚îÄ‚îÄ Sheet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('modelSelector').addEventListener('click', openSheet);
document.getElementById('sheetOverlay').addEventListener('click', closeSheet);

function openSheet() {
  document.getElementById('sheetOverlay').classList.add('open');
  document.getElementById('sheet').classList.add('open');
  document.getElementById('searchInput').value = '';
  searchQ = ''; catFilter = '–í—Å–µ';
  renderCats(); renderModels();
}
function closeSheet() {
  document.getElementById('sheetOverlay').classList.remove('open');
  document.getElementById('sheet').classList.remove('open');
}

function renderCats() {
  const wrap = document.getElementById('sheetCats');
  wrap.innerHTML = CATS.map(c =>
    `<div class="cat-pill${c===catFilter?' active':''}" onclick="setCat('${c}')">${c}</div>`
  ).join('');
}
function setCat(c) { catFilter = c; renderCats(); renderModels(); }

document.getElementById('searchInput').addEventListener('input', e => {
  searchQ = e.target.value.toLowerCase();
  if (searchQ) catFilter = '–í—Å–µ';
  renderCats(); renderModels();
});

function renderModels() {
  const list = document.getElementById('sheetList');
  let filtered = MODELS.filter(m => {
    const matchCat = catFilter === '–í—Å–µ' || m.cat === catFilter;
    const matchQ = !searchQ || m.name.toLowerCase().includes(searchQ) || m.desc.toLowerCase().includes(searchQ);
    return matchCat && matchQ;
  });
  if (!filtered.length) { list.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text3)">üòî –ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>`; return; }
  let html = ''; let lastCat = null;
  filtered.forEach(m => {
    if (catFilter === '–í—Å–µ' && !searchQ && m.cat !== lastCat) {
      html += `<div class="section-label">${m.cat}</div>`;
      lastCat = m.cat;
    }
    const sel = m.key === curModel;
    html += `
      <div class="model-row${sel?' selected':''}" onclick="selectModel('${m.key}')">
        <div class="row-avatar ${m.av}">${m.emoji}</div>
        <div class="row-info">
          <div class="row-name">${m.name}</div>
          <div class="row-desc">${m.desc}</div>
        </div>
        <div class="row-right">
          <div class="check"><svg width="9" height="9" viewBox="0 0 12 12"><path d="M2 6l3 3 5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></div>
          ${m.vision ? '<span class="vision-tag">üì∏ VISION</span>' : ''}
        </div>
      </div>`;
  });
  list.innerHTML = html;
}

function selectModel(key) {
  if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
  curModel = key;
  updateHeader();
  renderModels();
  closeSheet();
  showToast(`‚úÖ ${getModel(key).name}`);
}

// ‚îÄ‚îÄ Input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const msgInput = document.getElementById('msgInput');
msgInput.addEventListener('input', () => {
  msgInput.style.height = 'auto';
  msgInput.style.height = Math.min(msgInput.scrollHeight, 110) + 'px';
  updateSendBtn();
});
msgInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});
function updateSendBtn() {
  const hasText = msgInput.value.trim().length > 0;
  const hasImg = pendingImgs.length > 0;
  document.getElementById('sendBtn').disabled = (!hasText && !hasImg) || isLoading;
}

// ‚îÄ‚îÄ Attach ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('attachBtn').addEventListener('click', () => {
  const m = getModel(curModel);
  if (!m.vision) { showToast('‚ö†Ô∏è –≠—Ç–∞ –º–æ–¥–µ–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ'); return; }
  document.getElementById('fileInput').click();
});
document.getElementById('fileInput').addEventListener('change', e => {
  Array.from(e.target.files || []).forEach(file => {
    if (!file.type.startsWith('image/')) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const b64full = ev.target.result;
      pendingImgs.push({ file, b64: b64full.split(',')[1], url: b64full });
      renderImgPreview();
      updateSendBtn();
    };
    reader.readAsDataURL(file);
  });
  e.target.value = '';
});
function renderImgPreview() {
  const wrap = document.getElementById('imgPreview');
  if (!pendingImgs.length) { wrap.style.display = 'none'; wrap.innerHTML = ''; return; }
  wrap.style.display = 'flex';
  wrap.innerHTML = pendingImgs.map((img, i) =>
    `<div class="preview-thumb"><img src="${img.url}" alt="—Ñ–æ—Ç–æ"><div class="preview-rm" onclick="removeImg(${i})">√ó</div></div>`
  ).join('');
}
function removeImg(i) { pendingImgs.splice(i, 1); renderImgPreview(); updateSendBtn(); }

// ‚îÄ‚îÄ SEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('sendBtn').addEventListener('click', sendMessage);

async function sendMessage() {
  if (isLoading) return;
  const text = msgInput.value.trim();
  const imgs = [...pendingImgs];
  if (!text && !imgs.length) return;

  hideEmpty();
  isLoading = true;
  updateSendBtn();

  const imgUrls = imgs.map(i => i.url);
  addUserMsg(text, imgUrls);

  msgInput.value = '';
  msgInput.style.height = 'auto';
  pendingImgs = [];
  renderImgPreview();

  messages.push({ role: 'user', content: text || '[–§–æ—Ç–æ]', imgUrls });

  const historyForBot = messages.slice(-10).map(m => ({ role: m.role, content: m.content }));

  const payload = {
    action: 'chat', uid: USER_ID, model: curModel,
    text: text || '', images: imgs.map(i => i.b64),
    history: historyForBot
  };

  // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ-–∑–∞–≥–ª—É—à–∫—É —Å —Ç–∞–π–º–µ—Ä–æ–º
  const { msgEl, bubbleEl, startTs } = addStreamMsg();

  try {
    const resp = await fetch(`${API_BASE}/api/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await resp.json();

    stopStreamTimer(msgEl, startTs);

    if (data.ok) {
      renderFinalMsg(msgEl, bubbleEl, data.answer, data.model_label);
      messages.push({ role: 'assistant', content: data.answer });
      saveCurrentChat();
      if (data.fast_left !== undefined) {
        document.getElementById('limitBar').style.display = 'flex';
        document.getElementById('fastLeft').textContent = data.fast_left;
        document.getElementById('proLeft').textContent = data.pro_left;
      }
    } else if (data.error === 'subscription_required') {
      let txt = 'üîê <b>–ù—É–∂–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª!</b>';
      (data.channels || []).forEach(ch => { txt += `\n‚Ä¢ <a href="${ch.url}">${ch.title}</a>`; });
      renderFinalMsg(msgEl, bubbleEl, txt, null, true);
    } else if (data.error === 'limit_exceeded') {
      renderFinalMsg(msgEl, bubbleEl, `üö´ –õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω!\n‚è∞ –°–±—Ä–æ—Å —á–µ—Ä–µ–∑: ${data.reset_in || '?'}\n\n–û—Å—Ç–∞–ª–æ—Å—å: ‚ö°${data.fast_left} –±—ã—Å—Ç—Ä—ã—Ö | üß†${data.pro_left} –ø—Ä–æ—Ñ.`);
    } else {
      renderFinalMsg(msgEl, bubbleEl, `‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
    }
  } catch(e) {
    stopStreamTimer(msgEl, startTs);
    renderFinalMsg(msgEl, bubbleEl, '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.\n\nüí° –ü–æ–ø—Ä–æ–±—É–π –Ω–∞–ø–∏—Å–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø—Ä—è–º–æ –≤ —á–∞—Ç –±–æ—Ç–∞.');
  }

  isLoading = false;
  updateSendBtn();
}

// ‚îÄ‚îÄ DOM helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function hideEmpty() {
  const e = document.getElementById('emptyState');
  if (e) e.remove();
}

function addUserMsg(text, imgUrls, save = true) {
  const area = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = 'msg user';
  let imgsHtml = (imgUrls || []).map(u => `<img class="msg-img" src="${u}" alt="—Ñ–æ—Ç–æ">`).join('');
  div.innerHTML = `
    ${imgsHtml}
    ${text ? `<div class="bubble">${escHtml(text)}</div>` : ''}
    <div class="msg-meta">–í—ã ¬∑ ${timeNow()}</div>`;
  area.appendChild(div);
  scrollBottom();
}

function addStreamMsg() {
  const area = document.getElementById('chatArea');
  const m = getModel(curModel);
  const div = document.createElement('div');
  div.className = 'msg ai';
  const startTs = Date.now();
  div.innerHTML = `
    <div class="ai-label">
      <div class="ai-dot ${m.av}">${m.emoji}</div>
      ${m.name}
      <span class="streaming-label"><span class="streaming-dot"></span>–≥–µ–Ω–µ—Ä–∏—Ä—É—é</span>
    </div>
    <div class="bubble" id="streamBubble">
      <div class="typing-bubble">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>
    <div class="msg-meta">
      <span class="think-timer" id="thinkTimer">‚è± 0.0—Å</span>
      ${m.name}
    </div>`;
  area.appendChild(div);
  scrollBottom();

  // Start live timer
  const timerEl = div.querySelector('#thinkTimer');
  const timerInterval = setInterval(() => {
    const elapsed = ((Date.now() - startTs) / 1000).toFixed(1);
    if (timerEl) timerEl.textContent = `‚è± ${elapsed}—Å`;
  }, 100);
  div._timerInterval = timerInterval;

  const bubbleEl = div.querySelector('#streamBubble');
  bubbleEl.id = '';
  return { msgEl: div, bubbleEl, startTs };
}

function stopStreamTimer(msgEl, startTs) {
  if (msgEl._timerInterval) clearInterval(msgEl._timerInterval);
  const timerEl = msgEl.querySelector('.think-timer');
  if (timerEl) {
    const elapsed = ((Date.now() - startTs) / 1000).toFixed(1);
    timerEl.textContent = `‚è± ${elapsed}—Å`;
  }
  const streamLabel = msgEl.querySelector('.streaming-label');
  if (streamLabel) streamLabel.remove();
}

function renderFinalMsg(msgEl, bubbleEl, text, modelLabel, isHtml = false) {
  const m = getModel(curModel);
  const labelEl = msgEl.querySelector('.ai-label');
  if (labelEl && modelLabel) {
    labelEl.innerHTML = `<div class="ai-dot ${m.av}">${m.emoji}</div>${modelLabel}`;
  }
  bubbleEl.innerHTML = isHtml ? text : formatText(text);
  applyCodeHighlight(bubbleEl);
  renderKaTeX(bubbleEl);
  const metaEl = msgEl.querySelector('.msg-meta');
  if (metaEl) {
    const timer = metaEl.querySelector('.think-timer');
    const timerText = timer ? timer.outerHTML : '';
    metaEl.innerHTML = `${timerText}${(modelLabel || m.name)} ¬∑ ${timeNow()}`;
  }
  scrollBottom();
}

function addAiMsg(text, modelLabel, elapsed, save = true) {
  const area = document.getElementById('chatArea');
  const m = getModel(curModel);
  const displayName = modelLabel || m.name;
  const div = document.createElement('div');
  div.className = 'msg ai';
  const timerHtml = elapsed ? `<span class="think-timer">‚è± ${elapsed}—Å</span>` : '';
  div.innerHTML = `
    <div class="ai-label"><div class="ai-dot ${m.av}">${m.emoji}</div>${displayName}</div>
    <div class="bubble"></div>
    <div class="msg-meta">${timerHtml}${displayName} ¬∑ ${timeNow()}</div>`;
  const bubbleEl = div.querySelector('.bubble');
  bubbleEl.innerHTML = formatText(text);
  area.appendChild(div);
  applyCodeHighlight(bubbleEl);
  renderKaTeX(bubbleEl);
  scrollBottom();
}

function applyCodeHighlight(container) {
  container.querySelectorAll('pre code').forEach(el => {
    hljs.highlightElement(el);
  });
  // Add copy buttons
  container.querySelectorAll('.code-wrapper').forEach(wrapper => {
    if (wrapper.querySelector('.copy-btn')) return;
    const header = wrapper.querySelector('.code-header');
    if (!header) return;
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.innerHTML = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
    btn.addEventListener('click', () => {
      const code = wrapper.querySelector('code');
      if (!code) return;
      navigator.clipboard.writeText(code.innerText).then(() => {
        btn.innerHTML = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
        btn.classList.add('copied');
        setTimeout(() => { btn.innerHTML = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; btn.classList.remove('copied'); }, 2000);
      }).catch(() => {
        showToast('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
      });
    });
    header.appendChild(btn);
  });
}

function renderKaTeX(container) {
  try {
    renderMathInElement(container, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false },
        { left: '\\[', right: '\\]', display: true },
      ],
      throwOnError: false,
    });
  } catch(e) {}
}

function scrollBottom() {
  const area = document.getElementById('chatArea');
  requestAnimationFrame(() => { area.scrollTop = area.scrollHeight; });
}

// ‚îÄ‚îÄ Text Formatters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}

function formatText(raw) {
  // Code blocks first
  const codeBlocks = [];
  let text = raw.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
    const id = `__CODE_${codeBlocks.length}__`;
    const langLabel = lang || 'code';
    codeBlocks.push(`
      <div class="code-wrapper">
        <div class="code-header">
          <span class="code-lang">${escHtml(langLabel)}</span>
        </div>
        <pre><code class="language-${escHtml(langLabel)}">${escHtml(code.trim())}</code></pre>

```
  </div>`);
return id;
```

});

// Tables
text = text.replace(/(|.+|\n)+/g, match => {
const rows = match.trim().split(‚Äô\n‚Äô).filter(r => r.trim());
const isSep = r => /^|[\s-:]+|/.test(r);
const cells = r => r.split(‚Äô|‚Äô).slice(1,-1).map(c => c.trim());
let html = ‚Äò<table>‚Äô;
let isHead = true;
for (const row of rows) {
if (isSep(row)) { isHead = false; continue; }
const tag = isHead ? ‚Äòth‚Äô : ‚Äòtd‚Äô;
html += ‚Äò<tr>‚Äô + cells(row).map(c => `<${tag}>${mdInline(c)}</${tag}>`).join(‚Äô‚Äô) + ‚Äò</tr>‚Äô;
if (isHead) { isHead = false; }
}
html += ‚Äò</table>‚Äô;
return html;
});

// Block elements
text = text.replace(/^#{3}\s+(.+)$/gm, ‚Äò<h3>$1</h3>‚Äô);
text = text.replace(/^#{2}\s+(.+)$/gm, ‚Äò<h2>$1</h2>‚Äô);
text = text.replace(/^#\s+(.+)$/gm, ‚Äò<h1>$1</h1>‚Äô);
text = text.replace(/^>\s+(.+)$/gm, ‚Äò<blockquote>$1</blockquote>‚Äô);
text = text.replace(/^‚Äî$/gm, ‚Äò<hr>‚Äô);

// Lists
text = text.replace(/^(\s*[-*‚Ä¢]\s+.+(\n(?!\s*[-*‚Ä¢]|\s*\d+.).+)*)/gm, match => {
const items = match.split(‚Äô\n‚Äô).filter(l => l.trim());
return ‚Äò<ul>‚Äô + items.map(l => `<li>${mdInline(l.replace(/^\s*[-*‚Ä¢]\s+/, ''))}</li>`).join(‚Äô‚Äô) + ‚Äò</ul>‚Äô;
});
text = text.replace(/^(\s*\d+.\s+.+(\n(?!\s*\d+.|\s*[-*‚Ä¢]).+)*)/gm, match => {
const items = match.split(‚Äô\n‚Äô).filter(l => l.trim());
return ‚Äò<ol>‚Äô + items.map(l => `<li>${mdInline(l.replace(/^\s*\d+\.\s+/, ''))}</li>`).join(‚Äô‚Äô) + ‚Äò</ol>‚Äô;
});

// Inline
text = mdInline(text);

// Paragraphs
text = text.replace(/\n\n+/g, ‚Äò</p><p>‚Äô);
text = text.replace(/\n/g, ‚Äò<br>‚Äô);
if (!text.includes(‚Äô<p>‚Äô) && !text.includes(‚Äô<h‚Äô) && !text.includes(‚Äô<ul>‚Äô) && !text.includes(‚Äô<ol>‚Äô) && !text.includes(‚Äô<blockquote>‚Äô) && !text.match(/**CODE*\d+*_/)) {
text = `<p>${text}</p>`;
}

// Restore code blocks
codeBlocks.forEach((block, i) => {
text = text.replace(`__CODE_${i}__`, block);
});
text = text.replace(/<p>(**CODE*\d+*_)</p>/g, ‚Äò$1‚Äô);

return text;
}

function mdInline(text) {
// Bold italic
text = text.replace(/***(.+?)***/g, ‚Äò<strong><em>$1</em></strong>‚Äô);
// Bold
text = text.replace(/**(.+?)**/g, ‚Äò<strong>$1</strong>‚Äô);
// Italic
text = text.replace(/*(.+?)*/g, ‚Äò<em>$1</em>‚Äô);
text = text.replace(/(?<!\w)*(.+?)*(?!\w)/g, ‚Äò<em>$1</em>‚Äô);
// Inline code
text = text.replace(/`([^`]+)`/g, ‚Äò<code>$1</code>‚Äô);
return text;
}

function timeNow() {
const d = new Date();
return d.getHours().toString().padStart(2,‚Äò0‚Äô) + ‚Äò:‚Äô + d.getMinutes().toString().padStart(2,‚Äò0‚Äô);
}

function showToast(msg) {
const t = document.getElementById(‚Äòtoast‚Äô);
t.textContent = msg;
t.classList.add(‚Äòshow‚Äô);
setTimeout(() => t.classList.remove(‚Äòshow‚Äô), 2200);
}

// ‚îÄ‚îÄ Load limits on open ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if (USER_ID) {
fetch(`${API_BASE}/api/limits?uid=${USER_ID}`)
.then(r => r.json())
.then(d => {
if (d.ok) {
document.getElementById(‚ÄòlimitBar‚Äô).style.display = ‚Äòflex‚Äô;
document.getElementById(‚ÄòfastLeft‚Äô).textContent = d.fast_left;
document.getElementById(‚ÄòproLeft‚Äô).textContent = d.pro_left;
}
}).catch(() => {});
}
</script>

</body>
</html>
