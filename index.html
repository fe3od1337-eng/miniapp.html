<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–•—É–∑–∞ –ò–ò</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<!-- highlight.js –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–æ–¥–∞ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<!-- KaTeX –¥–ª—è LaTeX —Ñ–æ—Ä–º—É–ª -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
<style>
:root {
  --bg: #0a0a0f;
  --surface: #13131a;
  --surface2: #1c1c27;
  --surface3: #252535;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --text: #f0f0ff;
  --text2: rgba(240,240,255,0.55);
  --text3: rgba(240,240,255,0.3);
  --accent: #5b6ef5;
  --accent2: #7c8ff7;
  --accent-glow: rgba(91,110,245,0.25);
  --user-bubble: #1e2460;
  --user-border: rgba(91,110,245,0.4);
  --ai-bubble: #13131a;
  --green: #34d399;
  --red: #f87171;
  --yellow: #fbbf24;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
  font-family: 'Manrope', sans-serif;
  background: var(--bg);
  color: var(--text);
  height: 100dvh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  display: flex;
  align-items: center;
  padding: 10px 14px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  gap: 10px;
  flex-shrink: 0;
  z-index: 10;
}

.model-selector {
  display: flex;
  align-items: center;
  gap: 8px;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 22px;
  padding: 7px 14px 7px 10px;
  cursor: pointer;
  flex: 1;
  transition: all 0.15s;
  min-width: 0;
}
.model-selector:active { opacity: 0.8; transform: scale(0.98); }

.model-avatar {
  width: 28px; height: 28px;
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
  overflow: hidden;
}
.model-avatar svg { width: 20px; height: 20px; }

.model-selector-info { flex: 1; min-width: 0; }
.model-selector-name {
  font-size: 14px; font-weight: 700;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  color: var(--text);
}
.model-selector-sub {
  font-size: 10px; color: var(--text2); margin-top: 1px;
}

.chevron { color: var(--text3); font-size: 10px; flex-shrink: 0; }

.header-actions { display: flex; gap: 6px; flex-shrink: 0; }
.header-btn {
  width: 36px; height: 36px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text2);
  transition: all 0.15s;
  font-size: 16px;
}
.header-btn:active { opacity: 0.7; transform: scale(0.95); }

/* ‚îÄ‚îÄ MODEL PICKER SHEET ‚îÄ‚îÄ */
.sheet-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 100;
  opacity: 0; pointer-events: none;
  transition: opacity 0.25s;
}
.sheet-overlay.open { opacity: 1; pointer-events: all; }

.sheet {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  z-index: 101;
  max-height: 80dvh;
  display: flex; flex-direction: column;
  transform: translateY(100%);
  transition: transform 0.3s cubic-bezier(0.32,0.72,0,1);
}
.sheet.open { transform: translateY(0); }

.sheet-handle {
  width: 36px; height: 4px;
  background: var(--border2);
  border-radius: 2px;
  margin: 10px auto 0;
  flex-shrink: 0;
}

.sheet-header {
  padding: 14px 16px 10px;
  flex-shrink: 0;
}
.sheet-title { font-size: 17px; font-weight: 800; }
.sheet-sub { font-size: 12px; color: var(--text2); margin-top: 2px; }

.sheet-search {
  padding: 0 16px 10px;
  flex-shrink: 0;
}
.sheet-search input {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 9px 14px 9px 36px;
  color: var(--text);
  font-family: 'Manrope', sans-serif;
  font-size: 14px;
  outline: none;
}
.sheet-search input::placeholder { color: var(--text3); }
.search-icon-wrap {
  position: relative;
}
.search-icon-wrap svg {
  position: absolute; left: 26px; top: 50%;
  transform: translateY(-50%);
  color: var(--text3);
  pointer-events: none;
}

.sheet-cats {
  display: flex; gap: 6px;
  padding: 0 16px 10px;
  overflow-x: auto; scrollbar-width: none;
  flex-shrink: 0;
}
.sheet-cats::-webkit-scrollbar { display: none; }

.cat-pill {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 5px 12px;
  font-size: 12px; font-weight: 600;
  color: var(--text2);
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.15s;
  flex-shrink: 0;
}
.cat-pill.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
}

.sheet-list {
  overflow-y: auto;
  flex: 1;
  padding-bottom: calc(env(safe-area-inset-bottom) + 10px);
}

.model-row {
  display: flex; align-items: center;
  padding: 11px 16px;
  cursor: pointer;
  transition: background 0.12s;
  border-bottom: 1px solid var(--border);
  gap: 12px;
}
.model-row:active { background: rgba(255,255,255,0.04); }
.model-row.selected { background: rgba(91,110,245,0.1); }
.model-row.selected::before {
  content: ''; position: absolute; left: 0;
  width: 3px; height: 100%;
  background: var(--accent);
  border-radius: 0 2px 2px 0;
}
.model-row { position: relative; }

.row-avatar {
  width: 44px; height: 44px;
  border-radius: 13px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
  overflow: hidden;
}
.row-avatar svg { width: 28px; height: 28px; }

.row-info { flex: 1; min-width: 0; }
.row-name {
  font-size: 15px; font-weight: 700;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.row-desc {
  font-size: 12px; color: var(--text2);
  line-height: 1.4;
  display: -webkit-box;
  -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden;
  margin-top: 2px;
}
.row-right {
  display: flex; flex-direction: column;
  align-items: flex-end; gap: 5px;
  flex-shrink: 0;
}
.check { width: 20px; height: 20px; border-radius: 50%; background: var(--accent);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; transform: scale(0.6); transition: all 0.2s;
}
.model-row.selected .check { opacity: 1; transform: scale(1); }
.vision-tag {
  font-size: 9px; font-weight: 700;
  background: rgba(251,191,36,0.15);
  color: var(--yellow);
  border: 1px solid rgba(251,191,36,0.3);
  padding: 2px 6px; border-radius: 5px;
  letter-spacing: 0.3px;
}
.section-label {
  padding: 12px 16px 5px;
  font-size: 10px; font-weight: 700;
  color: var(--text3);
  letter-spacing: 1px;
  text-transform: uppercase;
}

/* ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ */
.chat-area {
  flex: 1;
  overflow-y: auto;
  padding: 12px 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  scrollbar-width: thin;
  scrollbar-color: var(--surface3) transparent;
}

.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  padding: 20px;
  text-align: center;
}
.empty-icon {
  width: 64px; height: 64px;
  border-radius: 20px;
  background: var(--surface2);
  border: 1px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  font-size: 30px;
}
.empty-title { font-size: 20px; font-weight: 800; }
.empty-sub { font-size: 13px; color: var(--text2); line-height: 1.5; }

.suggestions {
  display: flex; gap: 8px;
  overflow-x: auto; scrollbar-width: none;
  padding-bottom: 2px;
  width: 100%;
}
.suggestions::-webkit-scrollbar { display: none; }
.sugg-chip {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 14px;
  padding: 10px 14px;
  font-size: 12px; font-weight: 600;
  color: var(--text2);
  white-space: nowrap;
  cursor: pointer;
  flex-shrink: 0;
  max-width: 160px;
  white-space: normal;
  line-height: 1.3;
  transition: all 0.15s;
}
.sugg-chip:active { background: var(--surface3); }

/* Messages */
.msg { display: flex; flex-direction: column; max-width: 88%; animation: fadeUp 0.25s ease both; }
@keyframes fadeUp { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform:none; } }

.msg.user { align-self: flex-end; }
.msg.ai   { align-self: flex-start; }

.bubble {
  padding: 10px 14px;
  border-radius: 18px;
  font-size: 14px; line-height: 1.55;
  word-break: break-word;
}
.msg.user .bubble {
  background: var(--user-bubble);
  border: 1px solid var(--user-border);
  border-bottom-right-radius: 5px;
  color: #e8ecff;
}
.msg.ai .bubble {
  background: var(--ai-bubble);
  border: 1px solid var(--border);
  border-bottom-left-radius: 5px;
}

.msg-img {
  max-width: 100%; border-radius: 12px;
  margin-bottom: 6px;
  border: 1px solid var(--border);
}

.msg-meta {
  font-size: 10px; color: var(--text3);
  margin-top: 3px;
  padding: 0 4px;
}
.msg.user .msg-meta { text-align: right; }
.msg.ai   .msg-meta { text-align: left; }

/* AI label */
.ai-label {
  display: flex; align-items: center; gap: 5px;
  font-size: 10px; font-weight: 700;
  color: var(--text3);
  margin-bottom: 4px;
  padding: 0 2px;
}
.ai-dot {
  width: 20px; height: 20px;
  border-radius: 5px;
  display: flex; align-items: center; justify-content: center;
  font-size: 9px;
  overflow: hidden;
}
.ai-dot svg { width: 14px; height: 14px; }

/* Typing indicator */
.typing-bubble {
  display: flex; gap: 4px;
  align-items: center;
  padding: 12px 16px;
}
.typing-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--text3);
  animation: blink 1.2s ease infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink {
  0%,80%,100% { transform: scale(1); opacity: 0.5; }
  40% { transform: scale(1.3); opacity: 1; }
}

/* code blocks */
.bubble pre {
  background: #0d0d14;
  border: 1px solid var(--border2);
  border-radius: 10px;
  padding: 10px 12px;
  overflow-x: auto;
  margin: 8px 0;
  font-size: 12px;
  font-family: 'SF Mono', monospace;
  line-height: 1.6;
}
.bubble code {
  background: rgba(255,255,255,0.08);
  padding: 1px 5px;
  border-radius: 4px;
  font-size: 12px;
  font-family: 'SF Mono', monospace;
}
.bubble pre code { background: none; padding: 0; }
.bubble p { margin-bottom: 6px; }
.bubble p:last-child { margin-bottom: 0; }
.bubble strong { color: #fff; font-weight: 700; }

/* ‚îÄ‚îÄ INPUT BAR ‚îÄ‚îÄ */
.input-bar {
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 8px 10px;
  padding-bottom: calc(8px + env(safe-area-inset-bottom));
  flex-shrink: 0;
}

.input-row {
  display: flex; align-items: flex-end; gap: 7px;
}

.attach-btn, .send-btn {
  width: 40px; height: 40px;
  border-radius: 13px;
  border: none;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
  transition: all 0.15s;
}
.attach-btn {
  background: var(--surface2);
  color: var(--text2);
  font-size: 18px;
}
.attach-btn:active { opacity: 0.7; }

.send-btn {
  background: var(--accent);
  color: #fff;
  font-size: 17px;
}
.send-btn:active { transform: scale(0.92); }
.send-btn:disabled { background: var(--surface3); color: var(--text3); }

.input-wrap {
  flex: 1;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 16px;
  display: flex; align-items: flex-end;
  padding: 8px 12px;
  gap: 6px;
  min-height: 40px;
  transition: border-color 0.2s;
}
.input-wrap:focus-within { border-color: rgba(91,110,245,0.5); }

#msgInput {
  flex: 1;
  background: none;
  border: none;
  outline: none;
  color: var(--text);
  font-family: 'Manrope', sans-serif;
  font-size: 14px;
  line-height: 1.5;
  resize: none;
  max-height: 120px;
  min-height: 20px;
}
#msgInput::placeholder { color: var(--text3); }

/* image preview strip */
.img-preview {
  display: flex; gap: 6px;
  margin-bottom: 6px;
}
.preview-thumb {
  position: relative;
  width: 56px; height: 56px;
}
.preview-thumb img {
  width: 56px; height: 56px;
  border-radius: 10px;
  object-fit: cover;
  border: 1px solid var(--border2);
}
.preview-rm {
  position: absolute; top: -5px; right: -5px;
  width: 18px; height: 18px;
  border-radius: 50%;
  background: var(--red);
  color: #fff;
  font-size: 11px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  border: 1.5px solid var(--bg);
}

/* vision hint bar */
.vision-hint {
  background: rgba(251,191,36,0.08);
  border: 1px solid rgba(251,191,36,0.2);
  border-radius: 10px;
  padding: 7px 12px;
  font-size: 11px;
  color: #fbbf24;
  font-weight: 600;
  margin-bottom: 6px;
  display: flex; align-items: center; gap: 6px;
}

/* limit bar */
.limit-bar {
  display: flex; gap: 8px; align-items: center;
  padding: 6px 10px;
  background: var(--surface2);
  border-radius: 10px;
  margin-bottom: 6px;
  font-size: 11px; color: var(--text2);
}
.limit-item { display: flex; gap: 4px; align-items: center; }
.limit-dot { width: 6px; height: 6px; border-radius: 50%; }

/* file input hidden */
#fileInput { display: none; }

/* Avatar colors */
.av-claude  { background: linear-gradient(135deg,#d4845a,#c9512f); }
.av-gpt     { background: linear-gradient(135deg,#10a37f,#0a7a5f); }
.av-deepseek{ background: linear-gradient(135deg,#4e6ef2,#2a42c4); }
.av-qwen    { background: linear-gradient(135deg,#8b5cf6,#6d28d9); }
.av-llama   { background: linear-gradient(135deg,#f59e0b,#d97706); }
.av-command { background: linear-gradient(135deg,#6b7280,#374151); }
.av-kimi    { background: linear-gradient(135deg,#ec4899,#be185d); }
.av-glm     { background: linear-gradient(135deg,#a78bfa,#7c3aed); }
.av-c4ai    { background: linear-gradient(135deg,#06b6d4,#0891b2); }
.av-sonar   { background: linear-gradient(135deg,#f97316,#ea580c); }

/* toast */
.toast {
  position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: var(--surface3);
  border: 1px solid var(--border2);
  border-radius: 12px;
  padding: 8px 16px;
  font-size: 13px; font-weight: 600;
  opacity: 0;
  transition: all 0.25s;
  white-space: nowrap;
  z-index: 200;
  pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ‚îÄ‚îÄ MODEL ICONS ‚îÄ‚îÄ */
.av-claude  { background: linear-gradient(135deg,#667eea,#764ba2); }
.av-gpt     { background: linear-gradient(135deg,#11998e,#38ef7d); }
.av-deepseek{ background: linear-gradient(135deg,#2193b0,#6dd5ed); }
.av-qwen    { background: linear-gradient(135deg,#f7971e,#ffd200); }
.av-llama   { background: linear-gradient(135deg,#834d9b,#d04ed6); }
.av-command { background: linear-gradient(135deg,#1a1a2e,#16213e); border:1px solid rgba(255,255,255,0.15); }
.av-kimi    { background: linear-gradient(135deg,#0f3460,#533483); }
.av-glm     { background: linear-gradient(135deg,#6a3093,#a044ff); }
.av-c4ai    { background: linear-gradient(135deg,#f953c6,#b91d73); }
.av-sonar   { background: linear-gradient(135deg,#4facfe,#00f2fe); }

/* ‚îÄ‚îÄ THINK TIMER ‚îÄ‚îÄ */
.think-timer {
  display: flex; align-items: center; gap: 8px;
  padding: 10px 14px;
  background: rgba(91,110,245,0.08);
  border: 1px solid rgba(91,110,245,0.2);
  border-radius: 14px;
  font-size: 13px; color: var(--text2);
}
.think-timer .timer-icon { font-size: 16px; animation: spin 2s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.think-timer .timer-secs { font-weight: 700; color: var(--accent2); font-size: 15px; min-width: 28px; }

/* ‚îÄ‚îÄ CODE BLOCKS ‚îÄ‚îÄ */
.code-wrapper {
  position: relative;
  margin: 8px 0;
  border-radius: 10px;
  overflow: hidden;
}
.code-header {
  display: flex; justify-content: space-between; align-items: center;
  background: #1a1b26;
  padding: 6px 12px;
  font-size: 11px; color: rgba(255,255,255,0.5);
  font-family: monospace;
}
.copy-btn {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.15);
  color: rgba(255,255,255,0.7);
  padding: 3px 10px;
  border-radius: 5px;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.15s;
  font-family: 'Manrope', sans-serif;
}
.copy-btn:active, .copy-btn.copied { background: rgba(52,211,153,0.2); color: #34d399; }
.code-wrapper pre {
  margin: 0 !important;
  border-radius: 0 0 10px 10px !important;
  background: #1a1b26 !important;
  padding: 12px !important;
  overflow-x: auto;
  font-size: 12px !important;
}
.code-wrapper pre code { font-family: "SF Mono", "Fira Code", monospace !important; }

/* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
.bubble table {
  border-collapse: collapse;
  width: 100%; margin: 8px 0;
  font-size: 13px;
  border-radius: 8px; overflow: hidden;
}
.bubble th {
  background: var(--accent);
  color: #fff;
  padding: 8px 12px;
  text-align: left; font-weight: 700;
}
.bubble td {
  padding: 7px 12px;
  border-bottom: 1px solid var(--border);
}
.bubble tr:nth-child(even) td { background: rgba(255,255,255,0.03); }
.bubble tr:last-child td { border-bottom: none; }

/* ‚îÄ‚îÄ KATEX ‚îÄ‚îÄ */
.katex { font-size: 1em !important; }
.katex-display { overflow-x: auto; padding: 4px 0; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="model-selector" id="modelSelector">
    <div class="model-avatar av-claude" id="hdrAvatar">üî∑</div>
    <div class="model-selector-info">
      <div class="model-selector-name" id="hdrName">Claude Sonnet 4.5</div>
      <div class="model-selector-sub" id="hdrSub">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å</div>
    </div>
    <div class="chevron">‚ñº</div>
  </div>
  <div class="header-actions">
    <div class="header-btn" id="clearBtn" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">üóë</div>
  </div>
</div>

<!-- CHAT -->
<div class="chat-area" id="chatArea">
  <div class="empty-state" id="emptyState">
    <div class="empty-icon">ü§ñ</div>
    <div class="empty-title">–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
    <div class="empty-sub">–í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å –≤–≤–µ—Ä—Ö—É –∏ –Ω–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å ‚Äî –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Vision</div>
    <div class="suggestions" id="suggestions">
      <div class="sugg-chip">–û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</div>
      <div class="sugg-chip">–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–ø–∏—Å–∫–∞</div>
      <div class="sugg-chip">–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π</div>
      <div class="sugg-chip">–ü—Ä–∏–¥—É–º–∞–π –∏–¥–µ–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –≤ 2025</div>
    </div>
  </div>
</div>

<!-- INPUT -->
<div class="input-bar" id="inputBar">
  <div class="vision-hint" id="visionHint" style="display:none">
    üì∏ –≠—Ç–∞ –º–æ–¥–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ ‚Äî –Ω–∞–∂–º–∏ üìé —á—Ç–æ–±—ã –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å
  </div>
  <div class="img-preview" id="imgPreview" style="display:none"></div>
  <div class="limit-bar" id="limitBar" style="display:none">
    <span>üìä –ó–∞–ø—Ä–æ—Å—ã:</span>
    <span class="limit-item"><span class="limit-dot" style="background:#34d399"></span><span id="fastLeft">‚Äî</span> –±—ã—Å—Ç—Ä—ã—Ö</span>
    <span class="limit-item"><span class="limit-dot" style="background:#5b6ef5"></span><span id="proLeft">‚Äî</span> –ø—Ä–æ—Ñ.</span>
  </div>
  <div class="input-row">
    <button class="attach-btn" id="attachBtn">üìé</button>
    <div class="input-wrap">
      <textarea id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
    </div>
    <button class="send-btn" id="sendBtn" disabled>‚Üë</button>
  </div>
</div>

<!-- MODEL SHEET -->
<div class="sheet-overlay" id="sheetOverlay"></div>
<div class="sheet" id="sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">–í—ã–±–æ—Ä –Ω–µ–π—Ä–æ—Å–µ—Ç–∏</div>
    <div class="sheet-sub">–í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å –¥–ª—è –æ–±—â–µ–Ω–∏—è</div>
  </div>
  <div class="sheet-search">
    <div class="search-icon-wrap">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
      </svg>
      <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –º–æ–¥–µ–ª–∏...">
    </div>
  </div>
  <div class="sheet-cats" id="sheetCats"></div>
  <div class="sheet-list" id="sheetList"></div>
</div>

<input type="file" id="fileInput" accept="image/*">
<div class="toast" id="toast"></div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// ‚îÄ‚îÄ –ò–∫–æ–Ω–∫–∏ –º–æ–¥–µ–ª–µ–π (SVG/PNG —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–µ URL) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MODEL_ICONS = {
  claude_sonnet: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#CC785C"/><path d="M8 12.5c1-2 3-3.5 4-3.5s3 1.5 4 3.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><circle cx="9" cy="9.5" r="1" fill="white"/><circle cx="15" cy="9.5" r="1" fill="white"/></svg>`,
  claude_haiku:  `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#CC785C"/><path d="M9 12.5c.8-1.5 1.8-2.5 3-2.5s2.2 1 3 2.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><circle cx="9.5" cy="10" r="0.8" fill="white"/><circle cx="14.5" cy="10" r="0.8" fill="white"/></svg>`,
  claude_opus:   `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#8B4513"/><path d="M7.5 13c1.5-3 3-4.5 4.5-4.5s3 1.5 4.5 4.5" stroke="white" stroke-width="2" stroke-linecap="round"/><circle cx="8.5" cy="9" r="1.2" fill="white"/><circle cx="15.5" cy="9" r="1.2" fill="white"/></svg>`,
  gpt52:         `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#10a37f"/><path d="M12 6.5A5.5 5.5 0 0112 17.5M8.5 8.5a5.5 5.5 0 017 7M7 12h10" stroke="white" stroke-width="1.4" stroke-linecap="round"/></svg>`,
  gpt52_chat:    `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#10a37f"/><path d="M7 9h10M7 13h7" stroke="white" stroke-width="1.8" stroke-linecap="round"/><circle cx="17" cy="15" r="2" fill="white"/></svg>`,
  deepseek_v3:   `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#1e4d8c"/><path d="M7 12c0-2.8 2.2-5 5-5s5 2.2 5 5-2.2 5-5 5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><circle cx="12" cy="12" r="2" fill="white"/></svg>`,
  deepseek_r1:   `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#0f2d5e"/><path d="M9 8l2 4-2 4M15 8l-2 4 2 4" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
  deepseek_v3_sq:`<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#1a3a6b"/><path d="M7 12c0-2.8 2.2-5 5-5s5 2.2 5 5-2.2 5-5 5" stroke="white" stroke-width="1.5" stroke-linecap="round"/><circle cx="12" cy="12" r="2" fill="white"/></svg>`,
  qwen3_max:     `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#FF6A00"/><text x="12" y="16" text-anchor="middle" font-size="9" fill="white" font-weight="bold">Q</text></svg>`,
  qwen3_vl:      `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#FF8C00"/><ellipse cx="12" cy="12" rx="5" ry="3.5" stroke="white" stroke-width="1.5"/><circle cx="12" cy="12" r="1.5" fill="white"/></svg>`,
  qwen_vision:   `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#e65c00"/><ellipse cx="12" cy="12" rx="5" ry="3.5" stroke="white" stroke-width="1.5"/><circle cx="12" cy="12" r="2" fill="white"/></svg>`,
  llama32_90b:   `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#7B2D8B"/><path d="M9 8v8M12 8v8M15 8v8" stroke="white" stroke-width="1.5" stroke-linecap="round"/><path d="M9 12h6" stroke="white" stroke-width="1.5"/></svg>`,
  command_a:     `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#2c3e50"/><path d="M9 8l5 4-5 4" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>`,
  command_vision:`<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#34495e"/><ellipse cx="12" cy="12" rx="4" ry="3" stroke="white" stroke-width="1.5"/><circle cx="12" cy="12" r="1.2" fill="white"/></svg>`,
  command_reason:`<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#1a252f"/><path d="M8 10h8M8 14h5" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>`,
  moonshot:      `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#1a237e"/><path d="M15 8A6 6 0 009 8a6 6 0 000 8 6 6 0 006 0" stroke="white" stroke-width="1.5" stroke-linecap="round"/></svg>`,
  glm47:         `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#6a1b9a"/><text x="12" y="16" text-anchor="middle" font-size="8" fill="white" font-weight="bold">GLM</text></svg>`,
  glm46:         `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#7b1fa2"/><text x="12" y="16" text-anchor="middle" font-size="8" fill="white" font-weight="bold">GLM</text></svg>`,
  c4ai_32b:      `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#e91e8c"/><path d="M8 12a4 4 0 108 0" stroke="white" stroke-width="1.8" stroke-linecap="round"/><circle cx="12" cy="8" r="1" fill="white"/></svg>`,
  c4ai_8b:       `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#c2185b"/><path d="M8 12a4 4 0 108 0" stroke="white" stroke-width="1.8" stroke-linecap="round"/><circle cx="12" cy="8" r="1" fill="white"/></svg>`,
  c4ai_vis32b:   `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#ad1457"/><path d="M8 12a4 4 0 108 0" stroke="white" stroke-width="1.5" stroke-linecap="round"/><ellipse cx="12" cy="12" rx="2" ry="1.5" fill="white"/></svg>`,
  c4ai_vis8b:    `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#880e4f"/><path d="M8 12a4 4 0 108 0" stroke="white" stroke-width="1.5" stroke-linecap="round"/><ellipse cx="12" cy="12" rx="2" ry="1.5" fill="white"/></svg>`,
  sonar:         `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#0369a1"/><circle cx="12" cy="12" r="2" fill="white"/><path d="M12 12 L18 6M12 12 L6 18" stroke="white" stroke-width="1.2" stroke-linecap="round"/></svg>`,
  sonar_pro:     `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#0284c7"/><circle cx="12" cy="12" r="2.5" fill="white"/><path d="M12 12 L18 6M12 12 L6 18M12 12 L18 18" stroke="white" stroke-width="1.2" stroke-linecap="round"/></svg>`,
};

function getModelIcon(key) {
  return MODEL_ICONS[key] || `<svg viewBox="0 0 24 24" fill="none" width="18" height="18"><circle cx="12" cy="12" r="10" fill="#5b6ef5"/><text x="12" y="16" text-anchor="middle" font-size="10" fill="white">AI</text></svg>`;
}

// ‚îÄ‚îÄ –ú–æ–¥–µ–ª–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MODELS = [
  { key:"claude_sonnet", name:"Claude Sonnet 4.5", av:"av-claude", cat:"Claude", desc:"–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å ‚Äî —É–º–Ω–∞—è, –±—ã—Å—Ç—Ä–∞—è, –¥–µ—Ç–∞–ª—å–Ω–∞—è" },
  { key:"claude_haiku",  name:"Claude Haiku 4.5",  av:"av-claude", cat:"Claude", desc:"–°–∞–º–∞—è –±—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è Claude" },
  { key:"claude_opus",   name:"Claude Opus 4.5",   av:"av-claude", cat:"Claude", desc:"–¢–æ–ø–æ–≤–∞—è –º–æ–¥–µ–ª—å Anthropic ‚Äî –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑" },
  { key:"gpt52",         name:"GPT-5.2",           av:"av-gpt",    cat:"GPT",    desc:"–ù–æ–≤–µ–π—à–∞—è –º–æ–¥–µ–ª—å –æ—Ç OpenAI" },
  { key:"gpt52_chat",    name:"GPT-5.2 Chat",      av:"av-gpt",    cat:"GPT",    desc:"GPT-5.2 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤" },
  { key:"deepseek_v3",   name:"DeepSeek V3.2",     av:"av-deepseek",cat:"DeepSeek",desc:"–£–º–Ω–µ–π—à–∞—è –∫–∏—Ç–∞–π—Å–∫–∞—è –º–æ–¥–µ–ª—å ‚Äî –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç OpenAI o1" },
  { key:"deepseek_r1",   name:"DeepSeek R1",       av:"av-deepseek",cat:"DeepSeek",desc:"Reasoning-–º–æ–¥–µ–ª—å —Å —Ü–µ–ø–æ—á–∫–æ–π —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π" },
  { key:"deepseek_v3_sq",name:"DeepSeek V3",       av:"av-deepseek",cat:"DeepSeek",desc:"–°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è DeepSeek V3" },
  { key:"qwen3_max",     name:"Qwen3-Max",         av:"av-qwen",   cat:"Qwen",   desc:"–§–ª–∞–≥–º–∞–Ω—Å–∫–∞—è –º–æ–¥–µ–ª—å Alibaba ‚Äî –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è" },
  { key:"qwen3_vl",      name:"Qwen3-VL",          av:"av-qwen",   cat:"Qwen",   desc:"Vision –º–æ–¥–µ–ª—å ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è üì∏", vision:true },
  { key:"qwen_vision",   name:"Qwen2.5-VL 32B",    av:"av-qwen",   cat:"Qwen",   desc:"–ú–æ—â–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ üì∏", vision:true },
  { key:"llama32_90b",   name:"Llama 3.2 90B",     av:"av-llama",  cat:"Llama",  desc:"Open-source –≥–∏–≥–∞–Ω—Ç –æ—Ç Meta ‚Äî Vision üì∏", vision:true },
  { key:"command_a",     name:"Command-A",         av:"av-command",cat:"Command", desc:"–ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å –æ—Ç Cohere" },
  { key:"command_vision",name:"Command Vision",    av:"av-command",cat:"Command", desc:"Command —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π üì∏", vision:true },
  { key:"command_reason",name:"Command Reasoning", av:"av-command",cat:"Command", desc:"–£–≥–ª—É–±–ª—ë–Ω–Ω–æ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á" },
  { key:"moonshot",      name:"Kimi K2",           av:"av-kimi",   cat:"Kimi",   desc:"–ú–æ–¥–µ–ª—å –æ—Ç Moonshot AI ‚Äî –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ" },
  { key:"glm47",         name:"GLM-4.7",           av:"av-glm",    cat:"GLM",    desc:"–ù–æ–≤–µ–π—à–∞—è –≤–µ—Ä—Å–∏—è GLM —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ–º" },
  { key:"glm46",         name:"GLM-4.6",           av:"av-glm",    cat:"GLM",    desc:"–°—Ç–∞–±–∏–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å GLM-4.6" },
  { key:"c4ai_32b",      name:"C4AI Aya 32B",      av:"av-c4ai",   cat:"C4AI",   desc:"–ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –º–æ–¥–µ–ª—å ‚Äî 32B –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, 23 —è–∑—ã–∫–∞" },
  { key:"c4ai_8b",       name:"C4AI Aya 8B",       av:"av-c4ai",   cat:"C4AI",   desc:"–õ—ë–≥–∫–∞—è –∏ –±—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è Aya ‚Äî 8B –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤" },
  { key:"c4ai_vis32b",   name:"C4AI Vision 32B",   av:"av-c4ai",   cat:"C4AI",   desc:"Vision –≤–µ—Ä—Å–∏—è Aya 32B ‚Äî –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π üì∏", vision:true },
  { key:"c4ai_vis8b",    name:"C4AI Vision 8B",    av:"av-c4ai",   cat:"C4AI",   desc:"–ë—ã—Å—Ç—Ä–∞—è Vision –≤–µ—Ä—Å–∏—è Aya 8B üì∏", vision:true },
  { key:"sonar",         name:"Sonar",             av:"av-sonar",  cat:"Sonar",  desc:"Perplexity Sonar ‚Äî –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ + –ò–ò" },
  { key:"sonar_pro",     name:"Sonar Pro",         av:"av-sonar",  cat:"Sonar",  desc:"–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –≥–ª—É–±–æ–∫–∏–º –ø–æ–∏—Å–∫–æ–º" },
];

const CATS = ["–í—Å–µ", "Claude", "GPT", "DeepSeek", "Qwen", "Llama", "Command", "Kimi", "GLM", "C4AI", "Sonar"];

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const params = new URLSearchParams(location.search);
let curModel  = params.get("model") || "claude_sonnet";
let sheetOpen = false;
let catFilter = "–í—Å–µ";
let searchQ   = "";
let pendingImgs = []; // [{file, b64, url}]
let messages  = [];   // [{role, content, imgUrl?}]
let isLoading = false;

// ‚îÄ‚îÄ API Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// –ó–∞–º–µ–Ω–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π URL —Ç–≤–æ–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (–≥–¥–µ –∑–∞–ø—É—â–µ–Ω –±–æ—Ç)
// –ù–∞–ø—Ä–∏–º–µ—Ä: "https://yourserver.com" –∏–ª–∏ "http://1.2.3.4:8080"
const API_BASE = params.get("api") || window.TG_API_BASE || "http://localhost:8080";
// –ü–æ–ª—É—á–∞–µ–º uid –∏–∑ Telegram ‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
let USER_ID = 0;
try {
  // –°–ø–æ—Å–æ–± 1: –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø
  if (tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.id) {
    USER_ID = tg.initDataUnsafe.user.id;
  }
  // –°–ø–æ—Å–æ–± 2: –ø–∞—Ä—Å–∏–º initData —Å—Ç—Ä–æ–∫—É
  if (!USER_ID && tg.initData) {
    const parsed = new URLSearchParams(tg.initData);
    const userStr = parsed.get("user");
    if (userStr) {
      const userObj = JSON.parse(decodeURIComponent(userStr));
      USER_ID = userObj.id || 0;
    }
  }
  // –°–ø–æ—Å–æ–± 3: –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–∫–æ–≥–¥–∞ –±–æ—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å ?uid=)
  if (!USER_ID) {
    USER_ID = parseInt(params.get("uid") || "0");
  }
} catch(e) {
  console.warn("USER_ID parse error:", e);
}
console.log("USER_ID:", USER_ID);

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
updateHeader();
renderCats();
renderModels();

// Load limits from URL
const fl = params.get("fast_left"), pl = params.get("pro_left");
if (fl !== null || pl !== null) {
  document.getElementById("limitBar").style.display = "flex";
  document.getElementById("fastLeft").textContent = fl ?? "‚Äî";
  document.getElementById("proLeft").textContent  = pl ?? "‚Äî";
}

// ‚îÄ‚îÄ Suggestion chips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll(".sugg-chip").forEach(chip => {
  chip.addEventListener("click", () => {
    const input = document.getElementById("msgInput");
    input.value = chip.textContent.trim();
    input.dispatchEvent(new Event("input"));
    input.focus();
  });
});

// ‚îÄ‚îÄ Header model ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getModel(key) {
  return MODELS.find(m => m.key === key) || MODELS[0];
}
function updateHeader() {
  const m = getModel(curModel);
  const av = document.getElementById("hdrAvatar");
  av.className = `model-avatar ${m.av}`;
  av.innerHTML = getModelIcon(m.key);
  document.getElementById("hdrName").textContent = m.name;
  document.getElementById("hdrSub").textContent  = m.vision ? "üì∏ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ç–æ" : "–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å";
  const vh = document.getElementById("visionHint");
  vh.style.display = m.vision ? "flex" : "none";
}

// ‚îÄ‚îÄ Sheet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("modelSelector").addEventListener("click", openSheet);
document.getElementById("sheetOverlay").addEventListener("click", closeSheet);

function openSheet() {
  sheetOpen = true;
  document.getElementById("sheetOverlay").classList.add("open");
  document.getElementById("sheet").classList.add("open");
  document.getElementById("searchInput").value = "";
  searchQ = ""; catFilter = "–í—Å–µ";
  renderCats(); renderModels();
}
function closeSheet() {
  sheetOpen = false;
  document.getElementById("sheetOverlay").classList.remove("open");
  document.getElementById("sheet").classList.remove("open");
}

function renderCats() {
  const wrap = document.getElementById("sheetCats");
  wrap.innerHTML = CATS.map(c =>
    `<div class="cat-pill${c===catFilter?" active":""}" onclick="setCat('${c}')">${c}</div>`
  ).join("");
}
function setCat(c) { catFilter = c; renderCats(); renderModels(); }

document.getElementById("searchInput").addEventListener("input", e => {
  searchQ = e.target.value.toLowerCase();
  if (searchQ) catFilter = "–í—Å–µ";
  renderCats(); renderModels();
});

function renderModels() {
  const list = document.getElementById("sheetList");
  let filtered = MODELS.filter(m => {
    const matchCat = catFilter === "–í—Å–µ" || m.cat === catFilter;
    const matchQ   = !searchQ || m.name.toLowerCase().includes(searchQ) || m.desc.toLowerCase().includes(searchQ);
    return matchCat && matchQ;
  });

  if (!filtered.length) {
    list.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text3)">üòî –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
    return;
  }

  let html = "";
  let lastCat = null;
  filtered.forEach(m => {
    if (catFilter === "–í—Å–µ" && !searchQ && m.cat !== lastCat) {
      html += `<div class="section-label">${m.cat}</div>`;
      lastCat = m.cat;
    }
    const sel = m.key === curModel;
    html += `
      <div class="model-row${sel?" selected":""}" onclick="selectModel('${m.key}')">
        <div class="row-avatar ${m.av}">${getModelIcon(m.key)}</div>
        <div class="row-info">
          <div class="row-name">${m.name}</div>
          <div class="row-desc">${m.desc}</div>
        </div>
        <div class="row-right">
          <div class="check"><svg width="10" height="10" viewBox="0 0 12 12"><path d="M2 6l3 3 5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></div>
          ${m.vision ? '<span class="vision-tag">üì∏ VISION</span>' : ''}
        </div>
      </div>`;
  });
  list.innerHTML = html;
}

function selectModel(key) {
  if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
  curModel = key;
  updateHeader();
  renderModels();
  closeSheet();
  // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ ‚Äî –º–æ–¥–µ–ª—å –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ
  {
    // Mini app not opened via KeyboardButton ‚Äî just update UI
  }
  showToast(`‚úÖ ${getModel(key).name}`);
}

// ‚îÄ‚îÄ Clear chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("clearBtn").addEventListener("click", () => {
  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
  messages = [];
  pendingImgs = [];
  renderImgPreview();
  const area = document.getElementById("chatArea");
  area.innerHTML = document.querySelector(".empty-state") ? "" : "";
  // Re-create empty state
  area.innerHTML = `
    <div class="empty-state" id="emptyState">
      <div class="empty-icon">ü§ñ</div>
      <div class="empty-title">–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
      <div class="empty-sub">–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ</div>
      <div class="suggestions" id="suggestions">
        <div class="sugg-chip">–û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</div>
        <div class="sugg-chip">–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–ø–∏—Å–∫–∞</div>
        <div class="sugg-chip">–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π</div>
        <div class="sugg-chip">–ü—Ä–∏–¥—É–º–∞–π –∏–¥–µ–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –≤ 2025</div>
      </div>
    </div>`;
  document.querySelectorAll(".sugg-chip").forEach(chip => {
    chip.addEventListener("click", () => {
      const input = document.getElementById("msgInput");
      input.value = chip.textContent.trim();
      input.dispatchEvent(new Event("input"));
      input.focus();
    });
  });
  showToast("üóë –ß–∞—Ç –æ—á–∏—â–µ–Ω");
});

// ‚îÄ‚îÄ Input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const msgInput = document.getElementById("msgInput");
msgInput.addEventListener("input", () => {
  msgInput.style.height = "auto";
  msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + "px";
  updateSendBtn();
});
msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function updateSendBtn() {
  const hasText = msgInput.value.trim().length > 0;
  const hasImg  = pendingImgs.length > 0;
  document.getElementById("sendBtn").disabled = (!hasText && !hasImg) || isLoading;
}

// ‚îÄ‚îÄ File attach ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("attachBtn").addEventListener("click", () => {
  const m = getModel(curModel);
  if (!m.vision) {
    showToast("‚ö†Ô∏è –≠—Ç–∞ –º–æ–¥–µ–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ");
    return;
  }
  document.getElementById("fileInput").click();
});

document.getElementById("fileInput").addEventListener("change", e => {
  const files = Array.from(e.target.files || []);
  files.forEach(file => {
    if (!file.type.startsWith("image/")) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const b64full = ev.target.result; // data:image/jpeg;base64,...
      const b64 = b64full.split(",")[1];
      pendingImgs.push({ file, b64, url: b64full });
      renderImgPreview();
      updateSendBtn();
    };
    reader.readAsDataURL(file);
  });
  e.target.value = "";
});

function renderImgPreview() {
  const wrap = document.getElementById("imgPreview");
  if (!pendingImgs.length) { wrap.style.display = "none"; wrap.innerHTML = ""; return; }
  wrap.style.display = "flex";
  wrap.innerHTML = pendingImgs.map((img, i) => `
    <div class="preview-thumb">
      <img src="${img.url}" alt="—Ñ–æ—Ç–æ">
      <div class="preview-rm" onclick="removeImg(${i})">√ó</div>
    </div>`).join("");
}
function removeImg(i) {
  pendingImgs.splice(i, 1);
  renderImgPreview();
  updateSendBtn();
}

// ‚îÄ‚îÄ Send ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("sendBtn").addEventListener("click", sendMessage);

async function sendMessage() {
  if (isLoading) return;
  const text = msgInput.value.trim();
  const imgs  = [...pendingImgs];
  if (!text && !imgs.length) return;

  hideEmpty();
  isLoading = true;
  updateSendBtn();

  // Add user message to UI
  const imgUrls = imgs.map(i => i.url);
  addUserMsg(text, imgUrls);

  // Clear input
  msgInput.value = "";
  msgInput.style.height = "auto";
  pendingImgs = [];
  renderImgPreview();

  // Add think timer
  const timerId = addThinkTimer();

  // Store user message in history
  messages.push({ role: "user", content: text || (imgs.length ? "[–§–æ—Ç–æ]" : ""), imgUrls });

  // Build history for bot (last 10 messages)
  const historyForBot = messages.slice(-10).map(m => ({
    role: m.role,
    content: m.content
  }));

  const payload = {
    action: "chat",
    uid:    USER_ID,
    model:  curModel,
    text:   text || "",
    images: imgs.map(i => i.b64),
    history: historyForBot
  };

  try {
    const resp = await fetch(`${API_BASE}/api/chat`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const data = await resp.json();
    removeThinkTimer(timerId);

    if (data.ok) {
      addAiMsg(data.answer, data.model_label);
      // Update limits display
      if (data.fast_left !== undefined) {
        document.getElementById("limitBar").style.display = "flex";
        document.getElementById("fastLeft").textContent = data.fast_left;
        document.getElementById("proLeft").textContent  = data.pro_left;
      }
    } else if (data.error === "subscription_required") {
      // Show subscription required
      let chText = "\n\n–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª—ã:\n";
      (data.channels || []).forEach(ch => { chText += `‚Ä¢ ${ch.title}\n`; });
      addAiMsg("üîê –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –Ω—É–∂–Ω–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª!" + chText);
    } else if (data.error === "limit_exceeded") {
      addAiMsg(`üö´ –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω!\n‚è∞ –°–±—Ä–æ—Å —á–µ—Ä–µ–∑: ${data.reset_in || "?"}\n\n–û—Å—Ç–∞–ª–æ—Å—å: ‚ö°${data.fast_left} –±—ã—Å—Ç—Ä—ã—Ö | üß†${data.pro_left} –ø—Ä–æ—Ñ.`);
    } else {
      addAiMsg(`‚ùå –û—à–∏–±–∫–∞: ${data.error || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}`);
    }
  } catch(e) {
    removeThinkTimer(timerId);
    addAiMsg("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.\n\nüí° –ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –Ω–∞–ø—Ä—è–º—É—é –≤ —á–∞—Ç –±–æ—Ç–∞ ‚Äî –æ–Ω –æ—Ç–≤–µ—Ç–∏—Ç —Ç–∞–º.");
  }

  isLoading = false;
  updateSendBtn();
}

// ‚îÄ‚îÄ –û—Ç–≤–µ—Ç—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ fetch() ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ DOM helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function hideEmpty() {
  const e = document.getElementById("emptyState");
  if (e) e.remove();
}

function addUserMsg(text, imgUrls) {
  const area = document.getElementById("chatArea");
  const div = document.createElement("div");
  div.className = "msg user";
  let imgsHtml = imgUrls.map(u => `<img class="msg-img" src="${u}" alt="—Ñ–æ—Ç–æ">`).join("");
  div.innerHTML = `
    ${imgsHtml}
    ${text ? `<div class="bubble">${escHtml(text)}</div>` : ""}
    <div class="msg-meta">–í—ã ¬∑ ${timeNow()}</div>`;
  area.appendChild(div);
  scrollBottom();
}

function addAiMsg(text, modelLabel) {
  const area = document.getElementById("chatArea");
  const m = getModel(curModel);
  const displayName = modelLabel || m.name;
  const div = document.createElement("div");
  div.className = "msg ai";
  div.innerHTML = `
    <div class="ai-label">
      <div class="ai-dot ${m.av}">${getModelIcon(m.key)}</div>
      ${displayName}
    </div>
    <div class="bubble">${formatText(text)}</div>
    <div class="msg-meta">${displayName} ¬∑ ${timeNow()}</div>`;
  area.appendChild(div);
  messages.push({ role: "assistant", content: text });
  scrollBottom();
  // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–æ–¥–∞ highlight.js
  div.querySelectorAll("pre code").forEach(block => {
    hljs.highlightElement(block);
  });
  // –†–µ–Ω–¥–µ—Ä LaTeX —Ñ–æ—Ä–º—É–ª KaTeX
  try {
    renderMathInElement(div, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false},
        {left: "\\(", right: "\\)", display: false},
        {left: "\\[", right: "\\]", display: true}
      ],
      throwOnError: false
    });
  } catch(e) {}
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
  div.querySelectorAll(".copy-btn").forEach(btn => {
    btn.textContent = "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å";
  });
}

let timerCounter = 0;
let timerIntervals = {};

function addThinkTimer() {
  const id = ++timerCounter;
  const area = document.getElementById("chatArea");
  const div = document.createElement("div");
  div.className = "msg ai";
  div.id = `timer-${id}`;
  div.innerHTML = `
    <div class="bubble">
      <div class="think-timer">
        <span class="timer-icon">‚öôÔ∏è</span>
        <span>–î—É–º–∞—é...</span>
        <span class="timer-secs" id="secs-${id}">0</span>
        <span style="color:var(--text3);font-size:12px">—Å–µ–∫</span>
      </div>
    </div>`;
  area.appendChild(div);
  scrollBottom();
  let secs = 0;
  timerIntervals[id] = setInterval(() => {
    secs++;
    const el = document.getElementById(`secs-${id}`);
    if (el) el.textContent = secs;
  }, 1000);
  return id;
}

function removeThinkTimer(id) {
  clearInterval(timerIntervals[id]);
  delete timerIntervals[id];
  const el = document.getElementById(`timer-${id}`);
  if (el) el.remove();
}

function scrollBottom() {
  const area = document.getElementById("chatArea");
  area.scrollTop = area.scrollHeight;
}

function escHtml(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");
}

function formatText(rawText) {
  let text = rawText;

  // 1. Code blocks ‚Äî wrap with copy button + highlight.js
  let codeIdx = 0;
  const codePlaceholders = {};
  text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
    const id = "CODE_" + (codeIdx++);
    const escapedCode = escHtml(code.trim());
    const langLabel = lang ? lang.toUpperCase() : "CODE";
    codePlaceholders[id] = `<div class="code-wrapper">
      <div class="code-header">
        <span>${langLabel}</span>
        <button class="copy-btn" onclick="copyCode(this)">${escHtml(code.trim())}</button>
      </div>
      <pre><code class="${lang ? 'language-' + lang : ''}">${escapedCode}</code></pre>
    </div>`;
    return id;
  });

  // 2. Tables ‚Äî render markdown tables
  text = text.replace(/\n?((?:\|.+\|\n?)+)/g, (match) => {
    const lines = match.trim().split("\n").filter(l => l.trim());
    if (lines.length < 2) return match;
    const isSep = l => /^[\|\s\-:]+$/.test(l);
    let html = '<table>';
    let firstRow = true;
    for (const line of lines) {
      if (isSep(line)) continue;
      const cells = line.split("|").filter((_, i, a) => i > 0 && i < a.length - 1);
      if (firstRow) {
        html += '<tr>' + cells.map(c => `<th>${c.trim()}</th>`).join('') + '</tr>';
        firstRow = false;
      } else {
        html += '<tr>' + cells.map(c => `<td>${c.trim()}</td>`).join('') + '</tr>';
      }
    }
    html += '</table>';
    return html;
  });

  // 3. Bold, italic
  text = text.replace(/\*\*\*(.+?)\*\*\*/g, "<strong><em>$1</em></strong>");
  text = text.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
  text = text.replace(/\*(.+?)\*/g, "<em>$1</em>");

  // 4. Headers
  text = text.replace(/^###\s+(.+)$/gm, "<h4>$1</h4>");
  text = text.replace(/^##\s+(.+)$/gm, "<h3>$1</h3>");
  text = text.replace(/^#\s+(.+)$/gm, "<h2>$1</h2>");

  // 5. Lists
  text = text.replace(/^[-*]\s+(.+)$/gm, "<li>$1</li>");
  text = text.replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>");

  // 6. Inline code
  text = text.replace(/`([^`]+)`/g, "<code>$1</code>");

  // 7. Newlines
  text = text.replace(/\n/g, "<br>");

  // 8. Restore code blocks
  for (const [id, html] of Object.entries(codePlaceholders)) {
    text = text.replace(id, html);
  }

  return text;
}

function copyCode(btn) {
  // Get the actual code text stored as button's text content (set during formatText)
  const codeEl = btn.closest(".code-wrapper").querySelector("code");
  const raw = codeEl ? codeEl.innerText : "";
  navigator.clipboard.writeText(raw).then(() => {
    btn.textContent = "‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
    btn.classList.add("copied");
    setTimeout(() => { btn.textContent = "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å"; btn.classList.remove("copied"); }, 2000);
  }).catch(() => {
    btn.textContent = "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å";
  });
}

function timeNow() {
  const d = new Date();
  return d.getHours().toString().padStart(2,"0") + ":" + d.getMinutes().toString().padStart(2,"0");
}

function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
}

// ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–∏–Ω–∏-–∞–ø–ø–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if (USER_ID) {
  fetch(`${API_BASE}/api/limits?uid=${USER_ID}`)
    .then(r => r.json())
    .then(d => {
      if (d.ok) {
        document.getElementById("limitBar").style.display = "flex";
        document.getElementById("fastLeft").textContent = d.fast_left;
        document.getElementById("proLeft").textContent  = d.pro_left;
      }
    })
    .catch(() => {});
}

// ‚îÄ‚îÄ tg theme ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
tg.onEvent("themeChanged", () => {});
</script>
</body>
</html>
