<!DOCTYPE html>

<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–•—É–∑–∞ –ò–ò</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --surface: #13131a;
  --surface2: #1c1c27;
  --surface3: #252535;
  --border: rgba(255,255,255,0.07);
  --border2: rgba(255,255,255,0.12);
  --text: #f0f0ff;
  --text2: rgba(240,240,255,0.55);
  --text3: rgba(240,240,255,0.3);
  --accent: #5b6ef5;
  --accent2: #7c8ff7;
  --accent-glow: rgba(91,110,245,0.25);
  --user-bubble: #1e2460;
  --user-border: rgba(91,110,245,0.4);
  --ai-bubble: #13131a;
  --green: #34d399;
  --red: #f87171;
  --yellow: #fbbf24;
}

- { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body {
font-family: ‚ÄòManrope‚Äô, sans-serif;
background: var(‚Äìbg);
color: var(‚Äìtext);
height: 100dvh;
display: flex;
flex-direction: column;
overflow: hidden;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
display: flex;
align-items: center;
padding: 10px 14px;
background: var(‚Äìsurface);
border-bottom: 1px solid var(‚Äìborder);
gap: 10px;
flex-shrink: 0;
z-index: 10;
}

.model-selector {
display: flex;
align-items: center;
gap: 8px;
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder2);
border-radius: 22px;
padding: 7px 14px 7px 10px;
cursor: pointer;
flex: 1;
transition: all 0.15s;
min-width: 0;
}
.model-selector:active { opacity: 0.8; transform: scale(0.98); }

.model-avatar {
width: 28px; height: 28px;
border-radius: 8px;
display: flex; align-items: center; justify-content: center;
font-size: 14px;
flex-shrink: 0;
}

.model-selector-info { flex: 1; min-width: 0; }
.model-selector-name {
font-size: 14px; font-weight: 700;
white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
color: var(‚Äìtext);
}
.model-selector-sub {
font-size: 10px; color: var(‚Äìtext2); margin-top: 1px;
}

.chevron { color: var(‚Äìtext3); font-size: 10px; flex-shrink: 0; }

.header-actions { display: flex; gap: 6px; flex-shrink: 0; }
.header-btn {
width: 36px; height: 36px;
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder);
border-radius: 12px;
display: flex; align-items: center; justify-content: center;
cursor: pointer; color: var(‚Äìtext2);
transition: all 0.15s;
font-size: 16px;
}
.header-btn:active { opacity: 0.7; transform: scale(0.95); }

/* ‚îÄ‚îÄ MODEL PICKER SHEET ‚îÄ‚îÄ */
.sheet-overlay {
position: fixed; inset: 0;
background: rgba(0,0,0,0.6);
z-index: 100;
opacity: 0; pointer-events: none;
transition: opacity 0.25s;
}
.sheet-overlay.open { opacity: 1; pointer-events: all; }

.sheet {
position: fixed; bottom: 0; left: 0; right: 0;
background: var(‚Äìsurface);
border-radius: 20px 20px 0 0;
z-index: 101;
max-height: 80dvh;
display: flex; flex-direction: column;
transform: translateY(100%);
transition: transform 0.3s cubic-bezier(0.32,0.72,0,1);
}
.sheet.open { transform: translateY(0); }

.sheet-handle {
width: 36px; height: 4px;
background: var(‚Äìborder2);
border-radius: 2px;
margin: 10px auto 0;
flex-shrink: 0;
}

.sheet-header {
padding: 14px 16px 10px;
flex-shrink: 0;
}
.sheet-title { font-size: 17px; font-weight: 800; }
.sheet-sub { font-size: 12px; color: var(‚Äìtext2); margin-top: 2px; }

.sheet-search {
padding: 0 16px 10px;
flex-shrink: 0;
}
.sheet-search input {
width: 100%;
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder);
border-radius: 12px;
padding: 9px 14px 9px 36px;
color: var(‚Äìtext);
font-family: ‚ÄòManrope‚Äô, sans-serif;
font-size: 14px;
outline: none;
}
.sheet-search input::placeholder { color: var(‚Äìtext3); }
.search-icon-wrap {
position: relative;
}
.search-icon-wrap svg {
position: absolute; left: 26px; top: 50%;
transform: translateY(-50%);
color: var(‚Äìtext3);
pointer-events: none;
}

.sheet-cats {
display: flex; gap: 6px;
padding: 0 16px 10px;
overflow-x: auto; scrollbar-width: none;
flex-shrink: 0;
}
.sheet-cats::-webkit-scrollbar { display: none; }

.cat-pill {
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder);
border-radius: 20px;
padding: 5px 12px;
font-size: 12px; font-weight: 600;
color: var(‚Äìtext2);
white-space: nowrap;
cursor: pointer;
transition: all 0.15s;
flex-shrink: 0;
}
.cat-pill.active {
background: var(‚Äìaccent);
border-color: var(‚Äìaccent);
color: #fff;
}

.sheet-list {
overflow-y: auto;
flex: 1;
padding-bottom: calc(env(safe-area-inset-bottom) + 10px);
}

.model-row {
display: flex; align-items: center;
padding: 11px 16px;
cursor: pointer;
transition: background 0.12s;
border-bottom: 1px solid var(‚Äìborder);
gap: 12px;
}
.model-row:active { background: rgba(255,255,255,0.04); }
.model-row.selected { background: rgba(91,110,245,0.1); }
.model-row.selected::before {
content: ‚Äò‚Äô; position: absolute; left: 0;
width: 3px; height: 100%;
background: var(‚Äìaccent);
border-radius: 0 2px 2px 0;
}
.model-row { position: relative; }

.row-avatar {
width: 44px; height: 44px;
border-radius: 13px;
display: flex; align-items: center; justify-content: center;
font-size: 20px;
flex-shrink: 0;
}

.row-info { flex: 1; min-width: 0; }
.row-name {
font-size: 15px; font-weight: 700;
white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.row-desc {
font-size: 12px; color: var(‚Äìtext2);
line-height: 1.4;
display: -webkit-box;
-webkit-line-clamp: 2; -webkit-box-orient: vertical;
overflow: hidden;
margin-top: 2px;
}
.row-right {
display: flex; flex-direction: column;
align-items: flex-end; gap: 5px;
flex-shrink: 0;
}
.check { width: 20px; height: 20px; border-radius: 50%; background: var(‚Äìaccent);
display: flex; align-items: center; justify-content: center;
opacity: 0; transform: scale(0.6); transition: all 0.2s;
}
.model-row.selected .check { opacity: 1; transform: scale(1); }
.vision-tag {
font-size: 9px; font-weight: 700;
background: rgba(251,191,36,0.15);
color: var(‚Äìyellow);
border: 1px solid rgba(251,191,36,0.3);
padding: 2px 6px; border-radius: 5px;
letter-spacing: 0.3px;
}
.section-label {
padding: 12px 16px 5px;
font-size: 10px; font-weight: 700;
color: var(‚Äìtext3);
letter-spacing: 1px;
text-transform: uppercase;
}

/* ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ */
.chat-area {
flex: 1;
overflow-y: auto;
padding: 12px 14px;
display: flex;
flex-direction: column;
gap: 10px;
scrollbar-width: thin;
scrollbar-color: var(‚Äìsurface3) transparent;
}

.empty-state {
flex: 1;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
gap: 16px;
padding: 20px;
text-align: center;
}
.empty-icon {
width: 64px; height: 64px;
border-radius: 20px;
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder2);
display: flex; align-items: center; justify-content: center;
font-size: 30px;
}
.empty-title { font-size: 20px; font-weight: 800; }
.empty-sub { font-size: 13px; color: var(‚Äìtext2); line-height: 1.5; }

.suggestions {
display: flex; gap: 8px;
overflow-x: auto; scrollbar-width: none;
padding-bottom: 2px;
width: 100%;
}
.suggestions::-webkit-scrollbar { display: none; }
.sugg-chip {
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder2);
border-radius: 14px;
padding: 10px 14px;
font-size: 12px; font-weight: 600;
color: var(‚Äìtext2);
white-space: nowrap;
cursor: pointer;
flex-shrink: 0;
max-width: 160px;
white-space: normal;
line-height: 1.3;
transition: all 0.15s;
}
.sugg-chip:active { background: var(‚Äìsurface3); }

/* Messages */
.msg { display: flex; flex-direction: column; max-width: 88%; animation: fadeUp 0.25s ease both; }
@keyframes fadeUp { from { opacity:0; transform: translateY(6px); } to { opacity:1; transform:none; } }

.msg.user { align-self: flex-end; }
.msg.ai   { align-self: flex-start; }

.bubble {
padding: 10px 14px;
border-radius: 18px;
font-size: 14px; line-height: 1.55;
word-break: break-word;
}
.msg.user .bubble {
background: var(‚Äìuser-bubble);
border: 1px solid var(‚Äìuser-border);
border-bottom-right-radius: 5px;
color: #e8ecff;
}
.msg.ai .bubble {
background: var(‚Äìai-bubble);
border: 1px solid var(‚Äìborder);
border-bottom-left-radius: 5px;
}

.msg-img {
max-width: 100%; border-radius: 12px;
margin-bottom: 6px;
border: 1px solid var(‚Äìborder);
}

.msg-meta {
font-size: 10px; color: var(‚Äìtext3);
margin-top: 3px;
padding: 0 4px;
}
.msg.user .msg-meta { text-align: right; }
.msg.ai   .msg-meta { text-align: left; }

/* AI label */
.ai-label {
display: flex; align-items: center; gap: 5px;
font-size: 10px; font-weight: 700;
color: var(‚Äìtext3);
margin-bottom: 4px;
padding: 0 2px;
}
.ai-dot {
width: 16px; height: 16px;
border-radius: 5px;
display: flex; align-items: center; justify-content: center;
font-size: 9px;
}

/* Typing indicator */
.typing-bubble {
display: flex; gap: 4px;
align-items: center;
padding: 12px 16px;
}
.typing-dot {
width: 7px; height: 7px;
border-radius: 50%;
background: var(‚Äìtext3);
animation: blink 1.2s ease infinite;
}
.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink {
0%,80%,100% { transform: scale(1); opacity: 0.5; }
40% { transform: scale(1.3); opacity: 1; }
}

/* code blocks */
.bubble pre {
background: #0d0d14;
border: 1px solid var(‚Äìborder2);
border-radius: 10px;
padding: 10px 12px;
overflow-x: auto;
margin: 8px 0;
font-size: 12px;
font-family: ‚ÄòSF Mono‚Äô, monospace;
line-height: 1.6;
}
.bubble code {
background: rgba(255,255,255,0.08);
padding: 1px 5px;
border-radius: 4px;
font-size: 12px;
font-family: ‚ÄòSF Mono‚Äô, monospace;
}
.bubble pre code { background: none; padding: 0; }
.bubble p { margin-bottom: 6px; }
.bubble p:last-child { margin-bottom: 0; }
.bubble strong { color: #fff; font-weight: 700; }

/* ‚îÄ‚îÄ INPUT BAR ‚îÄ‚îÄ */
.input-bar {
background: var(‚Äìsurface);
border-top: 1px solid var(‚Äìborder);
padding: 8px 10px;
padding-bottom: calc(8px + env(safe-area-inset-bottom));
flex-shrink: 0;
}

.input-row {
display: flex; align-items: flex-end; gap: 7px;
}

.attach-btn, .send-btn {
width: 40px; height: 40px;
border-radius: 13px;
border: none;
display: flex; align-items: center; justify-content: center;
cursor: pointer;
flex-shrink: 0;
transition: all 0.15s;
}
.attach-btn {
background: var(‚Äìsurface2);
color: var(‚Äìtext2);
font-size: 18px;
}
.attach-btn:active { opacity: 0.7; }

.send-btn {
background: var(‚Äìaccent);
color: #fff;
font-size: 17px;
}
.send-btn:active { transform: scale(0.92); }
.send-btn:disabled { background: var(‚Äìsurface3); color: var(‚Äìtext3); }

.input-wrap {
flex: 1;
background: var(‚Äìsurface2);
border: 1px solid var(‚Äìborder);
border-radius: 16px;
display: flex; align-items: flex-end;
padding: 8px 12px;
gap: 6px;
min-height: 40px;
transition: border-color 0.2s;
}
.input-wrap:focus-within { border-color: rgba(91,110,245,0.5); }

#msgInput {
flex: 1;
background: none;
border: none;
outline: none;
color: var(‚Äìtext);
font-family: ‚ÄòManrope‚Äô, sans-serif;
font-size: 14px;
line-height: 1.5;
resize: none;
max-height: 120px;
min-height: 20px;
}
#msgInput::placeholder { color: var(‚Äìtext3); }

/* image preview strip */
.img-preview {
display: flex; gap: 6px;
margin-bottom: 6px;
}
.preview-thumb {
position: relative;
width: 56px; height: 56px;
}
.preview-thumb img {
width: 56px; height: 56px;
border-radius: 10px;
object-fit: cover;
border: 1px solid var(‚Äìborder2);
}
.preview-rm {
position: absolute; top: -5px; right: -5px;
width: 18px; height: 18px;
border-radius: 50%;
background: var(‚Äìred);
color: #fff;
font-size: 11px;
display: flex; align-items: center; justify-content: center;
cursor: pointer;
border: 1.5px solid var(‚Äìbg);
}

/* vision hint bar */
.vision-hint {
background: rgba(251,191,36,0.08);
border: 1px solid rgba(251,191,36,0.2);
border-radius: 10px;
padding: 7px 12px;
font-size: 11px;
color: #fbbf24;
font-weight: 600;
margin-bottom: 6px;
display: flex; align-items: center; gap: 6px;
}

/* limit bar */
.limit-bar {
display: flex; gap: 8px; align-items: center;
padding: 6px 10px;
background: var(‚Äìsurface2);
border-radius: 10px;
margin-bottom: 6px;
font-size: 11px; color: var(‚Äìtext2);
}
.limit-item { display: flex; gap: 4px; align-items: center; }
.limit-dot { width: 6px; height: 6px; border-radius: 50%; }

/* file input hidden */
#fileInput { display: none; }

/* Avatar colors */
.av-claude  { background: linear-gradient(135deg,#d4845a,#c9512f); }
.av-gpt     { background: linear-gradient(135deg,#10a37f,#0a7a5f); }
.av-deepseek{ background: linear-gradient(135deg,#4e6ef2,#2a42c4); }
.av-qwen    { background: linear-gradient(135deg,#8b5cf6,#6d28d9); }
.av-llama   { background: linear-gradient(135deg,#f59e0b,#d97706); }
.av-command { background: linear-gradient(135deg,#6b7280,#374151); }
.av-kimi    { background: linear-gradient(135deg,#ec4899,#be185d); }
.av-glm     { background: linear-gradient(135deg,#a78bfa,#7c3aed); }
.av-c4ai    { background: linear-gradient(135deg,#06b6d4,#0891b2); }
.av-sonar   { background: linear-gradient(135deg,#f97316,#ea580c); }

/* toast */
.toast {
position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
background: var(‚Äìsurface3);
border: 1px solid var(‚Äìborder2);
border-radius: 12px;
padding: 8px 16px;
font-size: 13px; font-weight: 600;
opacity: 0;
transition: all 0.25s;
white-space: nowrap;
z-index: 200;
pointer-events: none;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>

</head>
<body>

<!-- HEADER -->

<div class="header">
  <div class="model-selector" id="modelSelector">
    <div class="model-avatar av-claude" id="hdrAvatar">üî∑</div>
    <div class="model-selector-info">
      <div class="model-selector-name" id="hdrName">Claude Sonnet 4.5</div>
      <div class="model-selector-sub" id="hdrSub">–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å</div>
    </div>
    <div class="chevron">‚ñº</div>
  </div>
  <div class="header-actions">
    <div class="header-btn" id="clearBtn" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">üóë</div>
  </div>
</div>

<!-- CHAT -->

<div class="chat-area" id="chatArea">
  <div class="empty-state" id="emptyState">
    <div class="empty-icon">ü§ñ</div>
    <div class="empty-title">–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
    <div class="empty-sub">–í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å –≤–≤–µ—Ä—Ö—É –∏ –Ω–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å ‚Äî –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Vision</div>
    <div class="suggestions" id="suggestions">
      <div class="sugg-chip">–û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</div>
      <div class="sugg-chip">–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–ø–∏—Å–∫–∞</div>
      <div class="sugg-chip">–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π</div>
      <div class="sugg-chip">–ü—Ä–∏–¥—É–º–∞–π –∏–¥–µ–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –≤ 2025</div>
    </div>
  </div>
</div>

<!-- INPUT -->

<div class="input-bar" id="inputBar">
  <div class="vision-hint" id="visionHint" style="display:none">
    üì∏ –≠—Ç–∞ –º–æ–¥–µ–ª—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ ‚Äî –Ω–∞–∂–º–∏ üìé —á—Ç–æ–±—ã –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å
  </div>
  <div class="img-preview" id="imgPreview" style="display:none"></div>
  <div class="limit-bar" id="limitBar" style="display:none">
    <span>üìä –ó–∞–ø—Ä–æ—Å—ã:</span>
    <span class="limit-item"><span class="limit-dot" style="background:#34d399"></span><span id="fastLeft">‚Äî</span> –±—ã—Å—Ç—Ä—ã—Ö</span>
    <span class="limit-item"><span class="limit-dot" style="background:#5b6ef5"></span><span id="proLeft">‚Äî</span> –ø—Ä–æ—Ñ.</span>
  </div>
  <div class="input-row">
    <button class="attach-btn" id="attachBtn">üìé</button>
    <div class="input-wrap">
      <textarea id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
    </div>
    <button class="send-btn" id="sendBtn" disabled>‚Üë</button>
  </div>
</div>

<!-- MODEL SHEET -->

<div class="sheet-overlay" id="sheetOverlay"></div>
<div class="sheet" id="sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">–í—ã–±–æ—Ä –Ω–µ–π—Ä–æ—Å–µ—Ç–∏</div>
    <div class="sheet-sub">–í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å –¥–ª—è –æ–±—â–µ–Ω–∏—è</div>
  </div>
  <div class="sheet-search">
    <div class="search-icon-wrap">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
      </svg>
      <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –º–æ–¥–µ–ª–∏...">
    </div>
  </div>
  <div class="sheet-cats" id="sheetCats"></div>
  <div class="sheet-list" id="sheetList"></div>
</div>

<input type="file" id="fileInput" accept="image/*">
<div class="toast" id="toast"></div>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// ‚îÄ‚îÄ –ú–æ–¥–µ–ª–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MODELS = [
  { key:"claude_sonnet", name:"Claude Sonnet 4.5", emoji:"üî∑", av:"av-claude", cat:"Claude", desc:"–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å ‚Äî —É–º–Ω–∞—è, –±—ã—Å—Ç—Ä–∞—è, –¥–µ—Ç–∞–ª—å–Ω–∞—è" },
  { key:"claude_haiku",  name:"Claude Haiku 4.5",  emoji:"üíé", av:"av-claude", cat:"Claude", desc:"–°–∞–º–∞—è –±—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è Claude" },
  { key:"claude_opus",   name:"Claude Opus 4.5",   emoji:"üîµ", av:"av-claude", cat:"Claude", desc:"–¢–æ–ø–æ–≤–∞—è –º–æ–¥–µ–ª—å Anthropic ‚Äî –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑" },
  { key:"gpt52",         name:"GPT-5.2",           emoji:"‚ö°", av:"av-gpt",    cat:"GPT",    desc:"–ù–æ–≤–µ–π—à–∞—è –º–æ–¥–µ–ª—å –æ—Ç OpenAI" },
  { key:"gpt52_chat",    name:"GPT-5.2 Chat",      emoji:"üí¨", av:"av-gpt",    cat:"GPT",    desc:"GPT-5.2 –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤" },
  { key:"deepseek_v3",   name:"DeepSeek V3.2",     emoji:"üß¨", av:"av-deepseek",cat:"DeepSeek",desc:"–£–º–Ω–µ–π—à–∞—è –∫–∏—Ç–∞–π—Å–∫–∞—è –º–æ–¥–µ–ª—å ‚Äî –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç OpenAI o1" },
  { key:"deepseek_r1",   name:"DeepSeek R1",       emoji:"üß†", av:"av-deepseek",cat:"DeepSeek",desc:"Reasoning-–º–æ–¥–µ–ª—å —Å —Ü–µ–ø–æ—á–∫–æ–π —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π" },
  { key:"deepseek_v3_sq",name:"DeepSeek V3",       emoji:"üß¨", av:"av-deepseek",cat:"DeepSeek",desc:"–°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è DeepSeek V3" },
  { key:"qwen3_max",     name:"Qwen3-Max",         emoji:"üåê", av:"av-qwen",   cat:"Qwen",   desc:"–§–ª–∞–≥–º–∞–Ω—Å–∫–∞—è –º–æ–¥–µ–ª—å Alibaba ‚Äî –º–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è" },
  { key:"qwen3_vl",      name:"Qwen3-VL",          emoji:"üëÅÔ∏è", av:"av-qwen",   cat:"Qwen",   desc:"Vision –º–æ–¥–µ–ª—å ‚Äî –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è üì∏", vision:true },
  { key:"qwen_vision",   name:"Qwen2.5-VL 32B",    emoji:"üñºÔ∏è", av:"av-qwen",   cat:"Qwen",   desc:"–ú–æ—â–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ üì∏", vision:true },
  { key:"llama32_90b",   name:"Llama 3.2 90B",     emoji:"ü¶ô", av:"av-llama",  cat:"Llama",  desc:"Open-source –≥–∏–≥–∞–Ω—Ç –æ—Ç Meta ‚Äî Vision üì∏", vision:true },
  { key:"command_a",     name:"Command-A",         emoji:"‚öôÔ∏è", av:"av-command",cat:"Command", desc:"–ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å –æ—Ç Cohere" },
  { key:"command_vision",name:"Command Vision",    emoji:"üëÅÔ∏è", av:"av-command",cat:"Command", desc:"Command —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π üì∏", vision:true },
  { key:"command_reason",name:"Command Reasoning", emoji:"üß©", av:"av-command",cat:"Command", desc:"–£–≥–ª—É–±–ª—ë–Ω–Ω–æ–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á" },
  { key:"moonshot",      name:"Kimi K2",           emoji:"üåô", av:"av-kimi",   cat:"Kimi",   desc:"–ú–æ–¥–µ–ª—å –æ—Ç Moonshot AI ‚Äî –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º—ã—à–ª–µ–Ω–∏–µ" },
  { key:"glm47",         name:"GLM-4.7",           emoji:"üîÆ", av:"av-glm",    cat:"GLM",    desc:"–ù–æ–≤–µ–π—à–∞—è –≤–µ—Ä—Å–∏—è GLM —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–µ–º" },
  { key:"glm46",         name:"GLM-4.6",           emoji:"üîÆ", av:"av-glm",    cat:"GLM",    desc:"–°—Ç–∞–±–∏–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å GLM-4.6" },
  { key:"c4ai_32b",      name:"C4AI Aya 32B",      emoji:"üåÄ", av:"av-c4ai",   cat:"C4AI",   desc:"–ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–∞—è –º–æ–¥–µ–ª—å ‚Äî 32B –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, 23 —è–∑—ã–∫–∞" },
  { key:"c4ai_8b",       name:"C4AI Aya 8B",       emoji:"üåÄ", av:"av-c4ai",   cat:"C4AI",   desc:"–õ—ë–≥–∫–∞—è –∏ –±—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è Aya ‚Äî 8B –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤" },
  { key:"c4ai_vis32b",   name:"C4AI Vision 32B",   emoji:"üåÄ", av:"av-c4ai",   cat:"C4AI",   desc:"Vision –≤–µ—Ä—Å–∏—è Aya 32B ‚Äî –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π üì∏", vision:true },
  { key:"c4ai_vis8b",    name:"C4AI Vision 8B",    emoji:"üåÄ", av:"av-c4ai",   cat:"C4AI",   desc:"–ë—ã—Å—Ç—Ä–∞—è Vision –≤–µ—Ä—Å–∏—è Aya 8B üì∏", vision:true },
  { key:"sonar",         name:"Sonar",             emoji:"üîç", av:"av-sonar",  cat:"Sonar",  desc:"Perplexity Sonar ‚Äî –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ + –ò–ò" },
  { key:"sonar_pro",     name:"Sonar Pro",         emoji:"üîç", av:"av-sonar",  cat:"Sonar",  desc:"–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –≥–ª—É–±–æ–∫–∏–º –ø–æ–∏—Å–∫–æ–º" },
];

const CATS = ["–í—Å–µ", "Claude", "GPT", "DeepSeek", "Qwen", "Llama", "Command", "Kimi", "GLM", "C4AI", "Sonar"];

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const params = new URLSearchParams(location.search);
let curModel  = params.get("model") || "claude_sonnet";
let sheetOpen = false;
let catFilter = "–í—Å–µ";
let searchQ   = "";
let pendingImgs = []; // [{file, b64, url}]
let messages  = [];   // [{role, content, imgUrl?}]
let isLoading = false;

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
updateHeader();
renderCats();
renderModels();

// Load limits from URL
const fl = params.get("fast_left"), pl = params.get("pro_left");
if (fl !== null || pl !== null) {
  document.getElementById("limitBar").style.display = "flex";
  document.getElementById("fastLeft").textContent = fl ?? "‚Äî";
  document.getElementById("proLeft").textContent  = pl ?? "‚Äî";
}

// ‚îÄ‚îÄ Suggestion chips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll(".sugg-chip").forEach(chip => {
  chip.addEventListener("click", () => {
    const input = document.getElementById("msgInput");
    input.value = chip.textContent.trim();
    input.dispatchEvent(new Event("input"));
    input.focus();
  });
});

// ‚îÄ‚îÄ Header model ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getModel(key) {
  return MODELS.find(m => m.key === key) || MODELS[0];
}
function updateHeader() {
  const m = getModel(curModel);
  document.getElementById("hdrAvatar").className = `model-avatar ${m.av}`;
  document.getElementById("hdrAvatar").textContent = m.emoji;
  document.getElementById("hdrName").textContent = m.name;
  document.getElementById("hdrSub").textContent  = m.vision ? "üì∏ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ç–æ" : "–ù–∞–∂–º–∏ —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å";
  // vision hint in input
  const vh = document.getElementById("visionHint");
  vh.style.display = m.vision ? "flex" : "none";
}

// ‚îÄ‚îÄ Sheet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("modelSelector").addEventListener("click", openSheet);
document.getElementById("sheetOverlay").addEventListener("click", closeSheet);

function openSheet() {
  sheetOpen = true;
  document.getElementById("sheetOverlay").classList.add("open");
  document.getElementById("sheet").classList.add("open");
  document.getElementById("searchInput").value = "";
  searchQ = ""; catFilter = "–í—Å–µ";
  renderCats(); renderModels();
}
function closeSheet() {
  sheetOpen = false;
  document.getElementById("sheetOverlay").classList.remove("open");
  document.getElementById("sheet").classList.remove("open");
}

function renderCats() {
  const wrap = document.getElementById("sheetCats");
  wrap.innerHTML = CATS.map(c =>
    `<div class="cat-pill${c===catFilter?" active":""}" onclick="setCat('${c}')">${c}</div>`
  ).join("");
}
function setCat(c) { catFilter = c; renderCats(); renderModels(); }

document.getElementById("searchInput").addEventListener("input", e => {
  searchQ = e.target.value.toLowerCase();
  if (searchQ) catFilter = "–í—Å–µ";
  renderCats(); renderModels();
});

function renderModels() {
  const list = document.getElementById("sheetList");
  let filtered = MODELS.filter(m => {
    const matchCat = catFilter === "–í—Å–µ" || m.cat === catFilter;
    const matchQ   = !searchQ || m.name.toLowerCase().includes(searchQ) || m.desc.toLowerCase().includes(searchQ);
    return matchCat && matchQ;
  });

  if (!filtered.length) {
    list.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text3)">üòî –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>`;
    return;
  }

  let html = "";
  let lastCat = null;
  filtered.forEach(m => {
    if (catFilter === "–í—Å–µ" && !searchQ && m.cat !== lastCat) {
      html += `<div class="section-label">${m.cat}</div>`;
      lastCat = m.cat;
    }
    const sel = m.key === curModel;
    html += `
      <div class="model-row${sel?" selected":""}" onclick="selectModel('${m.key}')">
        <div class="row-avatar ${m.av}">${m.emoji}</div>
        <div class="row-info">
          <div class="row-name">${m.name}</div>
          <div class="row-desc">${m.desc}</div>
        </div>
        <div class="row-right">
          <div class="check"><svg width="10" height="10" viewBox="0 0 12 12"><path d="M2 6l3 3 5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg></div>
          ${m.vision ? '<span class="vision-tag">üì∏ VISION</span>' : ''}
        </div>
      </div>`;
  });
  list.innerHTML = html;
}

function selectModel(key) {
  if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
  curModel = key;
  updateHeader();
  renderModels();
  closeSheet();
  // Notify bot about model change
  try {
    tg.sendData(JSON.stringify({ action: "set_model", model: key }));
  } catch(e) {
    // Mini app not opened via KeyboardButton ‚Äî just update UI
  }
  showToast(`‚úÖ ${getModel(key).name}`);
}

// ‚îÄ‚îÄ Clear chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("clearBtn").addEventListener("click", () => {
  if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred("light");
  messages = [];
  pendingImgs = [];
  renderImgPreview();
  const area = document.getElementById("chatArea");
  area.innerHTML = document.querySelector(".empty-state") ? "" : "";
  // Re-create empty state
  area.innerHTML = `
    <div class="empty-state" id="emptyState">
      <div class="empty-icon">ü§ñ</div>
      <div class="empty-title">–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?</div>
      <div class="empty-sub">–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏ —Ñ–æ—Ç–æ</div>
      <div class="suggestions" id="suggestions">
        <div class="sugg-chip">–û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</div>
        <div class="sugg-chip">–ù–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Å–ø–∏—Å–∫–∞</div>
        <div class="sugg-chip">–ü–µ—Ä–µ–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π</div>
        <div class="sugg-chip">–ü—Ä–∏–¥—É–º–∞–π –∏–¥–µ–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –≤ 2025</div>
      </div>
    </div>`;
  document.querySelectorAll(".sugg-chip").forEach(chip => {
    chip.addEventListener("click", () => {
      const input = document.getElementById("msgInput");
      input.value = chip.textContent.trim();
      input.dispatchEvent(new Event("input"));
      input.focus();
    });
  });
  showToast("üóë –ß–∞—Ç –æ—á–∏—â–µ–Ω");
});

// ‚îÄ‚îÄ Input ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const msgInput = document.getElementById("msgInput");
msgInput.addEventListener("input", () => {
  msgInput.style.height = "auto";
  msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + "px";
  updateSendBtn();
});
msgInput.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

function updateSendBtn() {
  const hasText = msgInput.value.trim().length > 0;
  const hasImg  = pendingImgs.length > 0;
  document.getElementById("sendBtn").disabled = (!hasText && !hasImg) || isLoading;
}

// ‚îÄ‚îÄ File attach ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("attachBtn").addEventListener("click", () => {
  const m = getModel(curModel);
  if (!m.vision) {
    showToast("‚ö†Ô∏è –≠—Ç–∞ –º–æ–¥–µ–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ");
    return;
  }
  document.getElementById("fileInput").click();
});

document.getElementById("fileInput").addEventListener("change", e => {
  const files = Array.from(e.target.files || []);
  files.forEach(file => {
    if (!file.type.startsWith("image/")) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const b64full = ev.target.result; // data:image/jpeg;base64,...
      const b64 = b64full.split(",")[1];
      pendingImgs.push({ file, b64, url: b64full });
      renderImgPreview();
      updateSendBtn();
    };
    reader.readAsDataURL(file);
  });
  e.target.value = "";
});

function renderImgPreview() {
  const wrap = document.getElementById("imgPreview");
  if (!pendingImgs.length) { wrap.style.display = "none"; wrap.innerHTML = ""; return; }
  wrap.style.display = "flex";
  wrap.innerHTML = pendingImgs.map((img, i) => `
    <div class="preview-thumb">
      <img src="${img.url}" alt="—Ñ–æ—Ç–æ">
      <div class="preview-rm" onclick="removeImg(${i})">√ó</div>
    </div>`).join("");
}
function removeImg(i) {
  pendingImgs.splice(i, 1);
  renderImgPreview();
  updateSendBtn();
}

// ‚îÄ‚îÄ Send ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("sendBtn").addEventListener("click", sendMessage);

function sendMessage() {
  if (isLoading) return;
  const text = msgInput.value.trim();
  const imgs  = [...pendingImgs];
  if (!text && !imgs.length) return;

  hideEmpty();
  isLoading = true;
  updateSendBtn();

  // Add user message to UI
  const imgUrls = imgs.map(i => i.url);
  addUserMsg(text, imgUrls);

  // Clear input
  msgInput.value = "";
  msgInput.style.height = "auto";
  pendingImgs = [];
  renderImgPreview();

  // Add typing indicator
  const typingId = addTyping();

  // Build history for bot
  const historyForBot = messages.slice(-10).map(m => ({
    role: m.role,
    content: m.content
  }));

  // Send to bot via sendData
  const payload = {
    action: "chat",
    model:  curModel,
    text:   text || "",
    images: imgs.map(i => i.b64),
    history: historyForBot
  };

  // Store user message in history
  messages.push({ role: "user", content: text || (imgs.length ? "[–§–æ—Ç–æ]" : ""), imgUrls });

  try {
    tg.sendData(JSON.stringify(payload));
    // Bot will respond via new message ‚Äî remove typing after 30s timeout
    setTimeout(() => {
      removeTyping(typingId);
      isLoading = false;
      updateSendBtn();
    }, 30000);
  } catch(e) {
    // sendData not available (opened via inline) ‚Äî show error
    removeTyping(typingId);
    addAiMsg("‚ö†Ô∏è –î–ª—è —Ä–∞–±–æ—Ç—ã —á–∞—Ç–∞ –æ—Ç–∫—Ä–æ–π –±–æ—Ç–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –º–µ–Ω—é (reply keyboard), –∞ –Ω–µ —á–µ—Ä–µ–∑ inline –∫–Ω–æ–ø–∫—É.\n\n–ò–ª–∏ –Ω–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –Ω–∞–ø—Ä—è–º—É—é –≤ —á–∞—Ç –±–æ—Ç–∞ ‚Äî –æ–Ω –æ—Ç–≤–µ—Ç–∏—Ç —Ç–∞–º.");
    isLoading = false;
    updateSendBtn();
  }
}

// ‚îÄ‚îÄ Receive answer from bot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Bot sends answer back through a special event (if using MainButton / back channel)
// In practice: bot sends message after receiving sendData, mini app should be closed
// For demo ‚Äî handle tg.onEvent for message receiving
tg.onEvent("mainButtonClicked", () => {});

// If bot sends answer back via web_app_data echo (not standard)
// Standard flow: user sends ‚Üí mini app closes / stays ‚Üí bot responds in chat
// For inline chat experience we need a polling approach or websocket
// Here we implement a "local demo" fallback when sendData fails

// ‚îÄ‚îÄ DOM helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function hideEmpty() {
  const e = document.getElementById("emptyState");
  if (e) e.remove();
}

function addUserMsg(text, imgUrls) {
  const area = document.getElementById("chatArea");
  const div = document.createElement("div");
  div.className = "msg user";
  let imgsHtml = imgUrls.map(u => `<img class="msg-img" src="${u}" alt="—Ñ–æ—Ç–æ">`).join("");
  div.innerHTML = `
    ${imgsHtml}
    ${text ? `<div class="bubble">${escHtml(text)}</div>` : ""}
    <div class="msg-meta">–í—ã ¬∑ ${timeNow()}</div>`;
  area.appendChild(div);
  scrollBottom();
}

function addAiMsg(text) {
  const area = document.getElementById("chatArea");
  const m = getModel(curModel);
  const div = document.createElement("div");
  div.className = "msg ai";
  div.innerHTML = `
    <div class="ai-label">
      <div class="ai-dot ${m.av}">${m.emoji}</div>
      ${m.name}
    </div>
    <div class="bubble">${formatText(text)}</div>
    <div class="msg-meta">${m.name} ¬∑ ${timeNow()}</div>`;
  area.appendChild(div);
  messages.push({ role: "assistant", content: text });
  scrollBottom();
}

let typingCounter = 0;
function addTyping() {
  const id = ++typingCounter;
  const area = document.getElementById("chatArea");
  const m = getModel(curModel);
  const div = document.createElement("div");
  div.className = "msg ai";
  div.id = `typing-${id}`;
  div.innerHTML = `
    <div class="ai-label">
      <div class="ai-dot ${m.av}">${m.emoji}</div>
      ${m.name}
    </div>
    <div class="bubble">
      <div class="typing-bubble">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>
    </div>`;
  area.appendChild(div);
  scrollBottom();
  return id;
}

function removeTyping(id) {
  const el = document.getElementById(`typing-${id}`);
  if (el) el.remove();
}

function scrollBottom() {
  const area = document.getElementById("chatArea");
  area.scrollTop = area.scrollHeight;
}

function escHtml(s) {
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");
}

function formatText(text) {
  // code blocks
  text = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) =>
    `<pre><code>${escHtml(code.trim())}</code></pre>`);

// inline code
text = text.replace(/`([^`]+)`/g, ‚Äú<code>$1</code>‚Äù);
// bold
text = text.replace(/**(.+?)**/g, ‚Äú<strong>$1</strong>‚Äù);
// newlines
text = text.replace(/\n/g, ‚Äú<br>‚Äù);
return text;
}

function timeNow() {
const d = new Date();
return d.getHours().toString().padStart(2,‚Äú0‚Äù) + ‚Äú:‚Äù + d.getMinutes().toString().padStart(2,‚Äú0‚Äù);
}

function showToast(msg) {
const t = document.getElementById(‚Äútoast‚Äù);
t.textContent = msg;
t.classList.add(‚Äúshow‚Äù);
setTimeout(() => t.classList.remove(‚Äúshow‚Äù), 2000);
}

// ‚îÄ‚îÄ Handle incoming data from bot (tg.initDataUnsafe / URL) ‚îÄ‚îÄ‚îÄ
// When bot sends answer back ‚Äî it re-opens mini app with answer in URL params
const answerParam = params.get(‚Äúanswer‚Äù);
if (answerParam) {
hideEmpty();
const q = params.get(‚Äúq‚Äù) || ‚Äú‚Äù;
if (q) addUserMsg(decodeURIComponent(q), []);
addAiMsg(decodeURIComponent(answerParam));
}

// ‚îÄ‚îÄ tg theme ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
tg.onEvent(‚ÄúthemeChanged‚Äù, () => {});
</script>

</body>
</html>
